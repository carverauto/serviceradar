# ServiceRadar Zero-Touch Edge Onboarding Plan

## Background

The current bootstrap story assumes every runtime already has the correct JSON configuration on disk (frequently delivered by ConfigMaps or baked images) before it can discover the KV, Proton, and security endpoints. That approach breaks down for large fleets and bare-metal installs because:

- Agents and checkers cannot self-register without first knowing where KV or Core live.
- mTLS material has to be pre-provisioned and rotated manually.
- Admins have no centralized workflow to review and approve newly deployed endpoints.
- SPIFFE/SPIRE integration is still aspirational, so we fall back to static PEMs.

As a result, the demo cluster still hydrates configs from files, Core crashes when Proton DNS is unavailable during install, and we can’t offer “drop a binary + point at Core” simplicity to customers.

## Goals

- **Zero/low-touch onboarding** for agents, sysmon, pollers, and future edge services.
- **Secure discovery** channel that works without pre-shared mTLS, but can escalate to SPIFFE/SPIRE once running.
- **Scales to thousands** of endpoints rolling out via automation tools (Ansible, Fleet, SCCM, etc.).
- **Admin approval flow** in the web UI to accept/reject new registrations (individually or in bulk).
- **Progressive hardening**: start with HTTPS + bootstrap key, graduate to full SPIFFE-issued mTLS.

## Proposed Architecture Overview

1. **Bootstrap Registration Service** (part of Core HTTP API) that exposes:
   - `/v1/onboard/register` for agents to announce themselves using a bootstrap credential.
   - `/v1/onboard/claim` for admins to accept and assign configuration profiles.
2. **Bootstrap Credentials**:
   - Option A: Pre-shared enrollment key (per tenant) scoped to service type.
   - Option B: Signed JWT (short-lived) generated by admin tooling (CLI, web).
   - Option C: SPIFFE/SPIRE attestation (workload presents SVID to prove origin).
3. **Device Identity Seed**:
   - Deterministic ID (e.g., SHA256(hostname + serial) or BIOS UUID).
   - Include optional metadata (tags, environment, automation job ID).
4. **Post-Registration Flow**:
   - Core stores pending registrations in KV/database.
   - Admin UI lists pending devices; approval assigns config templates (checker bundles, KV addresses, cert profiles).
   - Approved devices receive a token/certificate bundle to fetch config over mTLS (KV or direct API).
5. **SPIFFE/SPIRE Integration**:
   - Deploy SPIRE server with the Core stack (K8s + bare-metal scripts).
   - Deliver SPIRE agent binaries alongside agent/sysmon.
   - Enrollment maps host facts (e.g., MAC, cloud metadata, TPM attestation) to SPIFFE IDs.

## Detailed Workflow

1. **Pre-deployment**:
   - Admin generates a bootstrap package (`serviceradar-cli enrollment pack`) containing:
     - Enrollment key / JWT template.
     - Core HTTPS endpoint.
     - Optional SPIRE bootstrap bundle.
   - Package distributed with automation tool.
2. **Agent First Boot**:
   - Reads minimal config (endpoint URL, enrollment token).
   - Calls Core onboarding API over TLS (no client cert yet).
   - Submits identity: service type, hostname, hardware fingerprint, SPIFFE attestation if available.
3. **Core Validation**:
   - Verifies bootstrap token validity and anti-replay counter.
   - Optionally verifies SPIFFE bundle signature.
   - Creates onboarding record (status `pending`) with metadata.
   - Emits audit log and optional notification.
4. **Admin Approval**:
   - Web UI lists pending endpoints with metadata and suggested configuration profiles.
   - Admin can approve individually or bulk-apply template (e.g., “sysmon-linux-default”).
   - Upon approval, Core issues:
     - Initial config payload (KV namespace, TLS mode, poll interval, etc.).
     - Short-lived bootstrap certificate or SPIFFE trust bundle instructions.
5. **Device Activation**:
   - Agent receives signed response, writes config, switches to mTLS or SPIFFE channel.
   - Agent re-contacts Core/KV using new credentials.
   - Core marks device as `active` and exposes telemetry in UI.

## SPIFFE/SPIRE Deployment Considerations

- **Server-side**:
  - Run SPIRE Server alongside Core (K8s StatefulSet, bare-metal systemd).
  - Integrate SPIRE issuer with Core so approvals trigger SPIFFE entry creation.
  - Manage trust domain (e.g., `spiffe://serviceradar.local/agent/<id>`).
- **Client-side**:
  - Bundle SPIRE Agent with agent/sysmon packages.
  - Provide install scripts (`serviceradar-cli install-spire --role agent`) for Linux/Windows.
  - Agents run SPIRE workload API to fetch SVIDs and rotate certs automatically.
- **Operational**:
  - Document expectations: port requirements, need for root/admin, log/debug tools.
  - Provide fallback for environments where SPIRE isn’t feasible (stay on mTLS PEMs).

## Configuration Distribution Strategy

- **KV Real-time Updates**:
  - Once enrolled, devices subscribe to KV keys tied to their assigned profile (`config/agents/<id>.json`).
  - Core ensures initial seed is written as part of approval.
- **Templates**:
  - Define reusable templates (YAML/JSON) for agent types (sysmon, k8s-agent, poller).
  - Admin selects template during approval; CLI supports `serviceradar-cli onboarding template assign`.
- **Bootstrap Fallback**:
  - Minimal on-disk config only needs safe defaults: HTTPS URL + bootstrap token.
  - Agents log clearly when waiting for approval.

## Fleet Deployment Automation

- Provide Ansible/Terraform modules that:
  - Install SPIRE agent (optional).
  - Drop bootstrap package.
  - Start serviceradar-agent/sysmon service.
  - Report success/fail metrics back to automation.
- Publish “golden image” guidance (VM templates, container images) with onboarding baked in.

## Open Questions & Risks

- How to prevent enrollment key leakage when distributing to thousands of hosts?
  - Rotate frequently; scope per automation batch; require SPIFFE attestation for high-trust environments.
- What is the rollback path if SPIRE server is unavailable?
  - Agents should keep last-known certs and degrade gracefully.
- Should approvals be mandatory, or can admins allow auto-approval for certain templates?
  - Maybe expose policy rules (`auto-approve sysmon in site=lab`).
- Handling transient DNS/network failures during install (Core currently crashes if Proton DNS fails).
  - Improve retry/backoff in init scripts; decouple migrations from boot.

## Next Steps

1. Draft API design for onboarding endpoints and admin UI wireframes.
2. Prototype CLI command to generate/bootstrap enrollment packages.
3. Build PoC SPIRE deployment (K8s + bare metal) with automated agent registration.
4. Define configuration template schema and KV layout.
5. Update demo environment to showcase pending approvals flow.
6. Revisit recent KV bootstrap changes; plan rollback or refactor to align with this onboarding model.

---

_Document owner: serviceradar-52 (GH-1861). Update this plan as we iterate on the onboarding design._
