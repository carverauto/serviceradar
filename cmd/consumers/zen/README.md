# serviceradar-zen

`serviceradar-zen` listens to a JetStream consumer and evaluates each message using the [gorules/zen](https://github.com/gorules/zen) decision engine.

## Configuration

Create a JSON file with the following fields:

```json
{
  "nats_url": "nats://127.0.0.1:4222",
  "domain": "edge",
  "stream_name": "events",
  "consumer_name": "zen-consumer",
  "subjects": ["events.syslog", "events.snmp"],
  "decision_groups": [
    {
      "name": "syslog",
      "subjects": ["events.syslog"],
      "rules": [
        {"order": 1, "key": "strip_full_message"},
        {"order": 2, "key": "cef_severity"}
      ]
    },
    {
      "name": "snmp",
      "subjects": ["events.snmp"],
      "rules": [
        {"order": 1, "key": "cef_severity"}
      ]
    }
  ],
  "agent_id": "agent-01",
  "kv_bucket": "serviceradar-datasvc",
  "listen_addr": "0.0.0.0:50055",
  "result_subject_suffix": ".processed"
}
```

`decision_groups` allows rules to be organized into named groups.
Each group can specify a list of `subjects` it applies to. When a message
arrives, the first group matching its subject is selected and its rules are
processed sequentially, with the output of one rule becoming the input for the
next.

If a rule is missing from the key-value bucket it will be skipped and the
consumer will continue evaluating the remaining keys.

Decision rules are loaded from the KV store using the following key pattern:

```
agents/<agent-id>/<stream-name>/<subject>/<decision_key>.json
```

Ensure the subjects generated by `result_subject_suffix` are part of a
JetStream stream so processed results are persisted. For example, if your
incoming subject is `events.syslog` and the suffix is `.processed`, make sure
`events.syslog.processed` is included in the stream before running the consumer.

The `listen_addr` field configures a gRPC server exposing a health check via
`monitoring.AgentService`.

Optionally add TLS settings:

```json
{
  "nats_url": "nats://127.0.0.1:4222",
  "domain": "edge",
  "stream_name": "events",
  "consumer_name": "zen-consumer",
  "subjects": ["events.syslog", "events.snmp"],
  "decision_groups": [
    {
      "name": "syslog",
      "subjects": ["events.syslog"],
      "rules": [
        {"order": 1, "key": "strip_full_message"},
        {"order": 2, "key": "cef_severity"}
      ]
    },
    {
      "name": "snmp",
      "subjects": ["events.snmp"],
      "rules": [
        {"order": 1, "key": "cef_severity"}
      ]
    }
  ],
  "agent_id": "agent-01",
  "kv_bucket": "serviceradar-datasvc",
  "listen_addr": "0.0.0.0:50055",
  "result_subject_suffix": ".processed",
  "security": {
    "cert_file": "/etc/serviceradar/certs/zen-consumer.pem",
    "key_file": "/etc/serviceradar/certs/zen-consumer-key.pem",
    "ca_file": "/etc/serviceradar/certs/root.pem"
  },
  "grpc_security": {
    "cert_file": "/etc/serviceradar/certs/server.pem",
    "key_file": "/etc/serviceradar/certs/server-key.pem",
    "ca_file": "/etc/serviceradar/certs/root.pem"
  }
}
```

## Building and Running

```bash
cargo build --release -p serviceradar-zen
./target/release/serviceradar-zen --config zen-consumer.json
```
