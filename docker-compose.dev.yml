services:
  # Certificate Generation Service (runs once to generate mTLS certs)
  cert-generator:
    image: alpine:latest
    command: ["/bin/sh", "-c", "apk add --no-cache openssl && /bin/sh /entrypoint-certs.sh"]
    container_name: serviceradar-cert-generator
    volumes:
      - cert-data:/certs
      - ./docker/compose/entrypoint-certs.sh:/entrypoint-certs.sh:ro
    restart: "no"  # Only run once
    networks:
      - serviceradar-net

  # Proton (TimeBase) Database with custom configuration
  proton:
    build:
      context: .
      dockerfile: docker/compose/Dockerfile.proton
    container_name: serviceradar-proton
    ports:
      - "8123:8123"  # HTTP port for JDBC driver, batch mode
      - "8463:8463"  # Native TCP port
      - "8443:8443"  # HTTPS port (with TLS)
      - "9440:9440"  # Native TCP secure port (with TLS)
    volumes:
      - proton-data:/var/lib/proton
      - cert-data:/etc/serviceradar/certs:ro
      - cert-data:/etc/proton-server/certs:ro
    environment:
      - PROTON_PASSWORD=${PROTON_PASSWORD:-}  # Will generate if not set
      - PROTON_LOG_LEVEL=${PROTON_LOG_LEVEL:-error}
    ulimits:
      nofile:
        soft: 1048576
        hard: 1048576
      nproc:
        soft: 65535
        hard: 65535
    # sysctls disabled for Docker Desktop compatibility
    # In production Linux environments, you can enable these:
    # sysctls:
    #   - kernel.threads-max=100000  
    #   - kernel.pid_max=100000
    #   - vm.nr_hugepages=0
    cap_add:
      - NET_ADMIN
      - IPC_LOCK
      - SYS_NICE
    healthcheck:
      test: ["CMD", "proton-client", "--host", "localhost", "--port", "8463", "--query", "SELECT 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      cert-generator:
        condition: service_completed_successfully
    networks:
      serviceradar-net:
        ipv4_address: 172.28.0.2
    restart: unless-stopped

  # ServiceRadar Core Service
  core:
    build:
      context: .
      dockerfile: docker/compose/Dockerfile.core
      args:
        VERSION: ${VERSION:-dev}
        BUILD_ID: ${BUILD_ID:-docker}
    container_name: serviceradar-core
    ports:
      - "8090:8090"  # HTTP API
      - "50052:50052"  # gRPC (matching core.json)
      - "9090:9090"  # Metrics (Prometheus)
    volumes:
      # Mount the actual config files from packaging
      # Using core.docker.json which has the correct Proton connection details for Docker
      - ./packaging/core/config/core.docker.json:/etc/serviceradar/core.json:ro
      - ./packaging/core/config/api.env:/etc/serviceradar/api.env:ro
      - cert-data:/etc/serviceradar/certs:ro
      - core-data:/var/lib/serviceradar
      - ./logs:/var/log/serviceradar
    environment:
      # Wait for dependencies
      - WAIT_FOR_PROTON=true
      - INIT_DB=true
      
      # Database password (will be set by init script)
      - PROTON_PASSWORD=${PROTON_PASSWORD:-}
      
      # Override api.env values if needed
      - API_KEY=${API_KEY:-changeme}
      - JWT_SECRET=${JWT_SECRET:-changeme}
      - AUTH_ENABLED=${AUTH_ENABLED:-true}
      
      # Config source
      - CONFIG_SOURCE=${CONFIG_SOURCE:-file}
      - CONFIG_PATH=/etc/serviceradar/core.json
    depends_on:
      cert-generator:
        condition: service_completed_successfully
      proton:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      serviceradar-net:
        ipv4_address: 172.28.0.3
    restart: unless-stopped

  # Optional: Redpanda for Kafka compatibility (if needed for event streaming)
  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:v23.2.15
    container_name: serviceradar-redpanda
    command:
      - redpanda start
      - --kafka-addr internal://0.0.0.0:9092,external://0.0.0.0:19092
      - --advertise-kafka-addr internal://redpanda:9092,external://localhost:19092
      - --smp 1
      - --memory 1G
      - --mode dev-container
    volumes:
      - redpanda-data:/var/lib/redpanda/data
    ports:
      - "19092:19092"  # Kafka external port
      - "9644:9644"    # Admin API
    networks:
      - serviceradar-net
    profiles:
      - full  # Only start when using --profile full
    restart: unless-stopped

  # Optional: NATS for messaging (if needed)
  nats:
    image: nats:latest
    container_name: serviceradar-nats
    ports:
      - "4222:4222"  # Client connections
      - "8222:8222"  # HTTP monitoring
      - "6222:6222"  # Cluster routing
    volumes:
      - nats-data:/data
      - cert-data:/etc/serviceradar/certs:ro
    command: ["--store_dir", "/data", "--cluster_name", "serviceradar"]
    networks:
      serviceradar-net:
        ipv4_address: 172.28.0.4
    profiles:
      - full  # Only start when using --profile full
    restart: unless-stopped

networks:
  serviceradar-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  cert-data:
    driver: local
  proton-data:
    driver: local
  core-data:
    driver: local
  redpanda-data:
    driver: local
  nats-data:
    driver: local