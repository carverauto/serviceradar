services:
  # Certificate Generation Service (runs once to generate mTLS certs)
  cert-generator:
    image: alpine:latest
    command: ["/bin/sh", "-c", "apk add --no-cache openssl && /bin/sh /entrypoint-certs.sh"]
    container_name: serviceradar-cert-generator
    volumes:
      - cert-data:/certs
      - ./docker/compose/entrypoint-certs.sh:/entrypoint-certs.sh:ro
    restart: "no"  # Only run once
    networks:
      - serviceradar-net

  # ServiceRadar Core Service
  core:
    image: ghcr.io/carverauto/serviceradar-core:v1.0.53
    container_name: serviceradar-core
    ports:
      - "8090:8090"  # HTTP API
      - "50052:50052"  # gRPC (matching core.json)
      - "9090:9090"  # Metrics (Prometheus)
    volumes:
      # Mount the actual config files from packaging
      # Using core.docker.json which has the correct CNPG connection details for Docker
      - ./packaging/core/config/core.docker.json:/etc/serviceradar/core.json:ro
      - ./packaging/core/config/api.env:/etc/serviceradar/api.env:ro
      - cert-data:/etc/serviceradar/certs:ro
      - core-data:/var/lib/serviceradar
      - ./logs:/var/log/serviceradar
    environment:
      # Wait for dependencies
      - INIT_DB=true
      
      # Override api.env values if needed
      - API_KEY=${API_KEY:-changeme}
      - JWT_SECRET=${JWT_SECRET:-changeme}
      - AUTH_ENABLED=${AUTH_ENABLED:-true}
      
      # Config source
      - CONFIG_SOURCE=${CONFIG_SOURCE:-file}
      - CONFIG_PATH=/etc/serviceradar/core.json
    depends_on:
      cert-generator:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    networks:
      serviceradar-net:
        ipv4_address: 172.28.0.3
    restart: unless-stopped

  # Optional: Redpanda for Kafka compatibility (if needed for event streaming)
  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:v23.2.15
    container_name: serviceradar-redpanda
    command:
      - redpanda start
      - --kafka-addr internal://0.0.0.0:9092,external://0.0.0.0:19092
      - --advertise-kafka-addr internal://redpanda:9092,external://localhost:19092
      - --smp 1
      - --memory 1G
      - --mode dev-container
    volumes:
      - redpanda-data:/var/lib/redpanda/data
    ports:
      - "19092:19092"  # Kafka external port
      - "9644:9644"    # Admin API
    networks:
      - serviceradar-net
    profiles:
      - full  # Only start when using --profile full
    restart: unless-stopped

  # Optional: NATS for messaging (if needed)
  nats:
    image: nats:latest
    container_name: serviceradar-nats
    ports:
      - "4222:4222"  # Client connections
      - "8222:8222"  # HTTP monitoring
      - "6222:6222"  # Cluster routing
    volumes:
      - nats-data:/data
      - cert-data:/etc/serviceradar/certs:ro
    command: ["--store_dir", "/data", "--cluster_name", "serviceradar"]
    networks:
      serviceradar-net:
        ipv4_address: 172.28.0.4
    profiles:
      - full  # Only start when using --profile full
    restart: unless-stopped

networks:
  serviceradar-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  cert-data:
    driver: local
  core-data:
    driver: local
  redpanda-data:
    driver: local
  nats-data:
    driver: local
