defmodule ServiceRadarWebNG.Repo.Migrations.CreateMonitoringResources do
  @moduledoc """
  Updates resources based on their most recent snapshots.

  This file was autogenerated with `mix ash_postgres.generate_migrations`
  """

  use Ecto.Migration

  def up do
    create table(:service_checks, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :name, :text, null: false
      add :description, :text
      add :check_type, :text, null: false
      add :target, :text, null: false
      add :port, :bigint
      add :interval_seconds, :bigint, default: 60
      add :timeout_seconds, :bigint, default: 10
      add :retries, :bigint, default: 3
      add :enabled, :boolean, default: true
      add :config, :map, default: %{}
      add :warning_threshold_ms, :bigint
      add :critical_threshold_ms, :bigint
      add :last_check_at, :utc_datetime
      add :last_result, :text
      add :last_response_time_ms, :bigint
      add :last_error, :text
      add :consecutive_failures, :bigint, default: 0

      add :agent_uid,
          references(:ocsf_agents,
            column: :uid,
            name: "service_checks_agent_uid_fkey",
            type: :text,
            prefix: "public"
          )

      add :device_uid,
          references(:ocsf_devices,
            column: :uid,
            name: "service_checks_device_uid_fkey",
            type: :text,
            prefix: "public"
          )

      add :metadata, :map, default: %{}
      add :tenant_id, :uuid, null: false

      add :created_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create table(:monitoring_events, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :category, :text, null: false
      add :event_type, :text, null: false
      add :severity, :bigint, default: 1
      add :message, :text, null: false
      add :details, :text
      add :source_type, :text
      add :source_id, :text
      add :source_name, :text
      add :target_type, :text
      add :target_id, :text
      add :target_name, :text

      add :device_uid,
          references(:ocsf_devices,
            column: :uid,
            name: "monitoring_events_device_uid_fkey",
            type: :text,
            prefix: "public"
          )

      add :agent_uid,
          references(:ocsf_agents,
            column: :uid,
            name: "monitoring_events_agent_uid_fkey",
            type: :text,
            prefix: "public"
          )

      add :alert_id, :uuid
      add :metadata, :map, default: %{}
      add :tags, {:array, :text}, default: []
      add :actor_type, :text
      add :actor_id, :text
      add :actor_name, :text
      add :client_ip, :text
      add :occurred_at, :utc_datetime, null: false
      add :tenant_id, :uuid, null: false

      add :created_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create table(:alerts, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
    end

    alter table(:monitoring_events) do
      modify :alert_id,
             references(:alerts,
               column: :id,
               name: "monitoring_events_alert_id_fkey",
               type: :uuid,
               prefix: "public"
             )
    end

    alter table(:alerts) do
      add :title, :text, null: false
      add :description, :text
      add :severity, :text, null: false, default: "warning"
      add :status, :text, null: false, default: "pending"
      add :source_type, :text
      add :source_id, :text

      add :service_check_id,
          references(:service_checks,
            column: :id,
            name: "alerts_service_check_id_fkey",
            type: :uuid,
            prefix: "public"
          )

      add :device_uid,
          references(:ocsf_devices,
            column: :uid,
            name: "alerts_device_uid_fkey",
            type: :text,
            prefix: "public"
          )

      add :agent_uid,
          references(:ocsf_agents,
            column: :uid,
            name: "alerts_agent_uid_fkey",
            type: :text,
            prefix: "public"
          )

      add :metric_name, :text
      add :metric_value, :float
      add :threshold_value, :float
      add :comparison, :text
      add :triggered_at, :utc_datetime
      add :acknowledged_at, :utc_datetime
      add :acknowledged_by, :text
      add :resolved_at, :utc_datetime
      add :resolved_by, :text
      add :resolution_note, :text
      add :escalated_at, :utc_datetime
      add :escalation_level, :bigint, default: 0
      add :escalation_reason, :text
      add :notification_count, :bigint, default: 0
      add :last_notification_at, :utc_datetime
      add :suppressed_until, :utc_datetime
      add :metadata, :map, default: %{}
      add :tags, {:array, :text}, default: []
      add :tenant_id, :uuid, null: false

      add :created_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end
  end

  def down do
    drop constraint(:alerts, "alerts_service_check_id_fkey")

    drop constraint(:alerts, "alerts_device_uid_fkey")

    drop constraint(:alerts, "alerts_agent_uid_fkey")

    alter table(:alerts) do
      remove :updated_at
      remove :created_at
      remove :tenant_id
      remove :tags
      remove :metadata
      remove :suppressed_until
      remove :last_notification_at
      remove :notification_count
      remove :escalation_reason
      remove :escalation_level
      remove :escalated_at
      remove :resolution_note
      remove :resolved_by
      remove :resolved_at
      remove :acknowledged_by
      remove :acknowledged_at
      remove :triggered_at
      remove :comparison
      remove :threshold_value
      remove :metric_value
      remove :metric_name
      remove :agent_uid
      remove :device_uid
      remove :service_check_id
      remove :source_id
      remove :source_type
      remove :status
      remove :severity
      remove :description
      remove :title
    end

    drop constraint(:monitoring_events, "monitoring_events_alert_id_fkey")

    alter table(:monitoring_events) do
      modify :alert_id, :uuid
    end

    drop table(:alerts)

    drop constraint(:monitoring_events, "monitoring_events_device_uid_fkey")

    drop constraint(:monitoring_events, "monitoring_events_agent_uid_fkey")

    drop table(:monitoring_events)

    drop constraint(:service_checks, "service_checks_agent_uid_fkey")

    drop constraint(:service_checks, "service_checks_device_uid_fkey")

    drop table(:service_checks)
  end
end
