defmodule ServiceRadarWebNG.Repo.Migrations.CreateOcsfAgents do
  @moduledoc """
  Creates tables for Ash resources that don't already exist.

  This file was autogenerated with `mix ash_postgres.generate_migrations`
  and then manually modified to avoid recreating existing tables.
  """

  use Ecto.Migration

  def up do
    # pollers table (new)
    create table(:pollers, primary_key: false) do
      add :poller_id, :text, null: false, primary_key: true
      add :component_id, :text
      add :registration_source, :text
      add :status, :text, default: "active"
      add :spiffe_identity, :text
      add :first_registered, :utc_datetime
      add :first_seen, :utc_datetime
      add :last_seen, :utc_datetime
      add :metadata, :map, default: %{}
      add :created_by, :text
      add :is_healthy, :boolean, default: true
      add :agent_count, :bigint, default: 0
      add :checker_count, :bigint, default: 0
      add :updated_at, :utc_datetime

      add :tenant_id, references(:tenants, column: :id, type: :uuid, on_delete: :delete_all),
        null: false
    end

    create unique_index(:pollers, [:poller_id], name: "pollers_unique_poller_id_index")

    # ocsf_devices table (new)
    create table(:ocsf_devices, primary_key: false) do
      add :uid, :text, null: false, primary_key: true
      add :type_id, :bigint, default: 0
      add :type, :text
      add :name, :text
      add :hostname, :text
      add :ip, :text
      add :mac, :text
      add :uid_alt, :text
      add :vendor_name, :text
      add :model, :text
      add :domain, :text
      add :zone, :text
      add :subnet_uid, :text
      add :vlan_uid, :text
      add :region, :text
      add :first_seen_time, :utc_datetime
      add :last_seen_time, :utc_datetime
      add :created_time, :utc_datetime
      add :modified_time, :utc_datetime
      add :risk_level_id, :bigint
      add :risk_level, :text
      add :risk_score, :bigint
      add :is_managed, :boolean, default: false
      add :is_compliant, :boolean
      add :is_trusted, :boolean, default: false
      add :os, :map, default: %{}
      add :hw_info, :map, default: %{}
      add :network_interfaces, {:array, :map}, default: []
      add :owner, :map, default: %{}
      add :org, :map, default: %{}
      add :groups, {:array, :map}, default: []
      add :agent_list, {:array, :map}, default: []
      add :poller_id, :text
      add :agent_id, :text
      add :discovery_sources, {:array, :text}, default: []
      add :is_available, :boolean, default: true
      add :metadata, :map, default: %{}

      add :tenant_id, references(:tenants, column: :id, type: :uuid, on_delete: :delete_all),
        null: false
    end

    create unique_index(:ocsf_devices, [:uid], name: "ocsf_devices_unique_uid_index")

    # ocsf_agents table (new)
    create table(:ocsf_agents, primary_key: false) do
      add :uid, :text, null: false, primary_key: true
      add :name, :text
      add :type_id, :bigint, default: 0
      add :type, :text
      add :uid_alt, :text
      add :vendor_name, :text, default: "ServiceRadar"
      add :version, :text
      add :policies, {:array, :map}, default: []
      add :poller_id, :text
      add :device_uid, :text
      add :capabilities, {:array, :text}, default: []
      add :host, :text
      add :port, :bigint
      add :spiffe_identity, :text
      add :status, :text, default: "connected"
      add :is_healthy, :boolean, default: true
      add :first_seen_time, :utc_datetime
      add :last_seen_time, :utc_datetime
      add :created_time, :utc_datetime
      add :modified_time, :utc_datetime
      add :metadata, :map, default: %{}

      add :tenant_id, references(:tenants, column: :id, type: :uuid, on_delete: :delete_all),
        null: false
    end

    create unique_index(:ocsf_agents, [:uid], name: "ocsf_agents_unique_uid_index")

    # Add indexes on tenant_id for query performance
    create index(:pollers, [:tenant_id])
    create index(:ocsf_devices, [:tenant_id])
    create index(:ocsf_agents, [:tenant_id])
  end

  def down do
    drop_if_exists unique_index(:ocsf_agents, [:uid], name: "ocsf_agents_unique_uid_index")
    drop table(:ocsf_agents)

    drop_if_exists unique_index(:ocsf_devices, [:uid], name: "ocsf_devices_unique_uid_index")
    drop table(:ocsf_devices)

    drop_if_exists unique_index(:pollers, [:poller_id], name: "pollers_unique_poller_id_index")
    drop table(:pollers)
  end
end
