# base/serviceradar-tools.yaml - Debugging container with comprehensive tooling
apiVersion: apps/v1
kind: Deployment
metadata:
  name: serviceradar-tools
spec:
  replicas: 1
  selector:
    matchLabels:
      app: serviceradar-tools
  template:
    metadata:
      labels:
        app: serviceradar-tools
    spec:
      containers:
      - name: tools
        image: serviceradar/tools:latest
        imagePullPolicy: Always
        command: ["/bin/bash", "-c", "tail -f /dev/null"]
        env:
        - name: NATS_URL
          value: "tls://serviceradar-nats:4222"
        - name: NATS_CREDS_FILE
          value: "/etc/serviceradar/nats/client.creds"
        - name: API_URL
          value: "https://serviceradar-core:8090"
        volumeMounts:
        - name: cert-data
          mountPath: /etc/serviceradar/certs
          readOnly: true
        - name: nats-context-config
          mountPath: /etc/serviceradar/nats/serviceradar.json
          subPath: serviceradar.json
          readOnly: true
        - name: tools-config
          mountPath: /etc/serviceradar/nats/setup-nats-context.sh
          subPath: setup-nats-context.sh
          readOnly: true
        - name: tools-config
          mountPath: /etc/motd
          subPath: motd
          readOnly: true
        resources:
          limits:
            cpu: "500m"
            memory: "512Mi"
          requests:
            cpu: "100m"
            memory: "128Mi"
        securityContext:
          capabilities:
            add:
            - NET_ADMIN
            - NET_RAW
      volumes:
      - name: cert-data
        persistentVolumeClaim:
          claimName: serviceradar-cert-data
      - name: nats-context-config
        configMap:
          name: serviceradar-nats-context
      - name: tools-config
        configMap:
          name: serviceradar-tools-config
          defaultMode: 0755
---
apiVersion: v1
kind: Service
metadata:
  name: serviceradar-tools
spec:
  selector:
    app: serviceradar-tools
  ports:
  - name: debug-port
    port: 22
    targetPort: 22
  type: ClusterIP
---
# ConfigMap for NATS context configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: serviceradar-nats-context
data:
  # NATS context configuration for debugging
  serviceradar.json: |
    {
      "description": "ServiceRadar NATS Context for Debugging",
      "url": "tls://serviceradar-nats:4222",
      "user": "",
      "password": "",
      "token": "",
      "nsc": "",
      "creds": "",
      "nkey": "",
      "cert": "/etc/serviceradar/certs/client.pem",
      "key": "/etc/serviceradar/certs/client-key.pem",
      "ca": "/etc/serviceradar/certs/root.pem",
      "nats_ca": "",
      "inbox_prefix": "_INBOX",
      "user_jwt": "",
      "color_scheme": "",
      "tls_first": false
    }
---
# Additional configuration for serviceradar-tools
apiVersion: v1
kind: ConfigMap
metadata:
  name: serviceradar-tools-config
data:
  motd: |

    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘                          ServiceRadar Debug Tools                           â•‘
    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
    â•‘                                                                              â•‘
    â•‘  ðŸ”§ DEBUGGING COMMANDS:                                                      â•‘
    â•‘    test-connectivity    - Test all service connectivity                     â•‘
    â•‘    nats-js-status      - Show NATS JetStream status                        â•‘
    â•‘    test-grpc           - Health check all gRPC services                    â•‘
    â•‘                                                                              â•‘
    â•‘  ðŸ“¡ NATS ALIASES:                                                            â•‘
    â•‘    nats-info           - Show NATS server information                       â•‘
    â•‘    nats-streams        - List all JetStream streams                         â•‘
    â•‘    nats-events         - Show events stream details                         â•‘
    â•‘    nats-kv             - Show KV store stream details                       â•‘
    â•‘                                                                              â•‘
    â•‘  ðŸ”Œ gRPC ALIASES:                                                            â•‘
    â•‘    grpc-core           - Connect to core gRPC (add method after)            â•‘
    â•‘    grpc-agent          - Connect to agent gRPC                              â•‘
    â•‘    grpc-mapper         - Connect to mapper gRPC                             â•‘
    â•‘    grpc-trapd          - Connect to trapd gRPC                              â•‘
    â•‘                                                                              â•‘
    â•‘  ðŸƒ QUICK TESTS:                                                             â•‘
    â•‘    nc-nats             - Test NATS TCP connectivity                         â•‘
    â•‘    ping-nats           - Ping NATS server                                   â•‘
    â•‘    sr-devices          - List devices via ServiceRadar CLI                  â•‘
    â•‘                                                                              â•‘
    â•‘  ðŸ“ CERT LOCATIONS:                                                          â•‘
    â•‘    /etc/serviceradar/certs/root.pem       - Root CA                         â•‘
    â•‘    /etc/serviceradar/certs/client.pem     - Client certificate              â•‘
    â•‘    /etc/serviceradar/certs/client-key.pem - Client private key              â•‘
    â•‘                                                                              â•‘
    â•‘  ðŸŽ¯ NATS CONTEXT: Configured for serviceradar-nats:4222 with mTLS           â•‘
    â•‘                                                                              â•‘
    â•‘  ðŸ’¡ TO GET STARTED:                                                          â•‘
    â•‘    kubectl exec -it deployment/serviceradar-tools -- /bin/bash              â•‘
    â•‘                                                                              â•‘
    â•‘    # Setup NATS context                                                      â•‘
    â•‘    cp /etc/serviceradar/nats/serviceradar.json ~/.config/nats/context/      â•‘
    â•‘    nats context select serviceradar                                          â•‘
    â•‘                                                                              â•‘
    â•‘    # Test NATS connectivity                                                  â•‘
    â•‘    test-connectivity                                                         â•‘
    â•‘    nats-js-status                                                            â•‘
    â•‘                                                                              â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  # Initialization script to setup NATS context automatically
  setup-nats-context.sh: |
    #!/bin/bash
    set -e
    
    echo "Setting up NATS context for debugging..."
    
    # Create context directory if it doesn't exist
    mkdir -p /root/.config/nats/context
    
    # Copy context configuration
    if [ -f /etc/serviceradar/nats/serviceradar.json ]; then
        cp /etc/serviceradar/nats/serviceradar.json /root/.config/nats/context/
        echo "NATS context configuration copied."
        
        # Set as default context
        if command -v nats >/dev/null 2>&1; then
            nats context select serviceradar 2>/dev/null || echo "Context selection failed, but config is available"
            echo "NATS context ready for debugging!"
        else
            echo "NATS CLI not found, but context config is available."
        fi
    else
        echo "Warning: NATS context configuration not found at /etc/serviceradar/nats/serviceradar.json"
    fi
    
    # Test basic connectivity
    echo ""
    echo "Testing basic connectivity..."
    if nc -zv serviceradar-nats 4222 2>/dev/null; then
        echo "âœ“ NATS connection successful"
    else
        echo "âœ— NATS connection failed"
    fi
    
    echo ""
    echo "ðŸ”§ ServiceRadar debugging tools are ready!"
    echo "   Run 'test-connectivity' to test all services"
    echo "   Run 'nats-js-status' to check JetStream"
    echo "   Run 'test-grpc' to test all gRPC services"
    echo ""