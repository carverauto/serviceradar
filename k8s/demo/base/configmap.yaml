# base/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: serviceradar-config
data:
    nginx.conf: |
      # ServiceRadar Web Interface - Nginx (Kubernetes)
      server {
        listen 80;
        server_name _;
  
        client_max_body_size 100M;
  
        # Static assets
        location /assets/ {
          proxy_pass http://serviceradar-web-ng:4000;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }
  
        # Swagger/UI (served by web-ng)
        location /swagger/ {
          proxy_pass http://serviceradar-web-ng:4000;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }
        location = /api-docs { proxy_pass http://serviceradar-web-ng:4000; }
        # API routes (web-ng)
        location /api/query {
          proxy_pass http://serviceradar-web-ng:4000;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }
        location /api/ {
          proxy_pass http://serviceradar-web-ng:4000;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Main app
        location / {
          proxy_pass http://serviceradar-web-ng:4000;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }
      }
    core.json: |
      
      {
        "listen_addr": ":8090",
        "grpc_addr": ":50052",
        "api_key": "",
        "cnpg": {
          "host": "",
          "port": 5432,
          "database": "telemetry",
          "username": "postgres",
          "password": "",
          "application_name": "serviceradar-core",
          "ssl_mode": "verify-full",
          "cert_dir": "/etc/serviceradar/certs",
          "max_connections": 50,
          "min_connections": 5,
          "statement_timeout": "30s",
          "tls": {
            "cert_file": "/etc/serviceradar/certs/core.pem",
            "key_file": "/etc/serviceradar/certs/core-key.pem",
            "ca_file": "/etc/serviceradar/cnpg/ca.crt"
          }
        },
        "alert_threshold": "5m",
        "known_gateways": [
          "k8s-gateway",
          "docker-gateway"
        ],
        "metrics": {
          "enabled": true,
          "retention": 100,
          "max_gateways": 10000
        },
        "features": {
          "use_log_digest": true,
          "use_device_search_planner": true,
          "require_device_registry": true
        },
        "security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "role": "core",
          "trust_domain": "carverauto.dev",
          "server_spiffe_id": "spiffe://carverauto.dev/ns/$(SERVICERADAR_NAMESPACE)/sa/serviceradar-core",
          "workload_socket": "unix:/run/spire/sockets/agent.sock",
          "tls": {
            "cert_file": "/etc/serviceradar/certs/core.pem",
            "key_file": "/etc/serviceradar/certs/core-key.pem",
            "ca_file": "/etc/serviceradar/certs/root.pem",
            "client_ca_file": "/etc/serviceradar/certs/root.pem",
            "skip_verify": false
          }
        },
        "kv_security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "role": "core",
          "trust_domain": "carverauto.dev",
          "server_spiffe_id": "spiffe://carverauto.dev/ns/$(SERVICERADAR_NAMESPACE)/sa/serviceradar-datasvc",
          "workload_socket": "unix:/run/spire/sockets/agent.sock",
          "tls": {
            "cert_file": "/etc/serviceradar/certs/core.pem",
            "key_file": "/etc/serviceradar/certs/core-key.pem",
            "ca_file": "/etc/serviceradar/certs/root.pem"
          }
        },
        "spire_admin": {
          "enabled": true,
          "server_address": "spire-server.$(SERVICERADAR_NAMESPACE).svc.cluster.local:8081",
          "server_spiffe_id": "spiffe://carverauto.dev/spire/server",
          "workload_socket": "unix:/run/spire/sockets/agent.sock",
          "join_token_ttl": "15m"
        },
        "edge_onboarding": {
          "enabled": true,
          "encryption_key": "",
          "default_selectors": [
            "unix:uid:0",
            "unix:gid:0",
            "unix:user:root",
            "unix:group:root"
          ],
          "default_metadata": {
            "gateway": {
              "core_address": "serviceradar-core:50052",
              "core_spiffe_id": "spiffe://carverauto.dev/ns/$(SERVICERADAR_NAMESPACE)/sa/serviceradar-core",
              "kv_address": "serviceradar-datasvc:50057",
              "kv_spiffe_id": "spiffe://carverauto.dev/ns/$(SERVICERADAR_NAMESPACE)/sa/serviceradar-datasvc",
              "spire_upstream_address": "spire-server.$(SERVICERADAR_NAMESPACE).svc.cluster.local",
              "spire_upstream_port": "8081",
              "spire_parent_id": "spiffe://carverauto.dev/ns/edge/gateway-nested-spire",
              "agent_address": "agent:50051",
              "agent_spiffe_id": "spiffe://carverauto.dev/services/agent",
              "nested_spire_wait_attempts": "120",
              "log_level": "info",
              "logs_dir": "./logs"
            },
            "checker": {
              "spire_upstream_address": "23.138.124.18",
              "spire_upstream_port": "18081",
              "trust_domain": "carverauto.dev"
            }
          },
          "join_token_ttl": "15m",
          "download_token_ttl": "10m",
          "gateway_id_prefix": "edge"
        },
        "cors": {
          "allowed_origins": ["*"],
          "allow_credentials": true
        },
        "auth": {
          "jwt_secret": "PLACEHOLDER_WILL_BE_REPLACED",
          "jwt_expiration": "24h",
          "local_users": {
            "admin": "PLACEHOLDER_BCRYPT_HASH_WILL_BE_REPLACED"
          },
          "rbac": {
            "user_roles": {
              "admin": ["admin", "operator", "viewer"],
              "operator": ["operator", "viewer"],
              "user": ["viewer"]
            },
            "role_permissions": {
              "admin": ["*"],
              "operator": ["config:read", "config:write", "device:*", "alert:*"],
              "viewer": ["config:read", "device:read", "alert:read", "metrics:read"]
            },
            "route_protection": {
              "/api/admin/*": ["admin"],
              "/api/config/*": {
                "GET": ["viewer", "operator", "admin"],
                "POST": ["operator", "admin"],
                "PUT": ["operator", "admin"],
                "DELETE": ["admin"]
              },
              "/api/devices/*": {
                "GET": ["viewer", "operator", "admin"],
                "POST": ["operator", "admin"],
                "PUT": ["operator", "admin"],
                "DELETE": ["admin"]
              },
              "/api/alerts/*": {
                "GET": ["viewer", "operator", "admin"],
                "POST": ["operator", "admin"],
                "PUT": ["operator", "admin"],
                "DELETE": ["admin"]
              }
            }
          }
        },
        "nats": {
          "url": "tls://serviceradar-nats:4222",
          "max_reconnects": 10,
          "reconnect_wait": "2s",
          "drain_timeout": "30s"
        },
        "logging": {
          "level": "info",
          "debug": false,
          "output": "stdout",
          "time_format": "",
          "otel": {
            "enabled": true,
            "endpoint": "serviceradar-otel:4317",
            "service_name": "serviceradar-core",
            "batch_timeout": "5s",
            "insecure": false,
            "headers": {},
            "tls": {
              "cert_file": "/etc/serviceradar/certs/core.pem",
              "key_file": "/etc/serviceradar/certs/core-key.pem",
              "ca_file": "/etc/serviceradar/certs/root.pem",
              "server_name": "serviceradar-otel"
            }
          }
        },
        "write_buffer": {
          "size": 10000,
          "flush_interval": "5s",
          "max_retries": 3,
          "retry_delay": "1s"
        }
      }
    agent.json: |
      {
        "checkers_dir": "/etc/serviceradar/checkers",
        "listen_addr": ":50051",
        "service_type": "grpc",
        "service_name": "AgentService",
        "agent_id": "k8s-agent",
        "agent_name": "agent",
        "host_ip": "agent",
        "partition": "default",
        "kv_address": "serviceradar-datasvc:50057",
        "kv_security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "role": "agent",
          "trust_domain": "carverauto.dev",
          "server_spiffe_id": "spiffe://carverauto.dev/ns/$(SERVICERADAR_NAMESPACE)/sa/serviceradar-datasvc",
          "workload_socket": "unix:/run/spire/sockets/agent.sock",
          "tls": {
            "cert_file": "agent.pem",
            "key_file": "agent-key.pem",
            "ca_file": "root.pem"
          }
        },
        "security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "role": "agent",
          "trust_domain": "carverauto.dev",
          "server_spiffe_id": "spiffe://carverauto.dev/ns/$(SERVICERADAR_NAMESPACE)/sa/serviceradar-agent",
          "workload_socket": "unix:/run/spire/sockets/agent.sock",
          "tls": {
            "cert_file": "agent.pem",
            "key_file": "agent-key.pem",
            "ca_file": "root.pem",
            "client_ca_file": "root.pem"
          }
        },
        "logging": {
          "level": "info",
          "debug": false,
          "output": "stdout",
          "time_format": "",
          "otel": {
            "enabled": false
          }
        }
      }
  
    sweep.json: |
      {
        "networks": [
            "192.168.2.0/24",
            "192.168.3.1/32"
        ],
        "ports": [
          22,
          80,
          443,
          3306,
          5432,
          6379,
          8080,
          8443
        ],
        "sweep_modes": [
          "icmp"
        ],
        "interval": "5m",
        "concurrency": 100,
        "timeout": "10s",
        "tcp_settings": {
          "rate_limit": 20000,
          "rate_limit_burst": 20000,
          "max_batch": 32,
          "concurrency": 256,
          "timeout": "3s"
        },
        "high_perf_icmp": true,
        "icmp_rate_limit": 5000,
        "icmp_settings": {
          "rate_limit": 1000,
          "timeout": "5s",
          "max_batch": 64
        }
      } 
  
    external.json: |
      {
        "enabled": true
      }
  
    mapper-checker.json: |
      {
        "name": "mapper",
        "type": "grpc",
        "address": "serviceradar-mapper:50056",
        "security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "role": "gateway",
          "trust_domain": "carverauto.dev",
          "server_spiffe_id": "spiffe://carverauto.dev/ns/$(SERVICERADAR_NAMESPACE)/sa/serviceradar-mapper",
          "workload_socket": "unix:/run/spire/sockets/agent.sock",
          "tls": {
            "cert_file": "agent.pem",
            "key_file": "agent-key.pem",
            "ca_file": "root.pem",
            "client_ca_file": "root.pem"
          }
        }
      }
  
    rperf-checker.json: |
      {
        "name": "rperf-checker",
        "type": "grpc",
        "address": "serviceradar-rperf:50081",
        "security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "role": "gateway",
          "trust_domain": "carverauto.dev",
          "server_spiffe_id": "spiffe://carverauto.dev/ns/$(SERVICERADAR_NAMESPACE)/sa/serviceradar-rperf-checker",
          "workload_socket": "unix:/run/spire/sockets/agent.sock",
          "tls": {
            "cert_file": "agent.pem",
            "key_file": "agent-key.pem",
            "ca_file": "root.pem",
            "client_ca_file": "root.pem"
          }
        }
      }
  
    flowgger-checker.json: |
      {
        "name": "flowgger",
        "type": "grpc",
        "address": "serviceradar-flowgger:50044",
        "security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "role": "gateway",
          "trust_domain": "carverauto.dev",
          "server_spiffe_id": "spiffe://carverauto.dev/ns/$(SERVICERADAR_NAMESPACE)/sa/serviceradar-flowgger",
          "workload_socket": "unix:/run/spire/sockets/agent.sock",
          "tls": {
            "cert_file": "agent.pem",
            "key_file": "agent-key.pem",
            "ca_file": "root.pem",
            "client_ca_file": "root.pem"
          }
        }
      }
  
    zen-checker.json: |
      {
        "name": "zen",
        "type": "grpc",
        "address": "serviceradar-zen:50040",
        "security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "role": "gateway",
          "trust_domain": "carverauto.dev",
          "server_spiffe_id": "spiffe://carverauto.dev/ns/$(SERVICERADAR_NAMESPACE)/sa/serviceradar-zen",
          "workload_socket": "unix:/run/spire/sockets/agent.sock",
          "tls": {
            "cert_file": "agent.pem",
            "key_file": "agent-key.pem",
            "ca_file": "root.pem",
            "client_ca_file": "root.pem"
          }
        }
      }
  
    db-event-writer-checker.json: |
      {
        "name": "db-event-writer",
        "type": "grpc",
        "address": "serviceradar-db-event-writer:50041",
        "security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "role": "gateway",
          "trust_domain": "carverauto.dev",
          "server_spiffe_id": "spiffe://carverauto.dev/ns/$(SERVICERADAR_NAMESPACE)/sa/serviceradar-db-event-writer",
          "workload_socket": "unix:/run/spire/sockets/agent.sock",
          "tls": {
            "cert_file": "agent.pem",
            "key_file": "agent-key.pem",
            "ca_file": "root.pem",
            "client_ca_file": "root.pem"
          }
        }
      }
  
    trapd-checker.json: |
      {
        "name": "trapd",
        "type": "grpc",
        "address": "serviceradar-trapd:50043",
        "security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "role": "gateway",
          "trust_domain": "carverauto.dev",
          "server_spiffe_id": "spiffe://carverauto.dev/ns/$(SERVICERADAR_NAMESPACE)/sa/serviceradar-trapd",
          "workload_socket": "unix:/run/spire/sockets/agent.sock",
          "tls": {
            "cert_file": "agent.pem",
            "key_file": "agent-key.pem",
            "ca_file": "root.pem",
            "client_ca_file": "root.pem"
          }
        }
      }
  
    zen.json: |
      {
        "nats_url": "tls://serviceradar-nats:4222",
        "nats_creds_file": "/etc/serviceradar/creds/platform.creds",
        "stream_name": "events",
        "consumer_name": "zen-consumer",
        "subjects": [
          "logs.syslog",
          "logs.snmp",
          "logs.otel",
          "otel.metrics.raw"
        ],
        "decision_groups": [
          {
            "name": "syslog",
            "subjects": ["logs.syslog"],
            "rules": [
              {"order": 1, "key": "strip_full_message"},
              {"order": 2, "key": "cef_severity"}
            ],
            "format": "json"
          },
          {
            "name": "snmp",
            "subjects": ["logs.snmp"],
            "rules": [
              {"order": 1, "key": "snmp_severity"}
            ],
            "format": "json"
          },
          {
            "name": "otel_logs",
            "subjects": ["logs.otel"],
            "rules": [
              {"order": 1, "key": "passthrough"}
            ],
            "format": "protobuf"
          },
          {
            "name": "otel_metrics_raw",
            "subjects": ["otel.metrics.raw"],
            "rules": [
              {"order": 1, "key": "passthrough"}
            ],
            "format": "otel_metrics"
          }
        ],
        "agent_id": "k8s-zen-consumer",
        "kv_address": "serviceradar-datasvc:50057",
        "kv_bucket": "serviceradar-datasvc",
        "listen_addr": "0.0.0.0:50040",
        "result_subject_suffix": ".processed",
        "security": {
          "cert_file": "/etc/serviceradar/certs/zen.pem",
          "key_file": "/etc/serviceradar/certs/zen-key.pem",
          "ca_file": "/etc/serviceradar/certs/root.pem"
        },
        "grpc_security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "role": "zen",
          "trust_domain": "carverauto.dev",
          "workload_socket": "unix:/run/spire/sockets/agent.sock"
        },
        "kv_security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "role": "zen",
          "trust_domain": "carverauto.dev",
          "server_spiffe_id": "spiffe://carverauto.dev/ns/$(SERVICERADAR_NAMESPACE)/sa/serviceradar-datasvc",
          "workload_socket": "unix:/run/spire/sockets/agent.sock",
          "tls": {
            "cert_file": "zen.pem",
            "key_file": "zen-key.pem",
            "ca_file": "root.pem"
          }
        },
        "logging": {
          "level": "info",
          "debug": false,
          "output": "stdout",
          "time_format": "",
          "otel": {
            "enabled": true,
            "endpoint": "serviceradar-otel:4317",
            "service_name": "serviceradar-zen",
            "batch_timeout": "5s",
            "insecure": false,
            "headers": {},
            "tls": {
              "cert_file": "/etc/serviceradar/certs/zen.pem",
              "key_file": "/etc/serviceradar/certs/zen-key.pem",
              "ca_file": "/etc/serviceradar/certs/root.pem",
              "server_name": "serviceradar-otel"
            }
          }
        }
      }
  
    snmp.json: |
      {
        "node_address": "localhost:50051",
        "listen_addr": ":50054",
        "partition": "k8s",
        "security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "role": "checker",
          "server_name": "serviceradar-snmp-checker",
          "trust_domain": "carverauto.dev",
          "server_spiffe_id": "spiffe://carverauto.dev/ns/$(SERVICERADAR_NAMESPACE)/sa/serviceradar-snmp-checker",
          "workload_socket": "unix:/run/spire/sockets/agent.sock"
        },
        "timeout": "30s",
        "targets": [
          {
            "name": "test-router",
            "host": "192.168.1.1",
            "port": 161,
            "community": "public",
            "version": "v2c",
            "interval": "5m",
            "retries": 2,
            "oids": [
              {
                "oid": ".1.3.6.1.2.1.2.2.1.10.4",
                "name": "ifInOctets_4",
                "type": "counter",
                "scale": 1.0
              }
            ]
          }
        ]
      }
  
    snmp-checker.json: |
      {
        "name": "snmp",
        "type": "grpc",
        "address": "serviceradar-snmp-checker:50054",
        "security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "role": "gateway",
          "trust_domain": "carverauto.dev",
          "server_spiffe_id": "spiffe://carverauto.dev/ns/$(SERVICERADAR_NAMESPACE)/sa/serviceradar-snmp-checker",
          "workload_socket": "unix:/run/spire/sockets/agent.sock",
          "tls": {
            "cert_file": "agent.pem",
            "key_file": "agent-key.pem",
            "ca_file": "root.pem",
            "client_ca_file": "root.pem"
          }
        }
      }
  
    faker.json: |
      {
        "service": {
          "name": "faker",
          "description": "ServiceRadar Fake Armis API Service",
          "version": "1.0.0"
        },
        "server": {
          "listen_address": "0.0.0.0:8080",
          "read_timeout": "10s",
          "write_timeout": "30s",
          "idle_timeout": "30s"
        },
        "simulation": {
          "total_devices": 50000,
          "ip_shuffle": {
            "enabled": true,
            "interval": "60s",
            "percentage": 5,
            "log_changes": true
          }
        },
        "storage": {
          "data_dir": "/var/lib/serviceradar/faker",
          "devices_file": "fake_armis_devices.json",
          "persist_changes": true
        },
        "logging": {
          "level": "info",
          "file": "/var/log/serviceradar/faker.log",
          "max_size": "100M",
          "max_backups": 5,
          "max_age": 30
        }
      }
  
    rperf.json: |
      {
        "listen_addr": "0.0.0.0:50081",
        "name": "rperf-checker",
        "type": "grpc",
        "timeout": "30s",
        "security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "trust_domain": "carverauto.dev",
          "workload_socket": "unix:/run/spire/sockets/agent.sock",
          "tls": {
            "cert_file": "rperf-checker.pem",
            "key_file": "rperf-checker-key.pem",
            "ca_file": "root.pem",
            "client_ca_file": "root.pem"
          }
        },
        "default_poll_interval": 300,
        "targets": []
      }
  
    core-k8s-init.sh: |
      #!/bin/bash
      set -e
      
      echo "ðŸ”‘ Using API_KEY: ${API_KEY:0:8}... (${#API_KEY} chars)"
      echo "ðŸ” Using JWT_SECRET: ${JWT_SECRET:0:8}... (${#JWT_SECRET} chars)"
      
      TEMPLATE_PATH="/etc/serviceradar/core.json"
      CONFIG_PATH="${CONFIG_PATH:-/var/lib/serviceradar/core.json}"
      CONFIG_DIR=$(dirname "$CONFIG_PATH")
      mkdir -p "$CONFIG_DIR"
      if [ ! -f "$CONFIG_PATH" ]; then
          echo "Seeding runtime config from $TEMPLATE_PATH into $CONFIG_PATH"
          cp "$TEMPLATE_PATH" "$CONFIG_PATH"
      fi
      echo "Using runtime configuration at $CONFIG_PATH"
      
      EFFECTIVE_NAMESPACE="${KUBERNETES_NAMESPACE:-$(SERVICERADAR_NAMESPACE)}"
      CNPG_HOST_VALUE="${CNPG_HOST:-cnpg-rw.${EFFECTIVE_NAMESPACE}.svc}"
      CNPG_PORT_VALUE="${CNPG_PORT:-5432}"
      CNPG_DATABASE_VALUE="${CNPG_DATABASE:-serviceradar}"
      CNPG_USERNAME_VALUE="${CNPG_USERNAME:-postgres}"
      CNPG_SSLMODE_VALUE="${CNPG_SSLMODE:-verify-full}"
      CNPG_CERT_DIR_VALUE="${CNPG_CERT_DIR:-/etc/serviceradar/certs}"
      
      if [ -n "$CNPG_PASSWORD" ]; then
          echo "Found CNPG password from Kubernetes secret"
      else
          echo "Warning: CNPG_PASSWORD environment variable not found"
      fi
      
      if [ -z "$EDGE_ONBOARDING_ENCRYPTION_KEY" ]; then
          echo "ERROR: EDGE_ONBOARDING_ENCRYPTION_KEY environment variable not found" >&2
          exit 1
      else
          echo "Using edge onboarding encryption key from Kubernetes secret"
      fi
      
      if [ -f "$CONFIG_PATH" ]; then
          TEMPLATE_SECURITY=$(jq -c '.security // empty' "$TEMPLATE_PATH")
          if [ -n "$TEMPLATE_SECURITY" ]; then
              echo "Synchronizing security block from template"
              TMP_CONFIG=$(mktemp)
              jq --argjson security "$TEMPLATE_SECURITY" '.security = $security' "$CONFIG_PATH" > "$TMP_CONFIG"
              mv "$TMP_CONFIG" "$CONFIG_PATH"
          fi
      
          echo "Updating configuration with secrets..."
          TMP_CONFIG=$(mktemp)
          jq --arg host "$CNPG_HOST_VALUE" \
             --arg port "$CNPG_PORT_VALUE" \
             --arg db "$CNPG_DATABASE_VALUE" \
             --arg user "$CNPG_USERNAME_VALUE" \
             --arg pwd "$CNPG_PASSWORD" \
             --arg ssl "$CNPG_SSLMODE_VALUE" \
             --arg certdir "$CNPG_CERT_DIR_VALUE" \
             --arg jwt "$JWT_SECRET" \
             --arg api_key "$API_KEY" \
             --arg bcrypt "$ADMIN_BCRYPT_HASH" \
             --arg edge_key "$EDGE_ONBOARDING_ENCRYPTION_KEY" \
             '.cnpg.host = $host
              | .cnpg.port = ($port | tonumber)
              | .cnpg.database = $db
              | .cnpg.username = $user
              | .cnpg.password = $pwd
              | .cnpg.ssl_mode = $ssl
              | .cnpg.cert_dir = $certdir
             | .auth.jwt_secret = $jwt
             | .auth.jwt_expiration = "24h"
            | .auth.local_users.admin = $bcrypt
            | .api_key = $api_key
             | (if (.logging? // null) != null and (.logging.otel? // null) != null
                then (.logging.otel.headers = ((.logging.otel.headers // {}) + {"x-api-key": $api_key}))
                else .
               end)
             | .edge_onboarding.encryption_key = $edge_key' \
            "$CONFIG_PATH" > "$TMP_CONFIG"
          mv "$TMP_CONFIG" "$CONFIG_PATH"
          echo "Configuration updated with secrets at $CONFIG_PATH"
      
          if ! jq -e '.auth.jwt_private_key_pem // empty' "$CONFIG_PATH" >/dev/null 2>&1; then
              echo "Warning: RS256 key material missing from $CONFIG_PATH; Core JWKS will be empty" >&2
          fi
      fi
      
      if [ "${WAIT_FOR_CNPG:-true}" = "true" ]; then
          echo "Waiting for CNPG at ${CNPG_HOST_VALUE}:${CNPG_PORT_VALUE}..."
          CNPG_READY=false
          for i in {1..30}; do
              if timeout 5 bash -lc "exec 3<>/dev/tcp/${CNPG_HOST_VALUE}/${CNPG_PORT_VALUE}" > /dev/null 2>&1; then
                  CNPG_READY=true
                  break
              fi
              echo "Waiting for CNPG... ($i/30)"
              sleep 2
          done
          if [ "$CNPG_READY" != "true" ]; then
              echo "Warning: CNPG endpoint did not respond after 30 attempts; proceeding anyway" >&2
          else
              echo "CNPG port is reachable."
          fi
      fi
      
      if [ "${INIT_DB:-false}" = "true" ]; then
          echo "Initializing database tables..."
      fi
      
      echo "ðŸ” Final environment check:"
      echo "  API_KEY: ${API_KEY:0:8}... (${#API_KEY} chars)"
      echo "  JWT_SECRET: ${JWT_SECRET:0:8}... (${#JWT_SECRET} chars)"
      echo "  AUTH_ENABLED: ${AUTH_ENABLED:-true}"
      
      echo "Starting serviceradar-core"
      exec /usr/local/bin/serviceradar-core --config="$CONFIG_PATH"
    nats.conf: |
      # NATS Server Configuration for ServiceRadar Kubernetes Deployment
      server_name: nats-serviceradar-k8s
  
      # Listen on all interfaces for Kubernetes networking
      listen: 0.0.0.0:4222
  
      # HTTP monitoring
      http: 0.0.0.0:8222
  
      # Enable JetStream for KV store
      jetstream {
        # Directory to store JetStream data
        store_dir: /data/jetstream
        # Maximum storage size
        max_memory_store: 1G
        # Maximum disk storage
        max_file_store: 20G
      }
  
      # Enable mTLS for secure communication
      tls {
        # Path to the server certificate
        cert_file: "/etc/serviceradar/certs/nats.pem"
        # Path to the server private key
        key_file: "/etc/serviceradar/certs/nats-key.pem"
        # Path to the root CA certificate for verifying clients
        ca_file: "/etc/serviceradar/certs/root.pem"
  
        # Require client certificates (enables mTLS)
        verify: true
        # Require and verify client certificates
        verify_and_map: true
      }
  
      # Account-based authorization for ServiceRadar components
      accounts {
        # System account with full privileges  
        SYS: {
          users: []
        }
  
        # ServiceRadar services account
        SERVICERADAR: {
          jetstream: enabled
          users: [
          {
            user: "CN=serviceradar-debug-client,OU=Kubernetes,O=ServiceRadar,L=San Francisco,ST=CA,C=US"
            permissions: {
              publish: {
                allow: [">"]
              }
              subscribe: {
                allow: [">"]
              }
            }
          },
          {
            user: "CN=serviceradar-core,OU=Kubernetes,O=ServiceRadar,L=San Francisco,ST=CA,C=US"
            permissions: {
              publish: {
                allow: [">"]
              }
              subscribe: {
                allow: [">"]
              }
            }
          },
          {
            user: "CN=serviceradar-datasvc,OU=Kubernetes,O=ServiceRadar,L=San Francisco,ST=CA,C=US"
            permissions: {
              publish: {
                allow: [">"]
              }
              subscribe: {
                allow: [">"]
              }
            }
          },
          {
            user: "CN=serviceradar-agent,OU=Kubernetes,O=ServiceRadar,L=San Francisco,ST=CA,C=US"
            permissions: {
              publish: {
                allow: [">"]
              }
              subscribe: {
                allow: [">"]
              }
            }
          },
          {
            user: "CN=serviceradar-db-event-writer,OU=Kubernetes,O=ServiceRadar,L=San Francisco,ST=CA,C=US"
            permissions: {
              publish: {
                allow: [">"]
              }
              subscribe: {
                allow: [">"]
              }
            }
          },
          {
            user: "CN=serviceradar-zen,OU=Kubernetes,O=ServiceRadar,L=San Francisco,ST=CA,C=US"
            permissions: {
              publish: {
                allow: [">"]
              }
              subscribe: {
                allow: [">"]
              }
            }
          },
          {
            user: "CN=serviceradar-flowgger,OU=Kubernetes,O=ServiceRadar,L=San Francisco,ST=CA,C=US"
            permissions: {
              publish: {
                allow: ["logs.syslog", "$JS.API.STREAM.INFO.events", "$JS.API.STREAM.CREATE.events", "$JS.API.>"]
              }
              subscribe: {
                allow: ["$JS.API.>", "_INBOX.>"]
              }
            }
          },
          {
            user: "CN=serviceradar-otel,OU=Kubernetes,O=ServiceRadar,L=San Francisco,ST=CA,C=US"
            permissions: {
              publish: {
                allow: ["otel.>", "logs.otel", "$JS.API.>"]
              }
              subscribe: {
                allow: ["$JS.API.>", "_INBOX.>"]
              }
            }
          },
          {
            user: "CN=serviceradar-mapper,OU=Kubernetes,O=ServiceRadar,L=San Francisco,ST=CA,C=US"
            permissions: {
              publish: {
                allow: [">"]
              }
              subscribe: {
                allow: [">"]
              }
            }
          },
          {
            user: "CN=serviceradar-trapd,OU=Kubernetes,O=ServiceRadar,L=San Francisco,ST=CA,C=US"
            permissions: {
              publish: {
                allow: ["logs.snmp", "$JS.API.STREAM.INFO.events", "$JS.API.STREAM.CREATE.events", "$JS.API.>"]
              }
              subscribe: {
                allow: ["$JS.API.>", "_INBOX.>"]
              }
            }
          },
          {
            user: "O=ServiceRadar"
            permissions: {
              publish: {
                allow: [">"]
              }
              subscribe: {
                allow: [">"]
              }
            }
          }
          ]
        }
      }
  
      # Set system account
      system_account: "SYS"
  
      # Logging settings
      debug: true
      trace: false
  
    otel.toml: |
      # ServiceRadar OTEL Collector Configuration for Kubernetes Deployment
  
      [server]
      # Address to bind the OTEL collector to
      bind_address = "0.0.0.0"
      # Port to listen on for OTEL traces
      port = 4317
  
      [nats]
      # NATS server URL with mTLS (Kubernetes deployment)
      url = "tls://serviceradar-nats:4222"
      creds_file = "/etc/serviceradar/creds/platform.creds"
  
      # Subject to publish traces/metrics to (default: otel)
      subject = "otel"
      # Subject to publish logs to (default: <subject>.logs)
      logs_subject = "logs.otel"
  
      # JetStream stream name (default: events)
      stream = "events"
  
      # Timeout for NATS operations in seconds (default: 30)
      timeout_secs = 30
  
      # Maximum retained size of the events stream (default: 2 GiB)
      max_bytes = 2147483648
  
      # Maximum retention window for the events stream in seconds (default: 30 minutes)
      max_age_secs = 1800
  
      # mTLS configuration for NATS
      [nats.tls]
      cert_file = "/etc/serviceradar/certs/otel.pem"
      key_file = "/etc/serviceradar/certs/otel-key.pem"
      ca_file = "/etc/serviceradar/certs/root.pem"
  
      [grpc_tls]
      cert_file = "/etc/serviceradar/certs/otel.pem"
      key_file = "/etc/serviceradar/certs/otel-key.pem"
      ca_file = "/etc/serviceradar/certs/root.pem"
  
    trapd.json: |
      {
        "listen_addr": "0.0.0.0:162",
        "nats_url": "tls://serviceradar-nats:4222",
        "nats_creds_file": "/etc/serviceradar/creds/platform.creds",
        "stream_name": "events",
        "subject": "logs.snmp",
        "nats_security": {
          "mode": "mtls",
          "cert_dir": "/etc/serviceradar/certs",
          "cert_file": "/etc/serviceradar/certs/trapd.pem",
          "key_file": "/etc/serviceradar/certs/trapd-key.pem",
          "ca_file": "/etc/serviceradar/certs/root.pem"
        },
        "grpc_listen_addr": "0.0.0.0:50043",
        "grpc_security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "trust_domain": "carverauto.dev",
          "workload_socket": "unix:/run/spire/sockets/agent.sock",
          "cert_file": "/etc/serviceradar/certs/trapd.pem",
          "key_file": "/etc/serviceradar/certs/trapd-key.pem",
          "ca_file": "/etc/serviceradar/certs/root.pem"
        },
        "otel": {
          "enabled": true,
          "endpoint": "serviceradar-otel:4317",
          "service_name": "serviceradar-trapd",
          "tls": {
            "cert_file": "/etc/serviceradar/certs/trapd.pem",
            "key_file": "/etc/serviceradar/certs/trapd-key.pem",
            "ca_file": "/etc/serviceradar/certs/root.pem",
            "server_name": "serviceradar-otel"
          }
        }
      }
  
    mapper.json: |
      {
        "workers": 20,
        "timeout": "30s",
        "retries": 3,
        "max_active_jobs": 100,
        "result_retention": "24h",
        "mapper_agent_id": "k8s-mapper",
        "mapper_instance_id": "serviceradar-mapper-k8s",
        "default_credentials": {
          "version": "v2c",
          "community": "public"
        },
        "oids": {
          "basic": [
            ".1.3.6.1.2.1.1.1.0",
            ".1.3.6.1.2.1.1.2.0",
            ".1.3.6.1.2.1.1.5.0",
            ".1.3.6.1.2.1.1.4.0",
            ".1.3.6.1.2.1.1.6.0",
            ".1.3.6.1.2.1.1.3.0"
          ],
          "interfaces": [
            ".1.3.6.1.2.1.2.2.1",
            ".1.3.6.1.2.1.31.1.1.1",
            ".1.3.6.1.2.1.4.20.1"
          ],
          "topology": [
            ".1.0.8802.1.1.2.1",
            ".1.3.6.1.4.1.9.9.23.1"
          ]
        },
        "stream_config": {
          "device_stream": "sweep_results",
          "interface_stream": "discovered_interfaces",
          "topology_stream": "topology_discovery_events",
          "agent_id": "k8s-snmp-discovery-agent",
          "publish_batch_size": 100,
          "publish_retries": 3,
          "publish_retry_interval": "5s"
        },
        "credentials": [
          {
            "targets": ["192.168.1.0/24", "192.168.2.0/24"],
            "version": "v2c",
            "community": "public"
          }
        ],
        "scheduled_jobs": [
          {
            "name": "k8s-lan-discovery",
            "interval": "2h",
            "enabled": true,
            "seeds": ["192.168.1.1", "192.168.2.1"],
            "type": "full",
            "credentials": {
              "version": "v2c",
              "community": "public"
            },
            "concurrency": 10,
            "timeout": "45s",
            "retries": 2,
            "options": {
              "trigger_discovery": "false"
            }
          }
        ],
        "unifi_apis": [],
        "security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "role": "checker",
          "trust_domain": "carverauto.dev",
          "workload_socket": "unix:/run/spire/sockets/agent.sock"
        },
        "logging": {
          "level": "info",
          "debug": false,
          "output": "stdout",
          "time_format": "",
          "otel": {
            "enabled": true,
            "endpoint": "serviceradar-otel:4317",
            "service_name": "serviceradar-mapper",
            "batch_timeout": "5s",
            "insecure": false,
            "headers": {},
            "tls": {
              "cert_file": "/etc/serviceradar/certs/mapper.pem",
              "key_file": "/etc/serviceradar/certs/mapper-key.pem",
              "ca_file": "/etc/serviceradar/certs/root.pem",
              "server_name": "serviceradar-otel"
            }
          }
        }
      }
  
    # Data Service Configuration
    datasvc.json: |
      {
        "listen_addr": "0.0.0.0:50057",
        "nats_url": "tls://serviceradar-nats:4222",
        "nats_creds_file": "/etc/serviceradar/creds/platform.creds",
        "security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "role": "datasvc",
          "trust_domain": "carverauto.dev",
          "server_spiffe_id": "spiffe://carverauto.dev/ns/$(SERVICERADAR_NAMESPACE)/sa/serviceradar-datasvc",
          "workload_socket": "unix:/run/spire/sockets/agent.sock",
          "tls": {
            "cert_file": "datasvc.pem",
            "key_file": "datasvc-key.pem",
            "ca_file": "root.pem",
            "client_ca_file": "root.pem"
          }
        },
        "nats_security": {
          "mode": "mtls",
          "cert_dir": "/etc/serviceradar/certs",
          "server_name": "serviceradar-nats",
          "role": "datasvc",
          "tls": {
            "cert_file": "datasvc.pem",
            "key_file": "datasvc-key.pem",
            "ca_file": "root.pem",
            "client_ca_file": "root.pem"
          }
        },
        "rbac": {
          "roles": [
            {"identity": "spiffe://carverauto.dev/ns/$(SERVICERADAR_NAMESPACE)/sa/serviceradar-core", "role": "writer"},
            {"identity": "spiffe://carverauto.dev/ns/$(SERVICERADAR_NAMESPACE)/sa/serviceradar-mapper", "role": "reader"},
            {"identity": "spiffe://carverauto.dev/ns/$(SERVICERADAR_NAMESPACE)/sa/serviceradar-snmp-checker", "role": "writer"},
            {"identity": "spiffe://carverauto.dev/ns/$(SERVICERADAR_NAMESPACE)/sa/serviceradar-db-event-writer", "role": "reader"},
            {"identity": "spiffe://carverauto.dev/ns/$(SERVICERADAR_NAMESPACE)/sa/serviceradar-zen", "role": "reader"},
            {"identity": "spiffe://carverauto.dev/ns/$(SERVICERADAR_NAMESPACE)/sa/serviceradar-agent", "role": "writer"},
            {"identity": "CN=serviceradar-agent,OU=Kubernetes,O=ServiceRadar,L=San Francisco,ST=CA,C=US", "role": "writer"},
            {"identity": "CN=serviceradar-zen,OU=Kubernetes,O=ServiceRadar,L=San Francisco,ST=CA,C=US", "role": "reader"},
            {"identity": "CN=serviceradar-core,OU=Kubernetes,O=ServiceRadar,L=San Francisco,ST=CA,C=US", "role": "writer"},
            {"identity": "CN=serviceradar-debug-client,OU=Kubernetes,O=ServiceRadar,L=San Francisco,ST=CA,C=US", "role": "reader"}
          ]
        },
        "bucket": "serviceradar-datasvc",
        "bucket_history": 1,
        "bucket_ttl": "24h",
        "bucket_max_bytes": 5368709120
      }
