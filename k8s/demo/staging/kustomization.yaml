# overlays/demo/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: demo-staging

resources:
  - ../base
  - namespace.yaml
  - service-aliases.demo-staging.yaml
  - ingress.yaml
  - serviceradar-core-grpc-external.yaml
  - serviceradar-datasvc-grpc-external.yaml
  - serviceradar-flowgger-external.yaml
  - spire-server-external.yaml

patchesStrategicMerge:
  - spire-server-configmap.yaml
  - spire-controller-manager-configmap.yaml

transformers:
  - namespace-transformer.yaml

configurations:
  - var-references.yaml

replacements:
  - source:
      kind: Namespace
      name: demo-staging
      fieldPath: metadata.name
    targets:
      - select:
          kind: ClusterSPIFFEID
        fieldPaths:
          - spec.namespaceSelector.matchLabels.[kubernetes.io/metadata.name]
      - select:
          kind: ClusterSPIFFEID
        fieldPaths:
          - spec.spiffeIDTemplate
        options:
          delimiter: /
          index: 4

images:
- name: ghcr.io/carverauto/serviceradar-core
  newTag: sha-3994c6a9632eb88840c3be3d1755f27a1f444fd4
- name: ghcr.io/carverauto/serviceradar-web
  newTag: sha-3994c6a9632eb88840c3be3d1755f27a1f444fd4
- name: ghcr.io/carverauto/serviceradar-agent
  newTag: sha-3994c6a9632eb88840c3be3d1755f27a1f444fd4
- name: ghcr.io/carverauto/serviceradar-poller
  newTag: sha-3994c6a9632eb88840c3be3d1755f27a1f444fd4
- name: ghcr.io/carverauto/serviceradar-snmp-checker
  newTag: sha-3994c6a9632eb88840c3be3d1755f27a1f444fd4
- name: ghcr.io/carverauto/serviceradar-datasvc
  newTag: sha-3994c6a9632eb88840c3be3d1755f27a1f444fd4
- name: ghcr.io/carverauto/serviceradar-sync
  newTag: sha-3994c6a9632eb88840c3be3d1755f27a1f444fd4
- name: ghcr.io/carverauto/serviceradar-tools
  newTag: sha-3994c6a9632eb88840c3be3d1755f27a1f444fd4
- name: ghcr.io/carverauto/serviceradar-srql
  newTag: sha-3994c6a9632eb88840c3be3d1755f27a1f444fd4

vars:
- name: SERVICERADAR_NAMESPACE
  objref:
    apiVersion: v1
    kind: Namespace
    name: demo-staging
  fieldref:
    fieldPath: metadata.name
