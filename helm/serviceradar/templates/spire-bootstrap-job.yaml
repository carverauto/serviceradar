{{- if and .Values.spire.enabled .Values.spire.bootstrap.enabled }}
{{- $ns := default .Release.Namespace .Values.spire.namespace }}
apiVersion: batch/v1
kind: Job
metadata:
  name: spire-bootstrap
  namespace: {{ $ns }}
spec:
  backoffLimit: 3
  {{- if .Values.spire.bootstrap.ttlSecondsAfterFinished }}
  ttlSecondsAfterFinished: {{ .Values.spire.bootstrap.ttlSecondsAfterFinished }}
  {{- end }}
  template:
    metadata:
      labels:
        job: spire-bootstrap
    spec:
      serviceAccountName: spire-bootstrap
      restartPolicy: OnFailure
      containers:
        - name: bootstrap
          image: {{ printf "%s:%s" .Values.spire.bootstrap.image .Values.spire.bootstrap.tag }}
          imagePullPolicy: Always
          command: ["/bin/bash", "/scripts/bootstrap.sh"]
          env:
            - name: SPIRE_NAMESPACE
              value: {{ $ns | quote }}
            - name: SPIRE_SERVER_SELECTOR
              value: {{ .Values.spire.serverSelector | quote }}
            - name: SPIRE_TRUST_DOMAIN
              value: {{ .Values.spire.trustDomain | quote }}
            - name: SPIRE_CLUSTER_NAME
              value: {{ .Values.spire.clusterName | quote }}
            - name: SPIRE_AGENT_SERVICE_ACCOUNT
              value: {{ .Values.spire.agentServiceAccount | quote }}
            - name: SPIRE_CORE_SERVICE_ACCOUNT
              value: {{ .Values.spire.coreServiceAccount | quote }}
            - name: SPIRE_POLLER_SERVICE_ACCOUNT
              value: {{ .Values.spire.pollerServiceAccount | quote }}
            - name: SPIRE_DATASVC_SERVICE_ACCOUNT
              value: {{ .Values.spire.datasvcServiceAccount | quote }}
          volumeMounts:
            - name: bootstrap-script
              mountPath: /scripts
              readOnly: true
      volumes:
        - name: bootstrap-script
          configMap:
            name: spire-bootstrap
            defaultMode: 0755
{{- end }}
