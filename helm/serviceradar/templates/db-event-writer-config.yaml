# Rendered as-is from staging overlay
# Rendered as-is from staging overlay
{{- $trustDomain := .Values.spire.trustDomain | default "carverauto.dev" -}}
{{- $cnpg := default (dict) .Values.cnpg }}
{{- $pg := default (dict) .Values.spire.postgres -}}
{{- $cnpgClusterName := default "cnpg" $pg.clusterName -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: serviceradar-db-event-writer-config
data:
  db-event-writer.json: |
    {
      "listen_addr": "0.0.0.0:50041",
      "nats_url": "tls://serviceradar-nats:4222",
      "partition": "k8s",
      "stream_name": "events",
      "consumer_name": "db-event-writer",
      "agent_id": "k8s-db-event-writer",
      "poller_id": "k8s-poller",
      "streams": [
        { "subject": "events.poller.health", "table": "events" },
        { "subject": "events.syslog.processed", "table": "events" },
        { "subject": "events.snmp.processed", "table": "events" },
        { "subject": "events.otel.logs", "table": "logs" },
        { "subject": "events.otel.traces", "table": "otel_traces" },
        { "subject": "events.otel.metrics", "table": "otel_metrics" },
        { "subject": "events.otel.metrics.raw", "table": "otel_metrics" }
      ],
      "cnpg": {
        "host": "{{ $cnpgClusterName }}-rw.{{ .Release.Namespace }}.svc.cluster.local",
        "port": 5432,
        "database": {{ default "serviceradar" .Values.cnpg.database | quote }},
        "username": {{ default "serviceradar" .Values.cnpg.username | quote }},
        "password": "",
        "ssl_mode": "verify-full",
        "cert_dir": {{ default "/etc/serviceradar/certs" $cnpg.certDir | quote }},
        "tls": {
          "cert_file": "/etc/serviceradar/certs/db-event-writer.pem",
          "key_file": "/etc/serviceradar/certs/db-event-writer-key.pem",
          "ca_file": {{ default "/etc/serviceradar/cnpg/ca.crt" $cnpg.caFile | quote }}
        }
      },
      "security": {
        "mode": "spiffe",
        "cert_dir": "/etc/serviceradar/certs",
        "role": "core",
        "trust_domain": "{{$trustDomain}}",
        "workload_socket": "unix:/run/spire/sockets/agent.sock",
        "tls": {
          "cert_file": "/etc/serviceradar/certs/db-event-writer.pem",
          "key_file": "/etc/serviceradar/certs/db-event-writer-key.pem",
          "ca_file": "/etc/serviceradar/certs/root.pem"
        }
      },
      "nats_security": {
        "mode": "mtls",
        "cert_dir": "/etc/serviceradar/certs",
        "server_name": "nats.serviceradar",
        "role": "client",
        "tls": {
          "cert_file": "/etc/serviceradar/certs/db-event-writer.pem",
          "key_file": "/etc/serviceradar/certs/db-event-writer-key.pem",
          "ca_file": "/etc/serviceradar/certs/root.pem"
        }
      },
      "logging": {
        "level": "info",
        "debug": false,
        "output": "stdout",
        "time_format": "",
        "otel": {
          "enabled": true,
          "endpoint": "serviceradar-otel:4317",
          "service_name": "serviceradar-db-event-writer",
          "batch_timeout": "5s",
          "insecure": false,
          "headers": {},
          "tls": {
            "cert_file": "/etc/serviceradar/certs/db-event-writer.pem",
            "key_file": "/etc/serviceradar/certs/db-event-writer-key.pem",
            "ca_file": "/etc/serviceradar/certs/root.pem"
          }
        }
      }
    }
