{{- if .Values.agentElx.enabled }}
{{- $ns := default .Release.Namespace .Values.agentElx.namespace }}
{{- $trustDomain := default "serviceradar.local" .Values.spiffe.trustDomain }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: serviceradar-agent-elx
  labels:
    app: serviceradar-agent-elx
    app.kubernetes.io/component: agent-elx
    app.kubernetes.io/part-of: serviceradar
spec:
  replicas: {{ default 1 .Values.agentElx.replicas }}
  selector:
    matchLabels:
      app: serviceradar-agent-elx
  template:
    metadata:
      labels:
        app: serviceradar-agent-elx
        app.kubernetes.io/component: agent-elx
    spec:
      serviceAccountName: {{ default "serviceradar-agent-elx" .Values.agentElx.serviceAccount }}
      {{- include "serviceradar.imagePullSecrets" . | nindent 6 }}
      containers:
      - name: agent-elx
        image: ghcr.io/carverauto/serviceradar-agent-elx:{{ include "serviceradar.imageTag" (dict "Values" .Values "service" "agent-elx") }}
        imagePullPolicy: {{ include "serviceradar.imagePullPolicy" . }}
        ports:
        - name: epmd
          containerPort: 4369
          protocol: TCP
        - name: erts-range
          containerPort: 9100
          protocol: TCP
        env:
        # Agent identification
        - name: AGENT_PARTITION_ID
          value: {{ default "default" .Values.agentElx.partitionId | quote }}
        - name: AGENT_ID
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: AGENT_CAPABILITIES
          value: {{ default "disk,process,ping" .Values.agentElx.capabilities | quote }}

        # External checkers (gRPC)
        - name: CHECKER_SNMP_ADDR
          value: {{ default "localhost:50052" .Values.agentElx.checkerSnmpAddr | quote }}
        - name: CHECKER_WMI_ADDR
          value: {{ default "localhost:50053" .Values.agentElx.checkerWmiAddr | quote }}
        - name: CHECKER_SWEEP_ADDR
          value: {{ default "localhost:50054" .Values.agentElx.checkerSweepAddr | quote }}

        # Cluster configuration
        - name: CLUSTER_ENABLED
          value: "true"
        - name: CLUSTER_STRATEGY
          value: {{ default "kubernetes" .Values.agentElx.clusterStrategy | quote }}
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: KUBERNETES_SELECTOR
          value: {{ default "app=serviceradar" .Values.agentElx.kubernetesSelector | quote }}
        - name: KUBERNETES_NODE_BASENAME
          value: {{ default "serviceradar" .Values.agentElx.nodeBasename | quote }}
        - name: CLUSTER_CORE_SERVICE
          value: {{ default "serviceradar-core-elx-headless" .Values.agentElx.coreService | quote }}

        # SPIFFE/mTLS configuration
        - name: SPIFFE_MODE
          value: {{ default "filesystem" .Values.spiffe.mode | quote }}
        - name: SPIFFE_TRUST_DOMAIN
          value: {{ $trustDomain | quote }}
        - name: SPIFFE_CERT_DIR
          value: "/etc/serviceradar/certs"

        # Erlang cookie (shared across cluster)
        - name: ERLANG_COOKIE
          valueFrom:
            secretKeyRef:
              name: {{ default "serviceradar-secrets" .Values.agentElx.cookieSecret }}
              key: {{ default "erlang-cookie" .Values.agentElx.cookieSecretKey }}

        # Release configuration
        - name: RELEASE_DISTRIBUTION
          value: "name"
        - name: RELEASE_NODE
          value: "agent@$(POD_IP)"
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP

        volumeMounts:
        - name: cert-data
          mountPath: /etc/serviceradar/certs
          readOnly: true
        - name: spire-agent-socket
          mountPath: /run/spire/sockets
          readOnly: true

        resources:
          limits:
            cpu: {{ default "200m" .Values.agentElx.resources.limits.cpu }}
            memory: {{ default "256Mi" .Values.agentElx.resources.limits.memory }}
          requests:
            cpu: {{ default "50m" .Values.agentElx.resources.requests.cpu }}
            memory: {{ default "128Mi" .Values.agentElx.resources.requests.memory }}

        livenessProbe:
          exec:
            command:
            - bin/serviceradar_agent
            - pid
          initialDelaySeconds: 30
          periodSeconds: 30
          timeoutSeconds: 5
          failureThreshold: 3

        readinessProbe:
          exec:
            command:
            - bin/serviceradar_agent
            - pid
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 3

      volumes:
      - name: cert-data
        secret:
          secretName: {{ default "serviceradar-certs" .Values.agentElx.certSecret }}
      - name: spire-agent-socket
        hostPath:
          path: {{ include "serviceradar.spireSocketHostPath" . | quote }}
          type: DirectoryOrCreate

---
apiVersion: v1
kind: Service
metadata:
  name: serviceradar-agent-elx-headless
  labels:
    app: serviceradar-agent-elx
    app.kubernetes.io/component: agent-elx
spec:
  clusterIP: None
  selector:
    app: serviceradar-agent-elx
  ports:
  - name: epmd
    port: 4369
    targetPort: 4369
  - name: erts
    port: 9100
    targetPort: 9100

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ default "serviceradar-agent-elx" .Values.agentElx.serviceAccount }}
  labels:
    app.kubernetes.io/part-of: serviceradar
    app.kubernetes.io/component: agent-elx
{{- end }}
