{{- if and .Values.spire.enabled .Values.spire.postgres.enabled }}
{{- $ns := default .Release.Namespace .Values.spire.namespace }}
{{- $pg := .Values.spire.postgres }}
{{- $imageName := $pg.imageName }}
{{- if not $imageName }}
  {{- $imageRepo := default "ghcr.io/carverauto/serviceradar-cnpg" $pg.image }}
  {{- $imageTag := default "latest" $pg.imageTag }}
  {{- $imageName = printf "%s:%s" $imageRepo $imageTag }}
{{- end }}
{{- $postInitSQL := default (list "CREATE EXTENSION IF NOT EXISTS timescaledb;" "CREATE EXTENSION IF NOT EXISTS age;") $pg.extensionsSQL }}
{{- $sharedPreload := $pg.sharedPreloadLibraries }}
{{- if not $sharedPreload }}
  {{- $sharedPreload = list "timescaledb" "age" }}
{{- else if kindIs "string" $sharedPreload }}
  {{- $trimmed := list }}
  {{- range $item := splitList "," $sharedPreload }}
    {{- if $item }}
      {{- $trimmed = append $trimmed (trim $item) }}
    {{- end }}
  {{- end }}
  {{- $sharedPreload = $trimmed }}
{{- end }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $pg.secretName }}
  namespace: {{ $ns }}
type: Opaque
stringData:
  username: {{ default "spire" $pg.username }}
  password: {{ default "changeme" $pg.password | quote }}
---
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: {{ default "cnpg" $pg.clusterName }}
  namespace: {{ $ns }}
spec:
  imageName: {{ $imageName }}
  instances: {{ default 3 $pg.instances }}
  {{- if $pg.imagePullSecrets }}
  imagePullSecrets:
    {{- range $secret := $pg.imagePullSecrets }}
    {{- if kindIs "string" $secret }}
    - name: {{ $secret }}
    {{- else }}
    - name: {{ $secret.name }}
    {{- end }}
    {{- end }}
  {{- end }}
  storage:
    size: {{ default "5Gi" $pg.storageSize }}
    {{- if $pg.storageClass }}
    storageClass: {{ $pg.storageClass }}
    {{- end }}
  bootstrap:
    initdb:
      database: {{ default "spire" $pg.database }}
      owner: {{ default "spire" $pg.username }}
      secret:
        name: {{ $pg.secretName }}
      {{- if $postInitSQL }}
      postInitApplicationSQL:
        {{- range $stmt := $postInitSQL }}
        - {{ $stmt | quote }}
        {{- end }}
      {{- end }}
  postgresql:
    {{- if $sharedPreload }}
    shared_preload_libraries:
      {{- range $lib := $sharedPreload }}
      - {{ $lib | quote }}
      {{- end }}
    {{- end }}
  managed:
    roles:
      - name: {{ default "spire" $pg.username }}
        ensure: present
        login: true
        passwordSecret:
          name: {{ $pg.secretName }}
  monitoring:
    enablePodMonitor: true
{{- end }}
