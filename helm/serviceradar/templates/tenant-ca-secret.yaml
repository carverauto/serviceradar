{{- /*
  Per-tenant CA secrets for edge component certificate signing.

  Each tenant can have:
  1. Inline CA data (for development/simple deployments)
  2. External secrets reference (for production with Vault/ESO)

  Usage in values.yaml:

  tenants:
    acme-corp:
      ca:
        # Option 1: Inline CA data
        certificate: |
          -----BEGIN CERTIFICATE-----
          ...
        privateKey: |
          -----BEGIN RSA PRIVATE KEY-----
          ...

        # Option 2: External secret reference (ExternalSecret CRD)
        externalSecretRef:
          name: tenant-acme-corp-ca
          key: certificate
          keyPrivate: private_key
*/}}

{{- if .Values.tenants }}
{{- range $slug, $tenant := .Values.tenants }}
{{- if $tenant.ca }}
{{- if not $tenant.ca.externalSecretRef }}
---
apiVersion: v1
kind: Secret
metadata:
  name: tenant-{{ $slug }}-ca
  labels:
    app.kubernetes.io/name: serviceradar
    app.kubernetes.io/component: tenant-ca
    serviceradar.io/tenant: {{ $slug }}
type: kubernetes.io/tls
data:
  {{- if $tenant.ca.certificate }}
  tls.crt: {{ $tenant.ca.certificate | b64enc }}
  {{- end }}
  {{- if $tenant.ca.privateKey }}
  tls.key: {{ $tenant.ca.privateKey | b64enc }}
  {{- end }}
  {{- if $tenant.ca.chain }}
  ca-chain.pem: {{ $tenant.ca.chain | b64enc }}
  {{- end }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}
