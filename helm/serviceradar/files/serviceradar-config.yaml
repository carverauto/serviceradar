{{- $lb := "{{" -}}
{{- $rb := "}}" -}}
{{- $trustDomain := .Values.spire.trustDomain | default "carverauto.dev" -}}
{{- $spireNamespace := default .Release.Namespace .Values.spire.namespace -}}
{{- $datasvcSA := .Values.spire.datasvcServiceAccount | default "serviceradar-datasvc" -}}
{{- $agentVals := default (dict) .Values.agent -}}
{{- $agentSA := default "serviceradar-agent" $agentVals.serviceAccount -}}
{{- $otelSA := .Values.spire.otelServiceAccount | default "serviceradar-otel" -}}
{{- $syncSA := .Values.spire.syncServiceAccount | default "serviceradar-sync" -}}
{{- $zenSA := .Values.spire.zenServiceAccount | default "serviceradar-zen" -}}
{{- $mapperSA := .Values.spire.mapperServiceAccount | default "serviceradar-mapper" -}}
{{- $dbEventWriterSA := .Values.spire.dbEventWriterServiceAccount | default "serviceradar-db-event-writer" -}}
{{- $snmpCheckerSA := .Values.spire.snmpCheckerServiceAccount | default "serviceradar-snmp-checker" -}}
{{- $rperfCheckerSA := .Values.spire.rperfCheckerServiceAccount | default "serviceradar-rperf-checker" -}}
{{- $flowggerSA := .Values.spire.flowggerServiceAccount | default "serviceradar-flowgger" -}}
{{- $trapdSA := .Values.spire.trapdServiceAccount | default "serviceradar-trapd" -}}
{{- $serverVals := default (dict) .Values.spire.server -}}
{{- $spireServerService := default "spire-server" $serverVals.serviceName -}}
# base/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: serviceradar-config
data:
  
  core.json: |
    {
      "listen_addr": ":8090",
      "grpc_addr": ":50052",
      "api_key": "",
      "cnpg": {
        "host": "{{ default (printf "cnpg-rw.%s.svc.cluster.local" .Release.Namespace) .Values.cnpg.host }}",
        "port": {{ default 5432 .Values.cnpg.port }},
        "database": "{{ default "serviceradar" .Values.cnpg.database }}",
        "username": "{{ default "serviceradar" .Values.cnpg.username }}",
        "password": "",
        "application_name": "serviceradar-core",
        "ssl_mode": "verify-full",
        "cert_dir": "/etc/serviceradar/certs",
        "max_connections": 50,
        "min_connections": 5,
        "statement_timeout": "30s",
        "tls": {
          "cert_file": "/etc/serviceradar/certs/core.pem",
          "key_file": "/etc/serviceradar/certs/core-key.pem",
          "ca_file": "/etc/serviceradar/cnpg/ca.crt"
        }
      },
      "reaper": {
        "interval": "{{ .Values.core.reaper.interval | default "1h" }}",
        "ttl": "{{ .Values.core.reaper.ttl | default "24h" }}"
      },
      "identity_reconciliation": {
        "enabled": {{ default false .Values.core.identity.enabled }},
        "sightings_only_mode": {{ default false .Values.core.identity.sightingsOnlyMode }},
        "promotion": {
          "enabled": {{ default false .Values.core.identity.promotion.enabled }},
          "shadow_mode": {{ default true .Values.core.identity.promotion.shadowMode }},
          "min_persistence": "{{ default "24h" .Values.core.identity.promotion.minPersistence }}",
          "require_hostname": {{ default false .Values.core.identity.promotion.requireHostname }},
          "require_fingerprint": {{ default false .Values.core.identity.promotion.requireFingerprint }}
        },
        "fingerprinting": {
          "enabled": {{ default false .Values.core.identity.fingerprinting.enabled }},
          "port_budget": {{ default 32 .Values.core.identity.fingerprinting.portBudget }},
          "timeout": "{{ default "2s" .Values.core.identity.fingerprinting.timeout }}"
        },
        "reaper": {
          "interval": "{{ default "1h" .Values.core.identity.reaper.interval }}",
          "profiles": {
            "default": {
              "ttl": "{{ default "24h" .Values.core.identity.reaper.profiles.default.ttl }}"
            },
            "dynamic": {
              "ttl": "{{ default "6h" .Values.core.identity.reaper.profiles.dynamic.ttl }}"
            },
            "guest": {
              "ttl": "{{ default "1h" .Values.core.identity.reaper.profiles.guest.ttl }}"
            },
            "static": {
              "ttl": "{{ default "72h" .Values.core.identity.reaper.profiles.static.ttl }}",
              "allow_ip_as_id": {{ default true .Values.core.identity.reaper.profiles.static.allowIPAsID }}
            }
          }
        }
      },
      "alert_threshold": "5m",
      "known_pollers": [
        "k8s-poller",
        "docker-poller"
      ],
      "metrics": {
        "enabled": true,
        "retention": 100,
        "max_pollers": 10000
      },
      "features": {
        "use_log_digest": true,
        "use_device_search_planner": true,
        "require_device_registry": true
      },
      "srql": {
        "enabled": true,
        "base_url": "http://serviceradar-srql:8080",
        "api_key": "",
        "timeout": "15s",
        "path": "/api/query"
      },
      "security": {
        "mode": "spiffe",
        "cert_dir": "/etc/serviceradar/certs",
        "role": "core",
        "trust_domain": "{{$trustDomain}}",
        "server_spiffe_id": "spiffe://{{$trustDomain}}/ns/{{$spireNamespace}}/sa/serviceradar-core",
        "workload_socket": "unix:/run/spire/sockets/agent.sock",
        "tls": {
          "cert_file": "/etc/serviceradar/certs/core.pem",
          "key_file": "/etc/serviceradar/certs/core-key.pem",
          "ca_file": "/etc/serviceradar/certs/root.pem",
          "client_ca_file": "/etc/serviceradar/certs/root.pem",
          "skip_verify": false
        }
      },
      "kv_security": {
        "mode": "spiffe",
        "cert_dir": "/etc/serviceradar/certs",
        "role": "core",
        "trust_domain": "{{$trustDomain}}",
        "server_spiffe_id": "spiffe://{{$trustDomain}}/ns/{{$spireNamespace}}/sa/serviceradar-datasvc",
        "workload_socket": "unix:/run/spire/sockets/agent.sock",
        "tls": {
          "cert_file": "/etc/serviceradar/certs/core.pem",
          "key_file": "/etc/serviceradar/certs/core-key.pem",
          "ca_file": "/etc/serviceradar/certs/root.pem"
        }
      },
      "spire_admin": {
        "enabled": true,
        "server_address": "spire-server.{{$spireNamespace}}.svc.cluster.local:8081",
        "server_spiffe_id": "spiffe://{{$trustDomain}}/spire/server",
        "workload_socket": "unix:/run/spire/sockets/agent.sock",
        "join_token_ttl": "15m"
      },
      "edge_onboarding": {
        "enabled": true,
        "encryption_key": "{{ default "" .Values.secrets.edgeOnboardingKey }}",
        "default_selectors": [
          "unix:uid:0",
          "unix:gid:0",
          "unix:user:root",
          "unix:group:root"
        ],
        "default_metadata": {
          "poller": {
            "core_address": "{{ include "serviceradar.coreAddress" . }}",
            "core_spiffe_id": "spiffe://{{$trustDomain}}/ns/{{$spireNamespace}}/sa/serviceradar-core",
            "kv_address": "serviceradar-datasvc:50057",
            "kv_spiffe_id": "spiffe://{{$trustDomain}}/ns/{{$spireNamespace}}/sa/serviceradar-datasvc",
            "spire_upstream_address": "spire-server.{{$spireNamespace}}.svc.cluster.local",
            "spire_upstream_port": "8081",
            "spire_parent_id": "spiffe://{{$trustDomain}}/ns/edge/poller-nested-spire",
            "agent_address": "agent:50051",
            "agent_spiffe_id": "spiffe://{{$trustDomain}}/services/agent",
            "nested_spire_wait_attempts": "120",
            "log_level": "info",
            "logs_dir": "./logs"
          }
        },
        "join_token_ttl": "15m",
        "download_token_ttl": "10m",
        "poller_id_prefix": "edge"
      },
      "cors": {
        "allowed_origins": ["*"],
        "allow_credentials": true
      },
      "auth": {
        "jwt_secret": "PLACEHOLDER_WILL_BE_REPLACED",
        "jwt_expiration": "24h",
        "local_users": {
          "admin": "PLACEHOLDER_BCRYPT_HASH_WILL_BE_REPLACED"
        },
        "rbac": {
          "user_roles": {
            "admin": ["admin", "operator", "viewer"],
            "operator": ["operator", "viewer"],
            "user": ["viewer"]
          },
          "role_permissions": {
            "admin": ["*"],
            "operator": ["config:read", "config:write", "device:*", "alert:*"],
            "viewer": ["config:read", "device:read", "alert:read", "metrics:read"]
          },
          "route_protection": {
            "/api/admin/*": ["admin"],
            "/api/config/*": {
              "GET": ["viewer", "operator", "admin"],
              "POST": ["operator", "admin"],
              "PUT": ["operator", "admin"],
              "DELETE": ["admin"]
            },
            "/api/devices/*": {
              "GET": ["viewer", "operator", "admin"],
              "POST": ["operator", "admin"],
              "PUT": ["operator", "admin"],
              "DELETE": ["admin"]
            },
            "/api/alerts/*": {
              "GET": ["viewer", "operator", "admin"],
              "POST": ["operator", "admin"],
              "PUT": ["operator", "admin"],
              "DELETE": ["admin"]
            }
          }
        }
      },
      "nats": {
        "url": "tls://serviceradar-nats:4222",
        "max_reconnects": 10,
        "reconnect_wait": "2s",
        "drain_timeout": "30s",
        "security": {
          "mode": "mtls",
          "tls": {
            "cert_file": "/etc/serviceradar/certs/core.pem",
            "key_file": "/etc/serviceradar/certs/core-key.pem",
            "ca_file": "/etc/serviceradar/certs/root.pem"
          }
        }
      },
      "events": {
        "enabled": true,
        "stream_name": "events",
        "subjects": ["events.>", "snmp.traps"]
      },
      "snmp": {
        "enabled": false,
        "listen_addr": ":161",
        "community": "public",
        "timeout": "5s",
        "retries": 3
      },
      "write_buffer": {
        "size": 10000,
        "flush_interval": "5s",
        "max_retries": 3,
        "retry_delay": "1s"
      },
      "logging": {
        "level": "info",
        "debug": false,
        "output": "stdout",
        "time_format": "",
        "otel": {
          "enabled": true,
          "endpoint": "serviceradar-otel:4317",
          "service_name": "serviceradar-core",
          "batch_timeout": "5s",
          "insecure": false,
          "headers": {},
          "tls": {
            "cert_file": "/etc/serviceradar/certs/core.pem",
            "key_file": "/etc/serviceradar/certs/core-key.pem",
            "ca_file": "/etc/serviceradar/certs/root.pem",
            "server_name": "serviceradar-otel",
            "skip_verify": false
          }
        }
      },
      "webhooks": [
        {
          "enabled": false,
          "url": "https://your-webhook-url",
          "cooldown": "15m",
          "headers": [
            {
              "key": "Authorization",
              "value": "Bearer your-token"
            }
          ]
        },
        {
          "enabled": false,
          "url": "https://discord.com/api/webhooks/PLACEHOLDER_WEBHOOK_URL",
          "cooldown": "15m",
          "template": "{\"embeds\":[{\"title\":\"{{$lb}}.alert.Title{{$rb}}\",\"description\":\"{{$lb}}.alert.Message{{$rb}}\",\"color\":{{$lb}}if eq .alert.Level \\\"error\\\"{{$rb}}15158332{{$lb}}else if eq .alert.Level \\\"warning\\\"{{$rb}}16776960{{$lb}}else{{$rb}}3447003{{$lb}}end{{$rb}},\"timestamp\":\"{{$lb}}.alert.Timestamp{{$rb}}\",\"fields\":[{\"name\":\"Node ID\",\"value\":\"{{$lb}}.alert.NodeID{{$rb}}\",\"inline\":true}{{$lb}}range $key, $value := .alert.Details{{$rb}}, {\"name\":\"{{$lb}}$key{{$rb}}\",\"value\":\"{{$lb}}$value{{$rb}}\",\"inline\":true}{{$lb}}end{{$rb}}]}]}"
        }
      ]
    }
  
  poller.json: |
      {
        "agents": {
          "k8s-agent": {
              "address": "serviceradar-agent:50051",
              "security": {
                "mode": "spiffe",
                "cert_dir": "/etc/serviceradar/certs",
                "role": "poller",
                "trust_domain": "{{$trustDomain}}",
                "server_spiffe_id": "spiffe://{{$trustDomain}}/ns/{{$spireNamespace}}/sa/{{$agentSA}}",
                "workload_socket": "unix:/run/spire/sockets/agent.sock",
                "tls": {
                  "cert_file": "poller.pem",
                  "key_file": "poller-key.pem",
                  "ca_file": "root.pem",
                  "client_ca_file": "root.pem"
                }
              },
              "checks": [
              {
                "service_type": "port",
                "service_name": "SSH",
                "details": "serviceradar-agent:22"
              },
              {
                "service_type": "icmp",
                "service_name": "ping",
                "details": "8.8.8.8"
              },
              {
                "service_type": "sweep",
                "service_name": "network_sweep",
                "details": "",
                "results_interval": "2m"
              },
              {
                "service_type": "grpc",
                "service_name": "sync",
                "results_interval": "5m"
              }
            ]
          }
        },
        "core_address": "{{ include "serviceradar.coreAddress" . }}",
        "core_security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "role": "poller",
          "trust_domain": "{{$trustDomain}}",
          "server_spiffe_id": "spiffe://{{$trustDomain}}/ns/{{$spireNamespace}}/sa/serviceradar-core",
          "workload_socket": "unix:/run/spire/sockets/agent.sock",
          "tls": {
            "cert_file": "poller.pem",
            "key_file": "poller-key.pem",
            "ca_file": "root.pem"
          }
        },
        "listen_addr": ":50053",
        "poll_interval": "30s",
        "poller_id": "k8s-poller",
        "partition": "default",
        "source_ip": "poller",
        "service_name": "PollerService",
        "service_type": "grpc",
        "security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "role": "poller",
          "trust_domain": "{{$trustDomain}}",
          "server_spiffe_id": "spiffe://{{$trustDomain}}/ns/{{$spireNamespace}}/sa/serviceradar-core",
          "workload_socket": "unix:/run/spire/sockets/agent.sock",
          "tls": {
            "cert_file": "poller.pem",
            "key_file": "poller-key.pem",
            "ca_file": "root.pem",
            "client_ca_file": "root.pem"
          }
        },
        "logging": {
          "level": "info",
          "debug": false,
          "output": "stdout",
          "time_format": "",
          "otel": {
            "enabled": true,
            "endpoint": "serviceradar-otel:4317",
            "service_name": "serviceradar-poller",
            "batch_timeout": "5s",
            "insecure": false,
            "headers": {
              "x-api-key": "your-collector-api-key"
            },
            "tls": {
              "cert_file": "/etc/serviceradar/certs/poller.pem",
              "key_file": "/etc/serviceradar/certs/poller-key.pem",
              "ca_file": "/etc/serviceradar/certs/root.pem",
              "server_name": "serviceradar-otel"
            }
          }
        }
      }
  
  agent.json: |
      {
        "checkers_dir": "/etc/serviceradar/checkers",
        "listen_addr": ":50051",
        "service_type": "grpc",
        "service_name": "AgentService",
        "agent_id": "k8s-agent",
        "agent_name": "agent",
        "host_ip": "agent",
        "partition": "default",
        "kv_address": "serviceradar-datasvc:50057",
        "kv_security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "role": "agent",
          "trust_domain": "{{$trustDomain}}",
          "server_spiffe_id": "spiffe://{{$trustDomain}}/ns/{{$spireNamespace}}/sa/{{$datasvcSA}}",
          "workload_socket": "unix:/run/spire/sockets/agent.sock",
          "tls": {
            "cert_file": "agent.pem",
            "key_file": "agent-key.pem",
            "ca_file": "root.pem"
          }
        },
        "security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "role": "agent",
          "trust_domain": "{{$trustDomain}}",
          "server_spiffe_id": "spiffe://{{$trustDomain}}/ns/{{$spireNamespace}}/sa/{{$agentSA}}",
          "workload_socket": "unix:/run/spire/sockets/agent.sock",
          "tls": {
            "cert_file": "agent.pem",
            "key_file": "agent-key.pem",
            "ca_file": "root.pem",
            "client_ca_file": "root.pem"
          }
        },
        "logging": {
          "level": "info",
          "debug": false,
          "output": "stdout",
          "time_format": "",
          "otel": {
            "enabled": false
          }
        }
      }
  
  sweep.json: |
      {
        "networks": {{ (.Values.sweep.networks | default (list "192.168.2.0/24" "192.168.3.1/32")) | toJson }},
        "ports": {{ (.Values.sweep.ports | default (list 22 80 443 3306 5432 6379 8080 8443)) | toJson }},
        "sweep_modes": {{ (.Values.sweep.modes | default (list "icmp" "tcp")) | toJson }},
        "interval": "{{ .Values.sweep.interval | default "5m" }}",
        "concurrency": {{ .Values.sweep.concurrency | default 100 }},
        "timeout": "{{ .Values.sweep.timeout | default "10s" }}",
        "tcp_settings": {
          "rate_limit": {{ .Values.sweep.tcp.rateLimit | default 20000 }},
          "rate_limit_burst": {{ .Values.sweep.tcp.rateLimitBurst | default 20000 }},
          "max_batch": {{ .Values.sweep.tcp.maxBatch | default 32 }},
          "concurrency": {{ .Values.sweep.tcp.concurrency | default 256 }},
          "timeout": "{{ .Values.sweep.tcp.timeout | default "3s" }}",
          "route_discovery_host": "{{ .Values.sweep.tcp.routeDiscoveryHost | default "8.8.8.8:80" }}",
          "ring_block_size": {{ .Values.sweep.tcp.ringBlockSize | default 0 }},
          "ring_block_count": {{ .Values.sweep.tcp.ringBlockCount | default 0 }},
          "interface": "{{ .Values.sweep.tcp.interface | default "" }}",
          "suppress_rst_reply": {{ .Values.sweep.tcp.suppressRSTReply | default false }},
          "global_ring_memory_mb": {{ .Values.sweep.tcp.globalRingMemoryMB | default 0 }},
          "ring_readers": {{ .Values.sweep.tcp.ringReaders | default 0 }},
          "ring_poll_timeout_ms": {{ .Values.sweep.tcp.ringPollTimeoutMs | default 0 }}
        },
        "high_perf_icmp": {{ .Values.sweep.icmp.highPerf | default true }},
        "icmp_rate_limit": {{ .Values.sweep.icmp.rateLimit | default 5000 }},
        "icmp_settings": {
          "rate_limit": {{ .Values.sweep.icmp.settings.rateLimit | default 1000 }},
          "timeout": "{{ .Values.sweep.icmp.settings.timeout | default "5s" }}",
          "max_batch": {{ .Values.sweep.icmp.settings.maxBatch | default 64 }}
        }
      } 
  
  external.json: |
      {
        "enabled": true
      }
  
  sync-checker.json: |
      {
        "name": "sync",
        "type": "grpc",
        "address": "serviceradar-sync:50058",
        "security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "role": "poller",
          "trust_domain": "{{$trustDomain}}",
          "server_spiffe_id": "spiffe://{{$trustDomain}}/ns/{{$spireNamespace}}/sa/{{$syncSA}}",
          "workload_socket": "unix:/run/spire/sockets/agent.sock",
          "tls": {
            "cert_file": "agent.pem",
            "key_file": "agent-key.pem",
            "ca_file": "root.pem",
            "client_ca_file": "root.pem"
          }
        }
      }
  
  mapper-checker.json: |
      {
        "name": "mapper",
        "type": "grpc",
        "address": "serviceradar-mapper:50056",
        "security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "role": "poller",
          "trust_domain": "{{$trustDomain}}",
          "server_spiffe_id": "spiffe://{{$trustDomain}}/ns/{{$spireNamespace}}/sa/{{$mapperSA}}",
          "workload_socket": "unix:/run/spire/sockets/agent.sock",
          "tls": {
            "cert_file": "agent.pem",
            "key_file": "agent-key.pem",
            "ca_file": "root.pem",
            "client_ca_file": "root.pem"
          }
        }
      }
  
  rperf-checker.json: |
      {
        "name": "rperf-checker",
        "type": "grpc",
        "address": "serviceradar-rperf:50081",
        "security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "role": "poller",
          "trust_domain": "{{$trustDomain}}",
          "server_spiffe_id": "spiffe://{{$trustDomain}}/ns/{{$spireNamespace}}/sa/{{$rperfCheckerSA}}",
          "workload_socket": "unix:/run/spire/sockets/agent.sock",
          "tls": {
            "cert_file": "agent.pem",
            "key_file": "agent-key.pem",
            "ca_file": "root.pem",
            "client_ca_file": "root.pem"
          }
        }
      }
  
  zen-checker.json: |
      {
        "name": "zen",
        "type": "grpc",
        "address": "serviceradar-zen:50040",
        "security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "role": "poller",
          "trust_domain": "{{$trustDomain}}",
          "server_spiffe_id": "spiffe://{{$trustDomain}}/ns/{{$spireNamespace}}/sa/{{$zenSA}}",
          "workload_socket": "unix:/run/spire/sockets/agent.sock",
          "tls": {
            "cert_file": "agent.pem",
            "key_file": "agent-key.pem",
            "ca_file": "root.pem",
            "client_ca_file": "root.pem"
          }
        }
      }
  
  db-event-writer-checker.json: |
      {
        "name": "db-event-writer",
        "type": "grpc",
        "address": "serviceradar-db-event-writer:50041",
        "security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "role": "poller",
          "trust_domain": "{{$trustDomain}}",
          "server_spiffe_id": "spiffe://{{$trustDomain}}/ns/{{$spireNamespace}}/sa/{{$dbEventWriterSA}}",
          "workload_socket": "unix:/run/spire/sockets/agent.sock",
          "tls": {
            "cert_file": "agent.pem",
            "key_file": "agent-key.pem",
            "ca_file": "root.pem",
            "client_ca_file": "root.pem"
          }
        }
      }
  
  trapd-checker.json: |
      {
        "name": "trapd",
        "type": "grpc",
        "address": "serviceradar-trapd:50043",
        "security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "role": "poller",
          "trust_domain": "{{$trustDomain}}",
          "server_spiffe_id": "spiffe://{{$trustDomain}}/ns/{{$spireNamespace}}/sa/{{$trapdSA}}",
          "workload_socket": "unix:/run/spire/sockets/agent.sock",
          "tls": {
            "cert_file": "agent.pem",
            "key_file": "agent-key.pem",
            "ca_file": "root.pem",
            "client_ca_file": "root.pem"
          }
        }
      }
  
  flowgger-checker.json: |
      {
        "name": "flowgger",
        "type": "grpc",
        "address": "serviceradar-flowgger:50044",
        "security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "role": "poller",
          "trust_domain": "{{$trustDomain}}",
          "server_spiffe_id": "spiffe://{{$trustDomain}}/ns/{{$spireNamespace}}/sa/{{$flowggerSA}}",
          "workload_socket": "unix:/run/spire/sockets/agent.sock",
          "tls": {
            "cert_file": "agent.pem",
            "key_file": "agent-key.pem",
            "ca_file": "root.pem",
            "client_ca_file": "root.pem"
          }
        }
      }
  
  zen.json: |
      {
        "nats_url": "tls://serviceradar-nats:4222",
        "stream_name": "events",
        "consumer_name": "zen-consumer",
        "subjects": ["events.syslog", "events.snmp", "events.otel.logs"],
        "decision_groups": [
          {
            "name": "syslog",
            "subjects": ["events.syslog"],
            "rules": [
              {"order": 1, "key": "strip_full_message"},
              {"order": 2, "key": "cef_severity"}
            ],
            "format": "json"
          },
          {
            "name": "snmp",
            "subjects": ["events.snmp"],
            "rules": [
              {"order": 1, "key": "snmp_severity"}
            ],
            "format": "json"
          },
          {
            "name": "otel_logs",
            "subjects": ["events.otel.logs"],
            "rules": [
              {"order": 1, "key": "passthrough"}
            ],
            "format": "protobuf"
          }
        ],
        "agent_id": "k8s-zen-consumer",
        "kv_address": "serviceradar-datasvc:50057",
        "kv_bucket": "serviceradar-datasvc",
        "listen_addr": "0.0.0.0:50040",
        "result_subject_suffix": ".processed",
        "security": {
          "cert_file": "/etc/serviceradar/certs/zen.pem",
          "key_file": "/etc/serviceradar/certs/zen-key.pem",
          "ca_file": "/etc/serviceradar/certs/root.pem"
        },
        "grpc_security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "role": "zen",
          "trust_domain": "{{$trustDomain}}",
          "workload_socket": "unix:/run/spire/sockets/agent.sock"
        },
        "kv_security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "role": "zen",
          "trust_domain": "{{$trustDomain}}",
          "server_spiffe_id": "spiffe://{{$trustDomain}}/ns/{{$spireNamespace}}/sa/{{$datasvcSA}}",
          "workload_socket": "unix:/run/spire/sockets/agent.sock",
          "tls": {
            "cert_file": "zen.pem",
            "key_file": "zen-key.pem",
            "ca_file": "root.pem"
          }
        },
        "logging": {
          "level": "info",
          "debug": false,
          "output": "stdout",
          "time_format": "",
          "otel": {
            "enabled": true,
            "endpoint": "serviceradar-otel:4317",
            "service_name": "serviceradar-zen",
            "batch_timeout": "5s",
            "insecure": false,
            "headers": {},
            "tls": {
              "cert_file": "/etc/serviceradar/certs/zen.pem",
              "key_file": "/etc/serviceradar/certs/zen-key.pem",
              "ca_file": "/etc/serviceradar/certs/root.pem",
              "server_name": "serviceradar-otel"
            }
          }
        }
      }
  
  snmp.json: |
      {
        "node_address": "localhost:50051",
        "listen_addr": ":50054",
        "partition": "k8s",
        "security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "role": "checker",
          "server_name": "serviceradar-snmp-checker",
          "trust_domain": "{{$trustDomain}}",
          "server_spiffe_id": "spiffe://{{$trustDomain}}/ns/{{$spireNamespace}}/sa/{{$snmpCheckerSA}}",
          "workload_socket": "unix:/run/spire/sockets/agent.sock"
        },
        "timeout": "30s",
        "targets": [
          {
            "name": "test-router",
            "host": "192.168.1.1",
            "port": 161,
            "community": "public",
            "version": "v2c",
            "interval": "30s",
            "retries": 2,
            "oids": [
              {
                "oid": ".1.3.6.1.2.1.2.2.1.10.4",
                "name": "ifInOctets_4",
                "type": "counter",
                "scale": 1.0
              }
            ]
          }
        ]
      }
  
  snmp-checker.json: |
      {
        "name": "snmp",
        "type": "grpc",
        "address": "serviceradar-snmp-checker:50054",
        "security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "role": "poller",
          "trust_domain": "{{$trustDomain}}",
          "server_spiffe_id": "spiffe://{{$trustDomain}}/ns/{{$spireNamespace}}/sa/{{$snmpCheckerSA}}",
          "workload_socket": "unix:/run/spire/sockets/agent.sock",
          "tls": {
            "cert_file": "agent.pem",
            "key_file": "agent-key.pem",
            "ca_file": "root.pem",
            "client_ca_file": "root.pem"
          }
        }
      }
  
  core-k8s-init.sh: |
      #!/bin/bash
      set -e
  
      echo "ðŸ”‘ Using API_KEY: ${API_KEY:0:8}... (${#API_KEY} chars)"
      echo "ðŸ” Using JWT_SECRET: ${JWT_SECRET:0:8}... (${#JWT_SECRET} chars)"
  
      TEMPLATE_PATH="/etc/serviceradar/core.json"
      CONFIG_PATH="${CONFIG_PATH:-/var/lib/serviceradar/core.json}"
      CONFIG_DIR=$(dirname "$CONFIG_PATH")
      mkdir -p "$CONFIG_DIR"
  
      if [ ! -f "$CONFIG_PATH" ]; then
          echo "Seeding runtime config from $TEMPLATE_PATH into $CONFIG_PATH"
          cp "$TEMPLATE_PATH" "$CONFIG_PATH"
      fi
  
      echo "Using runtime configuration at $CONFIG_PATH"
  
      EFFECTIVE_NAMESPACE="${KUBERNETES_NAMESPACE:-{{$spireNamespace}}}"
      CNPG_HOST_VALUE="${CNPG_HOST:-cnpg-rw.${EFFECTIVE_NAMESPACE}.svc.cluster.local}"
      CNPG_PORT_VALUE="${CNPG_PORT:-5432}"
      CNPG_DATABASE_VALUE="${CNPG_DATABASE:-serviceradar}"
      CNPG_USERNAME_VALUE="${CNPG_USERNAME:-postgres}"
      CNPG_SSLMODE_VALUE="${CNPG_SSLMODE:-verify-full}"
      CNPG_CERT_DIR_VALUE="${CNPG_CERT_DIR:-/etc/serviceradar/certs}"
      CNPG_CA_FILE_VALUE="${CNPG_CA_FILE:-/etc/serviceradar/cnpg/ca.crt}"
      EDGE_ONBOARDING_KEY_VALUE="${EDGE_ONBOARDING_ENCRYPTION_KEY:-}"
  
      if [ -z "$CNPG_PASSWORD" ]; then
          echo "Warning: CNPG_PASSWORD environment variable not found"
      else
          echo "Found CNPG password from Kubernetes secret"
      fi
  
      if [ -f "$CONFIG_PATH" ]; then
          TEMPLATE_SECURITY=$(jq -c '.security // empty' "$TEMPLATE_PATH")
          if [ -n "$TEMPLATE_SECURITY" ]; then
              echo "Synchronizing security block from template"
              TMP_CONFIG=$(mktemp)
              jq --argjson security "$TEMPLATE_SECURITY" '.security = $security' "$CONFIG_PATH" > "$TMP_CONFIG"
              mv "$TMP_CONFIG" "$CONFIG_PATH"
          fi
  
      echo "Updating configuration with secrets..."
      TMP_CONFIG=$(mktemp)
      jq --arg host "$CNPG_HOST_VALUE" \
         --arg port "$CNPG_PORT_VALUE" \
         --arg db "$CNPG_DATABASE_VALUE" \
         --arg user "$CNPG_USERNAME_VALUE" \
         --arg pwd "$CNPG_PASSWORD" \
         --arg ssl "$CNPG_SSLMODE_VALUE" \
         --arg certdir "$CNPG_CERT_DIR_VALUE" \
         --arg jwt "$JWT_SECRET" \
         --arg api_key "$API_KEY" \
         --arg bcrypt "$ADMIN_BCRYPT_HASH" \
         --arg edge_key "$EDGE_ONBOARDING_KEY_VALUE" \
         --arg ca_file "$CNPG_CA_FILE_VALUE" \
         '.cnpg.host = $host
          | .cnpg.port = ($port | tonumber)
          | .cnpg.database = $db
          | .cnpg.username = $user
          | .cnpg.password = $pwd
          | .cnpg.ssl_mode = $ssl
          | .cnpg.cert_dir = $certdir
          | .auth.jwt_secret = $jwt
          | .auth.jwt_expiration = "24h"
          | .auth.local_users.admin = $bcrypt
          | .api_key = $api_key
          | .cnpg.tls.ca_file = $ca_file
          | (if ($edge_key | length) > 0 then .edge_onboarding.encryption_key = $edge_key else . end)' \
        "$CONFIG_PATH" > "$TMP_CONFIG"
          mv "$TMP_CONFIG" "$CONFIG_PATH"
          echo "Configuration updated with secrets at $CONFIG_PATH"
  
          if ! jq -e '.auth.jwt_private_key_pem // empty' "$CONFIG_PATH" >/dev/null 2>&1; then
              echo "Warning: RS256 key material missing from $CONFIG_PATH; Core JWKS will be empty" >&2
          fi
      fi
  
      if [ "${WAIT_FOR_CNPG:-true}" = "true" ]; then
          echo "Waiting for CNPG at ${CNPG_HOST_VALUE}:${CNPG_PORT_VALUE}..."
          CNPG_READY=false
          for i in {1..30}; do
              if timeout 5 bash -lc "exec 3<>/dev/tcp/${CNPG_HOST_VALUE}/${CNPG_PORT_VALUE}" > /dev/null 2>&1; then
                  CNPG_READY=true
                  break
              fi
              echo "Waiting for CNPG... ($i/30)"
              sleep 2
          done
          if [ "$CNPG_READY" != "true" ]; then
              echo "Warning: CNPG endpoint did not respond after 30 attempts; proceeding anyway" >&2
          else
              echo "CNPG port is reachable."
          fi
      fi
  
      if [ "${INIT_DB:-false}" = "true" ]; then
          echo "Initializing database tables..."
      fi
  
      echo "ðŸ” Final environment check:"
      echo "  API_KEY: ${API_KEY:0:8}... (${#API_KEY} chars)"
      echo "  JWT_SECRET: ${JWT_SECRET:0:8}... (${#JWT_SECRET} chars)"
      echo "  AUTH_ENABLED: ${AUTH_ENABLED:-true}"
  
      exec /usr/local/bin/serviceradar-core --config="$CONFIG_PATH"
  nats.conf: |
      # NATS Server Configuration for ServiceRadar Kubernetes Deployment
      server_name: nats-serviceradar-k8s
  
      # Listen on all interfaces for Kubernetes networking
      listen: 0.0.0.0:4222
  
      # HTTP monitoring
      http: 0.0.0.0:8222
  
      # Enable JetStream for KV store
      jetstream {
        # Directory to store JetStream data
        store_dir: /data/jetstream
        # Maximum storage size
        max_memory_store: 1G
        # Maximum disk storage
        max_file_store: 10G
      }
  
      # Enable mTLS for secure communication
      tls {
        # Path to the server certificate
        cert_file: "/etc/serviceradar/certs/nats.pem"
        # Path to the server private key
        key_file: "/etc/serviceradar/certs/nats-key.pem"
        # Path to the root CA certificate for verifying clients
        ca_file: "/etc/serviceradar/certs/root.pem"
  
        # Require client certificates (enables mTLS)
        verify: true
        # Require and verify client certificates
        verify_and_map: true
      }
  
      # Account-based authorization for ServiceRadar components
      accounts {
        # System account with full privileges  
        SYS: {
          users: []
        }
        
        # ServiceRadar services account
        SERVICERADAR: {
          jetstream: enabled
          users: [
          {
            user: "CN=serviceradar-debug-client,OU=Kubernetes,O=ServiceRadar,L=San Francisco,ST=CA,C=US"
            permissions: {
              publish: {
                allow: [">"]
              }
              subscribe: {
                allow: [">"]
              }
            }
          },
          {
            user: "CN=serviceradar-core,OU=Kubernetes,O=ServiceRadar,L=San Francisco,ST=CA,C=US"
            permissions: {
              publish: {
                allow: [">"]
              }
              subscribe: {
                allow: [">"]
              }
            }
          },
          {
            user: "CN=serviceradar-datasvc,OU=Kubernetes,O=ServiceRadar,L=San Francisco,ST=CA,C=US"
            permissions: {
              publish: {
                allow: [">"]
              }
              subscribe: {
                allow: [">"]
              }
            }
          },
          {
            user: "CN=serviceradar-poller,OU=Kubernetes,O=ServiceRadar,L=San Francisco,ST=CA,C=US"
            permissions: {
              publish: {
                allow: [">"]
              }
              subscribe: {
                allow: [">"]
              }
            }
          },
          {
            user: "CN=serviceradar-agent,OU=Kubernetes,O=ServiceRadar,L=San Francisco,ST=CA,C=US"
            permissions: {
              publish: {
                allow: [">"]
              }
              subscribe: {
                allow: [">"]
              }
            }
          },
          {
            user: "CN=serviceradar-db-event-writer,OU=Kubernetes,O=ServiceRadar,L=San Francisco,ST=CA,C=US"
            permissions: {
              publish: {
                allow: [">"]
              }
              subscribe: {
                allow: [">"]
              }
            }
          },
          {
            user: "CN=serviceradar-zen,OU=Kubernetes,O=ServiceRadar,L=San Francisco,ST=CA,C=US"
            permissions: {
              publish: {
                allow: [">"]
              }
              subscribe: {
                allow: [">"]
              }
            }
          },
          {
            user: "CN=serviceradar-flowgger,OU=Kubernetes,O=ServiceRadar,L=San Francisco,ST=CA,C=US"
            permissions: {
              publish: {
                allow: ["events.syslog", "$JS.API.STREAM.INFO.events", "$JS.API.STREAM.CREATE.events", "$JS.API.>"]
              }
              subscribe: {
                allow: ["$JS.API.>", "_INBOX.>"]
              }
            }
          },
          {
            user: "CN=serviceradar-otel,OU=Kubernetes,O=ServiceRadar,L=San Francisco,ST=CA,C=US"
            permissions: {
              publish: {
                allow: ["events.otel.>", "$JS.API.>"]
              }
              subscribe: {
                allow: ["$JS.API.>", "_INBOX.>"]
              }
            }
          },
          {
            user: "CN=serviceradar-mapper,OU=Kubernetes,O=ServiceRadar,L=San Francisco,ST=CA,C=US"
            permissions: {
              publish: {
                allow: [">"]
              }
              subscribe: {
                allow: [">"]
              }
            }
          },
          {
            user: "CN=serviceradar-trapd,OU=Kubernetes,O=ServiceRadar,L=San Francisco,ST=CA,C=US"
            permissions: {
              publish: {
                allow: ["snmp.traps", "$JS.API.STREAM.INFO.events", "$JS.API.STREAM.CREATE.events", "$JS.API.>"]
              }
              subscribe: {
                allow: ["$JS.API.>", "_INBOX.>"]
              }
            }
          },
          {
            user: "O=ServiceRadar"
            permissions: {
              publish: {
                allow: [">"]
              }
              subscribe: {
                allow: [">"]
              }
            }
          }
          ]
        }
      }
      
      # Set system account
      system_account: "SYS"
  
      # Logging settings
      debug: true
      trace: false
  
  otel.toml: |
      # ServiceRadar OTEL Collector Configuration for Kubernetes Deployment
      
      [server]
      # Address to bind the OTEL collector to
      bind_address = "0.0.0.0"
      # Port to listen on for OTEL traces
      port = 4317
      
      [nats]
      # NATS server URL with mTLS (Kubernetes deployment)
      url = "tls://serviceradar-nats:4222"
      
      # Subject to publish traces to (default: events.otel)
      subject = "events.otel"
      
      # JetStream stream name (default: events)
      stream = "events"
      
      # Timeout for NATS operations in seconds (default: 30)
      timeout_secs = 30
      
      # mTLS configuration for NATS
      [nats.tls]
      cert_file = "/etc/serviceradar/certs/otel.pem"
      key_file = "/etc/serviceradar/certs/otel-key.pem"
      ca_file = "/etc/serviceradar/certs/root.pem"
      
      [grpc_tls]
      cert_file = "/etc/serviceradar/certs/otel.pem"
      key_file = "/etc/serviceradar/certs/otel-key.pem"
      ca_file = "/etc/serviceradar/certs/root.pem"
  
  trapd.json: |
      {
        "listen_addr": "0.0.0.0:162",
        "nats_url": "tls://serviceradar-nats:4222",
        "stream_name": "events",
        "subject": "snmp.traps",
        "nats_security": {
          "mode": "mtls",
          "cert_dir": "/etc/serviceradar/certs",
          "cert_file": "/etc/serviceradar/certs/trapd.pem",
          "key_file": "/etc/serviceradar/certs/trapd-key.pem",
          "ca_file": "/etc/serviceradar/certs/root.pem"
        },
        "grpc_listen_addr": "0.0.0.0:50043",
        "grpc_security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "trust_domain": "{{ .Values.spire.trustDomain }}",
          "workload_socket": "unix:/run/spire/sockets/agent.sock",
          "cert_file": "/etc/serviceradar/certs/trapd.pem",
          "key_file": "/etc/serviceradar/certs/trapd-key.pem",
          "ca_file": "/etc/serviceradar/certs/root.pem"
        },
        "otel": {
          "enabled": true,
          "endpoint": "serviceradar-otel:4317",
          "service_name": "serviceradar-trapd",
          "tls": {
            "cert_file": "/etc/serviceradar/certs/trapd.pem",
            "key_file": "/etc/serviceradar/certs/trapd-key.pem",
            "ca_file": "/etc/serviceradar/certs/root.pem",
            "server_name": "serviceradar-otel"
          }
        }
      }
  
  sync.json: |
      {
        "kv_address": "serviceradar-datasvc:50057",
        "listen_addr": ":50058",
        "poll_interval": "5m",
        "discovery_interval": "5m",
        "update_interval": "5m",
        "agent_id": "k8s-agent",
        "poller_id": "k8s-poller",
        "nats_url": "tls://serviceradar-nats:4222",
        "security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "role": "poller",
          "trust_domain": "{{ $trustDomain }}",
          "server_spiffe_id": "spiffe://{{ $trustDomain }}/ns/{{ $spireNamespace }}/sa/{{ $datasvcSA }}",
          "workload_socket": "unix:/run/spire/sockets/agent.sock",
          "tls": {
            "cert_file": "sync.pem",
            "key_file": "sync-key.pem",
            "ca_file": "root.pem",
            "client_ca_file": "root.pem"
          }
        },
        "nats_security": {
          "mode": "mtls",
          "cert_dir": "/etc/serviceradar/certs",
          "server_name": "nats.serviceradar",
          "role": "poller",
          "tls": {
            "cert_file": "sync.pem",
            "key_file": "sync-key.pem",
            "ca_file": "root.pem",
            "client_ca_file": "root.pem"
          }
        },
        "sources": {
          "armis": {
            "type": "armis",
            "endpoint": "http://serviceradar-faker:8080",
            "prefix": "armis/",
            "poll_interval": "5m",
            "sweep_interval": "5m",
            "agent_id": "k8s-agent",
            "poller_id": "k8s-poller",
            "partition": "default",
            "credentials": {
              "username": "${kv:secrets/armis/username}",
              "password": "${kv:secrets/armis/password}"
            },
            "page_size": 1000,
            "network_blacklist": [],
            "queries": [
              {
                "label": "all_devices",
                "query": "in:devices",
                "sweep_modes": ["icmp"]
              }
            ]
          }
        },
        "logging": {
          "level": "debug",
          "debug": true,
          "output": "stdout",
          "time_format": "",
          "otel": {
            "enabled": true,
            "endpoint": "serviceradar-otel:4317",
            "service_name": "serviceradar-sync",
            "batch_timeout": "5s",
            "insecure": false,
            "headers": {},
            "tls": {
              "cert_file": "/etc/serviceradar/certs/sync.pem",
              "key_file": "/etc/serviceradar/certs/sync-key.pem",
              "ca_file": "/etc/serviceradar/certs/root.pem"
            }
          }
        }
      }
  
  faker.json: |
      {
        "service": {
          "name": "faker",
          "description": "ServiceRadar Fake Armis API Service",
          "version": "1.0.0"
        },
        "server": {
          "listen_address": "0.0.0.0:8080",
          "read_timeout": "10s",
          "write_timeout": "30s",
          "idle_timeout": "30s"
        },
        "simulation": {
          "total_devices": {{ .Values.faker.simulation.totalDevices | default 50000 }},
          "ip_shuffle": {
            "enabled": {{ .Values.faker.simulation.ipShuffle.enabled | default true }},
            "interval": "{{ .Values.faker.simulation.ipShuffle.interval | default "10m" }}",
            "percentage": {{ .Values.faker.simulation.ipShuffle.percentage | default 5 }},
            "log_changes": true
          }
        },
        "storage": {
          "data_dir": "/var/lib/serviceradar/faker",
          "devices_file": "fake_armis_devices.json",
          "persist_changes": true
        },
        "logging": {
          "level": "info",
          "file": "/var/log/serviceradar/faker.log",
          "max_size": "100M",
          "max_backups": 5,
          "max_age": 30
        }
      }
  
  rperf.json: |
      {
        "listen_addr": "0.0.0.0:50081",
        "name": "rperf-checker",
        "type": "grpc",
        "timeout": "30s",
        "security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "trust_domain": "{{$trustDomain}}",
          "workload_socket": "unix:/run/spire/sockets/agent.sock",
          "tls": {
            "cert_file": "rperf-checker.pem",
            "key_file": "rperf-checker-key.pem",
            "ca_file": "root.pem",
            "client_ca_file": "root.pem"
          }
        },
        "default_poll_interval": 300,
        "targets": []
      }
  
  mapper.json: |
      {
        "workers": 20,
        "timeout": "30s",
        "retries": 3,
        "max_active_jobs": 100,
        "result_retention": "24h",
        "mapper_agent_id": "k8s-mapper",
        "mapper_instance_id": "serviceradar-mapper-k8s",
        "default_credentials": {
          "version": "v2c",
          "community": "public"
        },
        "oids": {
          "basic": [
            ".1.3.6.1.2.1.1.1.0",
            ".1.3.6.1.2.1.1.2.0",
            ".1.3.6.1.2.1.1.5.0",
            ".1.3.6.1.2.1.1.4.0",
            ".1.3.6.1.2.1.1.6.0",
            ".1.3.6.1.2.1.1.3.0"
          ],
          "interfaces": [
            ".1.3.6.1.2.1.2.2.1",
            ".1.3.6.1.2.1.31.1.1.1",
            ".1.3.6.1.2.1.4.20.1"
          ],
          "topology": [
            ".1.0.8802.1.1.2.1",
            ".1.3.6.1.4.1.9.9.23.1"
          ]
        },
        "stream_config": {
          "device_stream": "sweep_results",
          "interface_stream": "discovered_interfaces",
          "topology_stream": "topology_discovery_events",
          "agent_id": "k8s-snmp-discovery-agent",
          "publish_batch_size": 100,
          "publish_retries": 3,
          "publish_retry_interval": "5s"
        },
        "credentials": [
          {
            "targets": ["192.168.1.0/24", "192.168.2.0/24"],
            "version": "v2c",
            "community": "public"
          }
        ],
        "scheduled_jobs": [
          {
            "name": "k8s-lan-discovery",
            "interval": "2h",
            "enabled": true,
            "seeds": ["192.168.1.1", "192.168.2.1"],
            "type": "full",
            "credentials": {
              "version": "v2c",
              "community": "public"
            },
            "concurrency": 10,
            "timeout": "45s",
            "retries": 2,
            "options": {
              "trigger_discovery": "false"
            }
          }
        ],
        "unifi_apis": [],
        "security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "role": "checker",
          "trust_domain": "{{$trustDomain}}",
          "workload_socket": "unix:/run/spire/sockets/agent.sock"
        },
        "logging": {
          "level": "info",
          "debug": false,
          "output": "stdout",
          "time_format": "",
          "otel": {
            "enabled": true,
            "endpoint": "serviceradar-otel:4317",
            "service_name": "serviceradar-mapper",
            "batch_timeout": "5s",
            "insecure": false,
            "headers": {},
            "tls": {
              "cert_file": "/etc/serviceradar/certs/mapper.pem",
              "key_file": "/etc/serviceradar/certs/mapper-key.pem",
              "ca_file": "/etc/serviceradar/certs/root.pem",
              "server_name": "serviceradar-otel"
            }
          }
        }
      }
  
    # Data Service Configuration
  datasvc.json: |
      {
        "listen_addr": "0.0.0.0:50057",
        "nats_url": "tls://serviceradar-nats:4222",
        "nats_security": {
          "mode": "mtls",
          "cert_dir": "/etc/serviceradar/certs",
          "server_name": "nats.serviceradar",
          "role": "datasvc",
          "tls": {
            "cert_file": "kv.pem",
            "key_file": "kv-key.pem",
            "ca_file": "root.pem",
            "client_ca_file": "root.pem"
          }
        },
        "security": {
          "mode": "spiffe",
          "cert_dir": "/etc/serviceradar/certs",
          "role": "datasvc",
          "trust_domain": "{{$trustDomain}}",
          "workload_socket": "unix:/run/spire/sockets/agent.sock",
          "tls": {
            "cert_file": "kv.pem",
            "key_file": "kv-key.pem",
            "ca_file": "root.pem",
            "client_ca_file": "root.pem"
          }
        },
        "rbac": {
          "roles": [
            {"identity": "spiffe://{{ $trustDomain }}/ns/{{ $spireNamespace }}/sa/{{ .Values.spire.coreServiceAccount | default "serviceradar-core" }}", "role": "admin"},
            {"identity": "spiffe://{{ $trustDomain }}/ns/{{ $spireNamespace }}/sa/{{ .Values.spire.pollerServiceAccount | default "serviceradar-poller" }}", "role": "reader"},
            {"identity": "spiffe://{{ $trustDomain }}/ns/{{ $spireNamespace }}/sa/{{ $otelSA }}", "role": "reader"},
            {"identity": "spiffe://{{ $trustDomain }}/ns/{{ $spireNamespace }}/sa/{{ $syncSA }}", "role": "reader"},
            {"identity": "spiffe://{{ $trustDomain }}/ns/{{ $spireNamespace }}/sa/{{ $agentSA }}", "role": "writer"},
            {"identity": "spiffe://{{ $trustDomain }}/ns/{{ $spireNamespace }}/sa/{{ $mapperSA }}", "role": "reader"},
            {"identity": "spiffe://{{ $trustDomain }}/ns/{{ $spireNamespace }}/sa/{{ $snmpCheckerSA }}", "role": "writer"},
            {"identity": "spiffe://{{ $trustDomain }}/ns/{{ $spireNamespace }}/sa/{{ $dbEventWriterSA }}", "role": "reader"},
            {"identity": "spiffe://{{ $trustDomain }}/ns/{{ $spireNamespace }}/sa/{{ $zenSA }}", "role": "reader"},
            {"identity": "CN=serviceradar-agent,OU=Kubernetes,O=ServiceRadar,L=San Francisco,ST=CA,C=US", "role": "writer"},
            {"identity": "CN=serviceradar-zen,OU=Kubernetes,O=ServiceRadar,L=San Francisco,ST=CA,C=US", "role": "reader"},
            {"identity": "CN=serviceradar-core,OU=Kubernetes,O=ServiceRadar,L=San Francisco,ST=CA,C=US", "role": "admin"},
            {"identity": "CN=serviceradar-debug-client,OU=Kubernetes,O=ServiceRadar,L=San Francisco,ST=CA,C=US", "role": "reader"}
          ]
        },
        "bucket": "serviceradar-datasvc"
      }
