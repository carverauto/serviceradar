# Global Bazel configuration for the ServiceRadar monorepo.
# Keep this file minimal and import developer- or environment-specific overrides
# via the optional .bazelrc.local and .bazelrc.remote files.

startup --max_idle_secs=60

common --announce_rc
common --experimental_convenience_symlinks=clean
common --color=yes
common --curses=yes

build --keep_going
build --jobs=auto
build --show_timestamps
build --action_env=SRQL_TEST_DATABASE_URL
build --action_env=SRQL_TEST_ADMIN_URL
build --action_env=NATS_URL
build --action_env=NATS_SERVER_NAME
build --action_env=NATS_CA_FILE
build --action_env=NATS_CERT_FILE
build --action_env=NATS_KEY_FILE
build --action_env=NATS_CA_B64
build --action_env=NATS_CERT_B64
build --action_env=NATS_KEY_B64
build --action_env=NEXT_PRIVATE_SKIP_TURBOPACK=1
build --action_env=TURBOPACK=
build --action_env=NEXT_SKIP_TURBO=1
build --action_env=OPENSSL_DIR=/usr
build --action_env=OPENSSL_LIB_DIR=/usr/lib/x86_64-linux-gnu
build --action_env=OPENSSL_INCLUDE_DIR=/usr/include
build --action_env=OPENSSL_NO_VENDOR=
build --action_env=OPENSSL_NO_PKG_CONFIG=
build --repo_env=OPENSSL_DIR=/usr
build --repo_env=OPENSSL_LIB_DIR=/usr/lib/x86_64-linux-gnu
build --repo_env=OPENSSL_INCLUDE_DIR=/usr/include
build --repo_env=OPENSSL_NO_VENDOR=
build --repo_env=OPENSSL_NO_PKG_CONFIG=
build --repo_env=NEXT_SKIP_TURBO=1
build --repo_env=NEXT_PRIVATE_SKIP_TURBOPACK=1
build --repo_env=TURBOPACK=
build --java_runtime_version=local_jdk
build --tool_java_runtime_version=local_jdk
build --@io_bazel_rules_go//go/config:pure


# Standard test ergonomics: show failing logs and retry known flaky tests once.
test --test_output=errors
test --action_env=SRQL_TEST_DATABASE_URL
test --action_env=SRQL_TEST_ADMIN_URL
test --action_env=NATS_URL
test --action_env=NATS_SERVER_NAME
test --action_env=NATS_CA_FILE
test --action_env=NATS_CERT_FILE
test --action_env=NATS_KEY_FILE
test --action_env=NATS_CA_B64
test --action_env=NATS_CERT_B64
test --action_env=NATS_KEY_B64
test --@io_bazel_rules_go//go/config:pure
test --flaky_test_attempts=2

# Allow developers to extend configuration locally (ignored in version control).
try-import %workspace%/.bazelrc.local

# Remote caching/execution settings live here; provide BuildBuddy endpoints in
# .bazelrc.remote (kept out of version control until credentials are ready).
try-import %workspace%/.bazelrc.remote

# Metadata for buildbuddy
build --workspace_status_command=$(pwd)/scripts/workspace_status.sh

# Disable remote execution/caching when explicitly requested.
build:no_remote --remote_executor=
build:no_remote --remote_cache=
build:no_remote --remote_upload_local_results=false
build:no_remote --remote_download_minimal
build:no_remote --bes_backend=
build:no_remote --bes_results_url=

# CI profile can layer on top of the remote config without re-declaring values.
build:ci --keep_going --build_tag_filters=-manual
build:ci --config=remote_base
build:ci --build_metadata=ROLE=CI
build:ci --bes_results_url=https://carverauto.buildbuddy.io/invocation/
build:ci --bes_backend=grpcs://carverauto.buildbuddy.io
build:ci --remote_cache=grpcs://carverauto.buildbuddy.io
build:ci --remote_timeout=15m
build:ci --strategy=ExpandTemplate=local
build:ci --strategy=NpmPackageExtract=local
build:ci --strategy=CopyDirectory=local

# CI tests should avoid manual-only targets and preserve detailed output.
test:ci --test_tag_filters=-manual --test_output=errors

# Remote execution profile settings shared by CI and --config=remote.
build:remote_base --remote_executor=grpcs://remote.buildbuddy.io
build:remote_base --host_platform=//build/rbe:rbe_platform
build:remote_base --platforms=//build/rbe:rbe_platform
build:remote_base --crosstool_top=@buildbuddy_toolchain//:toolchain
build:remote_base --extra_toolchains=@buildbuddy_toolchain//:cc_toolchain
# Note: EL9 platform with ZFS support is available via --config=el9
# Do NOT add EL9 to extra_execution_platforms here, as it causes glibc mismatches
# for other targets. Use --config=el9 explicitly for ZFS builds.
build:remote_base --repo_env=BAZEL_DO_NOT_DETECT_CPP_TOOLCHAIN=1
build:remote_base --copt=-Wno-use-after-free
build:remote_base --java_language_version=11
build:remote_base --tool_java_language_version=11
build:remote_base --java_runtime_version=remotejdk_11
build:remote_base --tool_java_runtime_version=remotejdk_11
build:remote_base --define=EXECUTOR=remote
build:remote_base --incompatible_strict_action_env
build:remote_base --remote_download_minimal
build:remote_base --remote_upload_local_results
build:remote_base --jobs=100
build:remote_base --strategy=ExpandTemplate=local
build:remote_base --strategy=NpmPackageExtract=local
build:remote_base --strategy=CopyDirectory=local
build:remote_base --action_env=OPENSSL_DIR=/usr
build:remote_base --action_env=OPENSSL_LIB_DIR=/usr/lib/x86_64-linux-gnu
build:remote_base --action_env=OPENSSL_INCLUDE_DIR=/usr/include
build:remote_base --action_env=NEXT_PRIVATE_SKIP_TURBOPACK=1
build:remote_base --action_env=TURBOPACK=
build:remote_base --action_env=NEXT_SKIP_TURBO=1
test:remote --copt=-Wno-use-after-free
test:remote --action_env=OPENSSL_DIR=/usr
test:remote --action_env=OPENSSL_LIB_DIR=/usr/lib/x86_64-linux-gnu
test:remote --action_env=OPENSSL_INCLUDE_DIR=/usr/include
test:remote --action_env=NEXT_PRIVATE_SKIP_TURBOPACK=1
test:remote --action_env=TURBOPACK=
test:remote --action_env=NEXT_SKIP_TURBO=1

# Remote execution profile (opt-in via --config=remote).
build:remote --config=remote_base
build:remote --remote_cache=grpcs://remote.buildbuddy.io
build:remote --remote_timeout=10m

# Enable clang-tidy diagnostics via --config=clang-tidy
build:clang-tidy --features=clang_tidy
test:clang-tidy --features=clang_tidy

# OCaml toolchain generated via tools_opam is macOS-hosted, which cannot run on
# Linux remote executors. Force OCaml compilation/linking actions to run locally
# until a hermetic Linux toolchain is available.
#build:remote --strategy=CompileOCamlModule=local
#build:remote --strategy=CompileOCamlLibrary=local
#build:remote --strategy=CompileOCamlArchive=local
#build:remote --strategy=OcamlPack=local
#build:remote --strategy=OcamlLink=local

build --build_metadata=REPO_URL=git@github.com:carverauto/serviceradar.git

build:darwin_pkg --platforms=//build/platforms:darwin_exec
build:darwin_pkg --host_platform=//build/platforms:darwin_exec
build:darwin_pkg --extra_execution_platforms=//build/platforms:darwin_exec
build:darwin_pkg --action_env=DEVELOPER_DIR=/Applications/Xcode.app/Contents/Developer
build:darwin_pkg --action_env=PATH=/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/bin:/opt/homebrew/bin:/usr/local/go/bin
build:darwin_pkg --action_env=PKG_SIGN_IDENTITY
build:darwin_pkg --action_env=PKG_NOTARIZE_PROFILE
build:darwin_pkg --action_env=PKG_VERSION
build:darwin_pkg --action_env=PKG_IDENTIFIER
build:darwin_pkg --action_env=PKG_DISABLE_TIMESTAMP=0
build:darwin_pkg --action_env=XCODE_VERSION_OVERRIDE=26.0
build:darwin_pkg --remote_default_exec_properties=OSFamily=MacOS
build:darwin_pkg --repo_env=PATH=/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/opt/homebrew/bin
build:darwin_pkg --repo_env=BAZEL=/usr/local/bin/bazel
build:darwin_pkg --repo_env=BAZEL_DO_NOT_DETECT_CPP_TOOLCHAIN=1
build:darwin_pkg --config=no_remote

# macOS local hermetic builds (prefer Homebrew GCC/Clang toolchain to avoid Apple clang flag gaps)
# Usage: bazel build --config=darwin_local <targets>
build:darwin_local --repo_env=CC=/opt/homebrew/bin/gcc-14
build:darwin_local --repo_env=CXX=/opt/homebrew/bin/g++-14
build:darwin_local --action_env=CC=/opt/homebrew/bin/gcc-14
build:darwin_local --action_env=CXX=/opt/homebrew/bin/g++-14
build:darwin_local --features=fully_static_link --copt=-Wno-unused-command-line-argument
build:darwin_local --host_copt=-Wno-unused-command-line-argument
build:darwin_local --linkopt=-Wno-unused-command-line-argument
build:darwin_local --repo_env=BAZEL_DO_NOT_DETECT_CPP_TOOLCHAIN=1
build:darwin_local --strategy=CppCompile=local
build:darwin_local --strategy=CppLink=local

# EL9-compatible builds using Oracle Linux 9 RBE executor (glibc 2.34)
# Use this for RPM packages targeting RHEL/AlmaLinux/Rocky/Oracle Linux 9
# Note: We duplicate remote_base settings here instead of inheriting, to ensure
# the EL9 platform takes precedence over the default rbe_platform
build:el9 --remote_executor=grpcs://remote.buildbuddy.io
build:el9 --host_platform=//build/platforms:rbe_linux_el9
build:el9 --platforms=//build/platforms:rbe_linux_el9
build:el9 --extra_execution_platforms=//build/platforms:rbe_linux_el9
build:el9 --crosstool_top=@buildbuddy_toolchain//:toolchain
build:el9 --extra_toolchains=@buildbuddy_toolchain//:cc_toolchain
build:el9 --repo_env=BAZEL_DO_NOT_DETECT_CPP_TOOLCHAIN=1
build:el9 --copt=-Wno-use-after-free
build:el9 --java_language_version=11
build:el9 --tool_java_language_version=11
build:el9 --java_runtime_version=remotejdk_11
build:el9 --tool_java_runtime_version=remotejdk_11
build:el9 --define=EXECUTOR=remote
build:el9 --incompatible_strict_action_env
build:el9 --remote_download_outputs=all
build:el9 --remote_upload_local_results
build:el9 --jobs=100
build:el9 --strategy=ExpandTemplate=local
build:el9 --strategy=NpmPackageExtract=local
build:el9 --strategy=CopyDirectory=local
build:el9 --action_env=OPENSSL_DIR=/usr
build:el9 --action_env=OPENSSL_LIB_DIR=/usr/lib64
build:el9 --action_env=OPENSSL_INCLUDE_DIR=/usr/include
build:el9 --action_env=PKG_CONFIG_PATH=/usr/lib64/pkgconfig:/usr/pgsql-16/lib/pkgconfig
build:el9 --remote_cache=grpcs://remote.buildbuddy.io
build:el9 --remote_timeout=10m
# Use remote_default_exec_properties to force the EL9 container for all remote actions
build:el9 --remote_default_exec_properties=container-image=docker://ghcr.io/carverauto/serviceradar/rbe-executor-el9:v1.0.23
