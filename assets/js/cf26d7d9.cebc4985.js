"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[346],{28453:(e,n,r)=>{r.d(n,{R:()=>c,x:()=>l});var s=r(96540);const i={},t=s.createContext(i);function c(e){const n=s.useContext(t);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:c(e.components),s.createElement(t.Provider,{value:n},e.children)}},97487:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>h,frontMatter:()=>c,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"kv-configuration","title":"KV Store Configuration","description":"ServiceRadar can use NATS JetStream as a key-value (KV) store for dynamic configuration management. This guide explains how to configure and secure the KV store component, which enables real-time updates without requiring service restarts.","source":"@site/docs/kv-configuration.md","sourceDirName":".","slug":"/kv-configuration","permalink":"/docs/kv-configuration","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":8,"frontMatter":{"sidebar_position":8,"title":"KV Store Configuration"},"sidebar":"tutorialSidebar","previous":{"title":"Network Performance Monitoring with rperf","permalink":"/docs/rperf-monitoring"},"next":{"title":"Sync Service Configuration","permalink":"/docs/sync"}}');var i=r(74848),t=r(28453);const c={sidebar_position:8,title:"KV Store Configuration"},l="KV Store Configuration",o={},d=[{value:"Overview",id:"overview",level:2},{value:"Architecture",id:"architecture",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"KV Service Configuration",id:"kv-service-configuration",level:2},{value:"Configuration Options",id:"configuration-options",level:3},{value:"Important Settings to Consider",id:"important-settings-to-consider",level:3},{value:"Security Requirements",id:"security-requirements",level:2},{value:"mTLS Configuration",id:"mtls-configuration",level:3},{value:"Role-Based Access Control (RBAC)",id:"role-based-access-control-rbac",level:3},{value:"NATS Server Configuration",id:"nats-server-configuration",level:2},{value:"Critical NATS Server Settings",id:"critical-nats-server-settings",level:3},{value:"Co-location Requirements",id:"co-location-requirements",level:2},{value:"Certificate Requirements",id:"certificate-requirements",level:2},{value:"Configuring Components to Use the KV Store",id:"configuring-components-to-use-the-kv-store",level:2},{value:"Agent Configuration",id:"agent-configuration",level:3},{value:"Firewall Configuration",id:"firewall-configuration",level:2},{value:"Verification",id:"verification",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Service Won&#39;t Start",id:"service-wont-start",level:3},{value:"TLS Certificate Issues",id:"tls-certificate-issues",level:3},{value:"RBAC Issues",id:"rbac-issues",level:3},{value:"NATS Connection Issues",id:"nats-connection-issues",level:3},{value:"Testing with grpcurl",id:"testing-with-grpcurl",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"Next Steps",id:"next-steps",level:2}];function a(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"kv-store-configuration",children:"KV Store Configuration"})}),"\n",(0,i.jsx)(n.p,{children:"ServiceRadar can use NATS JetStream as a key-value (KV) store for dynamic configuration management. This guide explains how to configure and secure the KV store component, which enables real-time updates without requiring service restarts."}),"\n",(0,i.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsx)(n.p,{children:"The KV store in ServiceRadar:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Provides a distributed key-value store using NATS JetStream"}),"\n",(0,i.jsx)(n.li,{children:"Supports dynamic configuration updates"}),"\n",(0,i.jsx)(n.li,{children:"Uses role-based access control (RBAC) for secure access"}),"\n",(0,i.jsx)(n.li,{children:"Requires mTLS security for all communications"}),"\n",(0,i.jsx)(n.li,{children:"Is designed for co-location with NATS by default"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"architecture",children:"Architecture"}),"\n",(0,i.jsx)(n.mermaid,{value:'graph LR\n    subgraph "KV Store Components"\n        A[Agent] --\x3e|mTLS Client| KV[ServiceRadar KV<br/>:50057]\n        KV --\x3e|mTLS Client| NATS[NATS JetStream<br/>:4222]\n    end'}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"NATS JetStream"})," provides the underlying key-value storage technology"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"ServiceRadar KV"})," provides a gRPC service that other components interact with"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Co-location"})," of NATS and KV service on the same machine is the recommended deployment model"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"mTLS"})," secures all communications between components"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,i.jsx)(n.p,{children:"Before configuring the KV store, ensure you have:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Installed NATS JetStream (via the ",(0,i.jsx)(n.code,{children:"serviceradar-nats"})," package)"]}),"\n",(0,i.jsxs)(n.li,{children:["Installed the KV service (via the ",(0,i.jsx)(n.code,{children:"serviceradar-kv"})," package)"]}),"\n",(0,i.jsx)(n.li,{children:"Generated and deployed TLS certificates for mTLS security"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["For installation instructions, see the ",(0,i.jsx)(n.a,{href:"/docs/installation",children:"Installation Guide"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"kv-service-configuration",children:"KV Service Configuration"}),"\n",(0,i.jsxs)(n.p,{children:["The KV service configuration is stored in ",(0,i.jsx)(n.code,{children:"/etc/serviceradar/kv.json"}),". Here's a complete example:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "listen_addr": "192.168.2.23:50057",\n  "nats_url": "nats://192.168.2.23:4222",\n  "security": {\n    "mode": "mtls",\n    "cert_dir": "/etc/serviceradar/certs",\n    "server_name": "192.168.2.23",\n    "role": "kv",\n    "tls": {\n      "cert_file": "kv.pem",\n      "key_file": "kv-key.pem",\n      "ca_file": "root.pem",\n      "client_ca_file": "root.pem"\n    }\n  },\n  "rbac": {\n    "roles": [\n      {"identity": "CN=192.168.2.23,O=ServiceRadar", "role": "reader"}\n    ]\n  },\n  "bucket": "serviceradar-kv"\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"configuration-options",children:"Configuration Options"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Option"}),(0,i.jsx)(n.th,{children:"Description"}),(0,i.jsx)(n.th,{children:"Default"}),(0,i.jsx)(n.th,{children:"Required"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"listen_addr"})}),(0,i.jsx)(n.td,{children:"Address and port for the KV service gRPC API"}),(0,i.jsx)(n.td,{children:"N/A"}),(0,i.jsx)(n.td,{children:"Yes"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"nats_url"})}),(0,i.jsx)(n.td,{children:"URL for connecting to the NATS Server"}),(0,i.jsx)(n.td,{children:"N/A"}),(0,i.jsx)(n.td,{children:"Yes"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"security.mode"})}),(0,i.jsx)(n.td,{children:'Security mode (must be "mtls")'}),(0,i.jsx)(n.td,{children:"N/A"}),(0,i.jsx)(n.td,{children:"Yes"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"security.cert_dir"})}),(0,i.jsx)(n.td,{children:"Directory for TLS certificates"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"/etc/serviceradar/certs"})}),(0,i.jsx)(n.td,{children:"Yes"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"security.server_name"})}),(0,i.jsx)(n.td,{children:"Hostname/IP of the NATS server"}),(0,i.jsx)(n.td,{children:"N/A"}),(0,i.jsx)(n.td,{children:"Yes"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"security.role"})}),(0,i.jsx)(n.td,{children:"Role of this component"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"kv"})}),(0,i.jsx)(n.td,{children:"Yes"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"security.tls.cert_file"})}),(0,i.jsx)(n.td,{children:"Component certificate file"}),(0,i.jsx)(n.td,{children:"N/A"}),(0,i.jsx)(n.td,{children:"Yes"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"security.tls.key_file"})}),(0,i.jsx)(n.td,{children:"Component private key file"}),(0,i.jsx)(n.td,{children:"N/A"}),(0,i.jsx)(n.td,{children:"Yes"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"security.tls.ca_file"})}),(0,i.jsx)(n.td,{children:"CA certificate file"}),(0,i.jsx)(n.td,{children:"N/A"}),(0,i.jsx)(n.td,{children:"Yes"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"security.tls.client_ca_file"})}),(0,i.jsx)(n.td,{children:"Client CA certificate file"}),(0,i.jsx)(n.td,{children:"N/A"}),(0,i.jsx)(n.td,{children:"Yes"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"rbac.roles"})}),(0,i.jsx)(n.td,{children:"List of role definitions"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"[]"})}),(0,i.jsx)(n.td,{children:"No"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"bucket"})}),(0,i.jsx)(n.td,{children:"The name of the NATS JetStream bucket"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"serviceradar-kv"})}),(0,i.jsx)(n.td,{children:"No"})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"important-settings-to-consider",children:"Important Settings to Consider"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"listen_addr"})}),": Use the actual IP address of your server along with a unique port. The default port for the KV service is ",(0,i.jsx)(n.code,{children:"50057"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"nats_url"})}),": This should point to where your NATS server is installed. Since NATS and the KV service are typically co-located, this is usually ",(0,i.jsx)(n.code,{children:"nats://localhost:4222"})," or ",(0,i.jsx)(n.code,{children:"nats://<your-server-ip>:4222"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"security.mode"})}),": Must be set to ",(0,i.jsx)(n.code,{children:'"mtls"'})," as the KV service requires mutual TLS authentication."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"security.server_name"})}),": ",(0,i.jsx)(n.strong,{children:"CRITICAL"})," - This must match the IP/hostname where NATS is installed. This is used for certificate validation."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"rbac.roles"})}),": Defines which client certificates can access the KV store and with what permissions."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"security-requirements",children:"Security Requirements"}),"\n",(0,i.jsx)(n.h3,{id:"mtls-configuration",children:"mTLS Configuration"}),"\n",(0,i.jsxs)(n.p,{children:["The KV service ",(0,i.jsx)(n.strong,{children:"requires"})," mTLS for security. The following settings are mandatory:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'"security": {\n  "mode": "mtls",\n  "cert_dir": "/etc/serviceradar/certs",\n  "server_name": "your-nats-server-ip-or-hostname",\n  "role": "kv",\n  "tls": {\n    "cert_file": "kv.pem",\n    "key_file": "kv-key.pem",\n    "ca_file": "root.pem",\n    "client_ca_file": "root.pem"\n  }\n}\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["The ",(0,i.jsx)(n.code,{children:"cert_file"}),", ",(0,i.jsx)(n.code,{children:"key_file"}),", and ",(0,i.jsx)(n.code,{children:"ca_file"})," paths are relative to the ",(0,i.jsx)(n.code,{children:"cert_dir"})," if not absolute"]}),"\n",(0,i.jsx)(n.li,{children:"Use absolute paths when certificates are stored outside the default directory"}),"\n",(0,i.jsxs)(n.li,{children:["The ",(0,i.jsx)(n.code,{children:"server_name"})," must match the hostname/IP in the NATS server's certificate"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"role-based-access-control-rbac",children:"Role-Based Access Control (RBAC)"}),"\n",(0,i.jsx)(n.p,{children:"RBAC controls which clients can read from or write to the KV store:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'"rbac": {\n  "roles": [\n    {"identity": "CN=agent.serviceradar,O=ServiceRadar", "role": "reader"},\n    {"identity": "CN=sync.serviceradar,O=ServiceRadar", "role": "writer"}\n  ]\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"Available roles:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"reader"}),": Can only read keys (Get, Watch operations)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"writer"}),": Can read and modify keys (Get, Watch, Put, Delete operations)"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"identity"})," field must match the Subject Distinguished Name from the client's certificate. This is typically in the format ",(0,i.jsx)(n.code,{children:"CN=<common-name>,O=<organization>"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"nats-server-configuration",children:"NATS Server Configuration"}),"\n",(0,i.jsxs)(n.p,{children:["The NATS Server configuration is located at ",(0,i.jsx)(n.code,{children:"/etc/nats/nats-server.conf"}),". The default configuration provided by the ",(0,i.jsx)(n.code,{children:"serviceradar-nats"})," package and includes mTLS and JetStream support:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'# NATS Server Configuration for ServiceRadar KV Store\n\n# Listen on the default NATS port (restricted to localhost for security)\nlisten: 127.0.0.1:4222\n\n# Server identification\nserver_name: nats-serviceradar\n\n# Enable JetStream for KV store\njetstream {\n  # Directory to store JetStream data\n  store_dir: /var/lib/nats/jetstream\n  # Maximum storage size\n  max_memory_store: 1G\n  # Maximum disk storage\n  max_file_store: 10G\n}\n\n# Enable mTLS for secure communication\ntls {\n  # Path to the server certificate\n  cert_file: "/etc/serviceradar/certs/nats-server.pem"\n  # Path to the server private key\n  key_file: "/etc/serviceradar/certs/nats-server-key.pem"\n  # Path to the root CA certificate for verifying clients\n  ca_file: "/etc/serviceradar/certs/root.pem"\n\n  # Require client certificates (enables mTLS)\n  verify: true\n  # Require and verify client certificates\n  verify_and_map: true\n}\n\n# Logging settings\nlogfile: "/var/log/nats/nats.log"\ndebug: true\n'})}),"\n",(0,i.jsx)(n.h3,{id:"critical-nats-server-settings",children:"Critical NATS Server Settings"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"server_name"})}),": Should match the CN in the server's certificate"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"listen"})}),": By default, NATS only listens on localhost (127.0.0.1) for security"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"cert_file"})}),", ",(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"key_file"})}),", ",(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"ca_file"})}),": Paths to TLS certificates"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"verify"})})," and ",(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"verify_and_map"})}),": Enable client certificate verification for mTLS"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["If you need to access NATS from other hosts, change the ",(0,i.jsx)(n.code,{children:"listen"})," directive to an appropriate IP address or ",(0,i.jsx)(n.code,{children:"0.0.0.0"})," for all interfaces. However, ensure you have proper firewall rules in place."]}),"\n",(0,i.jsx)(n.h2,{id:"co-location-requirements",children:"Co-location Requirements"}),"\n",(0,i.jsx)(n.p,{children:"ServiceRadar ships its own version of NATS, and by default, NATS and the KV service are designed to be co-located on the same machine. This setup offers several advantages:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Security"}),": Communication between the KV service and NATS stays local"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Performance"}),": Local connections are faster and more reliable"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Simplicity"}),": Fewer network configuration requirements"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"When configuring a co-located deployment:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Use ",(0,i.jsx)(n.code,{children:"localhost"})," or the machine's IP address in both configurations"]}),"\n",(0,i.jsxs)(n.li,{children:["Ensure the NATS Server's ",(0,i.jsx)(n.code,{children:"server_name"})," matches what's in its certificate"]}),"\n",(0,i.jsxs)(n.li,{children:["Set the KV service's ",(0,i.jsx)(n.code,{children:"security.server_name"})," to match the NATS server's hostname/IP"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"certificate-requirements",children:"Certificate Requirements"}),"\n",(0,i.jsx)(n.p,{children:"The KV service needs the following certificate files:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"kv.pem"})}),": The KV service's certificate"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"kv-key.pem"})}),": The KV service's private key"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"root.pem"})}),": The root CA certificate that signed all component certificates"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"nats-server.pem"})})," and ",(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"nats-server-key.pem"})}),": For the NATS server"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["For certificate generation instructions, see the ",(0,i.jsx)(n.a,{href:"/docs/tls-security",children:"TLS Security"})," documentation."]}),"\n",(0,i.jsx)(n.h2,{id:"configuring-components-to-use-the-kv-store",children:"Configuring Components to Use the KV Store"}),"\n",(0,i.jsx)(n.h3,{id:"agent-configuration",children:"Agent Configuration"}),"\n",(0,i.jsx)(n.p,{children:"To enable an agent to use the KV store for dynamic configuration:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Edit the agent's systemd service file:"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"sudo systemctl edit serviceradar-agent\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"2",children:["\n",(0,i.jsx)(n.li,{children:"Add the environment variable for KV store configuration:"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ini",children:'[Service]\nEnvironment="CONFIG_SOURCE=kv"\nEnvironment="KV_SERVER=192.168.2.23:50057"\n'})}),"\n",(0,i.jsxs)(n.ol,{start:"3",children:["\n",(0,i.jsx)(n.li,{children:"Restart the agent to apply the changes:"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"sudo systemctl daemon-reload\nsudo systemctl restart serviceradar-agent\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"4",children:["\n",(0,i.jsx)(n.li,{children:"Ensure the agent's certificate is added to the RBAC configuration in the KV service."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"firewall-configuration",children:"Firewall Configuration"}),"\n",(0,i.jsx)(n.p,{children:"If you're using a firewall, you need to open ports for the KV service:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# For UFW (Ubuntu)\nsudo ufw allow 50057/tcp  # KV service gRPC port\n\n# For firewalld (RHEL/Oracle Linux)\nsudo firewall-cmd --permanent --add-port=50057/tcp\nsudo firewall-cmd --reload\n"})}),"\n",(0,i.jsx)(n.p,{children:"Note that port 4222 (NATS) typically doesn't need to be opened externally when using the default co-located setup where NATS only listens on localhost."}),"\n",(0,i.jsx)(n.h2,{id:"verification",children:"Verification"}),"\n",(0,i.jsx)(n.p,{children:"After configuring both the KV service and NATS:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Restart both services:"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"sudo systemctl restart nats\nsudo systemctl restart serviceradar-kv\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"2",children:["\n",(0,i.jsx)(n.li,{children:"Check their status:"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"sudo systemctl status nats\nsudo systemctl status serviceradar-kv\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"3",children:["\n",(0,i.jsx)(n.li,{children:"Verify the KV service is listening on the configured port:"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"sudo netstat -tulpn | grep 50057\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"4",children:["\n",(0,i.jsx)(n.li,{children:"Check the logs for any errors:"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"sudo journalctl -u serviceradar-kv --since today\nsudo cat /var/log/nats/nats.log\n"})}),"\n",(0,i.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,i.jsx)(n.h3,{id:"service-wont-start",children:"Service Won't Start"}),"\n",(0,i.jsx)(n.p,{children:"Check the logs for detailed error information:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"sudo journalctl -u serviceradar-kv -n 100\n"})}),"\n",(0,i.jsx)(n.p,{children:"Common issues include:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Incorrect certificate paths"}),"\n",(0,i.jsxs)(n.li,{children:["Wrong ",(0,i.jsx)(n.code,{children:"server_name"})," for certificate validation"]}),"\n",(0,i.jsx)(n.li,{children:"NATS server not running or unreachable"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"tls-certificate-issues",children:"TLS Certificate Issues"}),"\n",(0,i.jsx)(n.p,{children:"Verify certificates are properly formatted and have correct permissions:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# Check certificate ownership and permissions\nls -la /etc/serviceradar/certs/\n\n# Verify certificate content and expiration\nopenssl x509 -in /etc/serviceradar/certs/kv.pem -text -noout\n"})}),"\n",(0,i.jsx)(n.h3,{id:"rbac-issues",children:"RBAC Issues"}),"\n",(0,i.jsx)(n.p,{children:"If clients can't connect, check that their certificate subject matches an entry in the RBAC roles:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# Get the subject name from a client certificate\nopenssl x509 -in /etc/serviceradar/certs/agent.pem -subject -noout\n"})}),"\n",(0,i.jsxs)(n.p,{children:["The output should match an ",(0,i.jsx)(n.code,{children:"identity"})," in the RBAC configuration."]}),"\n",(0,i.jsx)(n.h3,{id:"nats-connection-issues",children:"NATS Connection Issues"}),"\n",(0,i.jsx)(n.p,{children:"If the KV service can't connect to NATS:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# Install the NATS CLI if needed\ngo install github.com/nats-io/natscli/nats@latest\n\n# Test the NATS connection with mTLS\nnats server check --server nats://localhost:4222 \\\n  --tls-cert /etc/serviceradar/certs/kv.pem \\\n  --tls-key /etc/serviceradar/certs/kv-key.pem \\\n  --tls-ca /etc/serviceradar/certs/root.pem\n"})}),"\n",(0,i.jsx)(n.h3,{id:"testing-with-grpcurl",children:"Testing with grpcurl"}),"\n",(0,i.jsx)(n.p,{children:"You can test the KV service's gRPC API using grpcurl:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# Install grpcurl if needed\ngo install github.com/fullstorydev/grpcurl/cmd/grpcurl@latest\n\n# Test the health check endpoint with mTLS\ngrpcurl -cacert /etc/serviceradar/certs/root.pem \\\n        -cert /etc/serviceradar/certs/agent.pem \\\n        -key /etc/serviceradar/certs/agent-key.pem \\\n        -servername <KV_SERVER_IP> \\\n        <KV_SERVER_IP>:50057 \\\n        grpc.health.v1.Health/Check\n"})}),"\n",(0,i.jsx)(n.p,{children:"A successful response should look like:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "status": "SERVING"\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Always use mTLS"}),": Never disable mTLS for the KV service, as it provides essential security."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Restrict NATS access"}),": Keep NATS listening only on localhost when possible for security."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Use specific RBAC roles"}),": Grant only the minimal permissions needed for each component."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Regular certificate rotation"}),": Update certificates periodically for security best practices."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Backup configuration"}),": Regularly back up your KV store data to prevent data loss."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Learn more about ",(0,i.jsx)(n.a,{href:"/docs/custom-checkers",children:"Custom Checkers"})]}),"\n",(0,i.jsx)(n.li,{children:"Explore integrating your own services with the KV store"}),"\n",(0,i.jsx)(n.li,{children:"Consider high availability configurations for critical deployments"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["For more information on securing ServiceRadar components, refer to the ",(0,i.jsx)(n.a,{href:"/docs/tls-security",children:"TLS Security"})," documentation."]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}}}]);