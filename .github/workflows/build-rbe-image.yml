name: Build RBE Image

on:
  push:
    branches:
      - main
    paths:
      - 'docker/Dockerfile.rbe'
      - '.github/workflows/build-rbe-image.yml'
  pull_request:
    paths:
      - 'docker/Dockerfile.rbe'
      - '.github/workflows/build-rbe-image.yml'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/rbe-executor
  VERSION: v1.0.14

jobs:
  build-and-push:
    runs-on: arc-runner-set
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Buildah
        run: |
          if command -v apt-get &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y buildah fuse-overlayfs
          elif command -v dnf &> /dev/null; then
            sudo dnf install -y buildah fuse-overlayfs
          elif command -v yum &> /dev/null; then
            sudo yum install -y buildah fuse-overlayfs
          else
            echo "No supported package manager found"
            exit 1
          fi

      - name: Configure Buildah for rootless operation
        run: |
          # Create config directories
          mkdir -p ~/.config/containers

          # Configure storage to use vfs driver (works without privileges)
          cat > ~/.config/containers/storage.conf << 'EOF'
          [storage]
          driver = "vfs"
          runroot = "/tmp/containers-runroot"
          graphroot = "/tmp/containers-storage"
          EOF

          # Configure registries
          cat > ~/.config/containers/registries.conf << 'EOF'
          [registries.search]
          registries = ['docker.io', 'ghcr.io']

          [registries.insecure]
          registries = []
          EOF

          # Verify configuration
          buildah info

      - name: Log in to Container Registry
        run: |
          echo "${{ secrets.GHCR_TOKEN != '' && secrets.GHCR_TOKEN || secrets.GITHUB_TOKEN }}" | \
            buildah login -u "${{ secrets.GHCR_USERNAME != '' && secrets.GHCR_USERNAME || github.actor }}" \
            --password-stdin ${{ env.REGISTRY }}

      - name: Generate image tags
        id: tags
        run: |
          REPO="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          TAGS=""

          # Version tag
          TAGS="${REPO}:${{ env.VERSION }}"

          # SHA tag
          TAGS="${TAGS} ${REPO}:sha-${GITHUB_SHA::7}"

          # Branch/PR tag
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            TAGS="${TAGS} ${REPO}:pr-${{ github.event.pull_request.number }}"
          else
            BRANCH_NAME="${GITHUB_REF_NAME}"
            TAGS="${TAGS} ${REPO}:${BRANCH_NAME}"
            # Latest tag only on main
            if [[ "${BRANCH_NAME}" == "main" ]]; then
              TAGS="${TAGS} ${REPO}:latest"
            fi
          fi

          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "Generated tags: ${TAGS}"

      - name: Build image with Buildah
        run: |
          buildah bud \
            --format docker \
            --layers \
            --build-arg GHCR_USERNAME=${{ github.actor }} \
            --secret id=ghcr_token,env=GHCR_TOKEN \
            -f docker/Dockerfile.rbe \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }} \
            .
        env:
          GHCR_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Tag image
        run: |
          PRIMARY_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }}"
          for tag in ${{ steps.tags.outputs.tags }}; do
            if [[ "${tag}" != "${PRIMARY_TAG}" ]]; then
              buildah tag "${PRIMARY_TAG}" "${tag}"
            fi
          done

      - name: Push image
        if: github.event_name != 'pull_request'
        run: |
          for tag in ${{ steps.tags.outputs.tags }}; do
            echo "Pushing ${tag}..."
            buildah push "${tag}"
          done
