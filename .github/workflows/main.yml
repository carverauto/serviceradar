name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    runs-on: arc-runner-set
    permissions:
      contents: read
    env:
      BUILDBUDDY_ORG_API_KEY: ${{ secrets.BUILDBUDDY_ORG_API_KEY }}
      SRQL_TEST_DATABASE_URL: ${{ secrets.SRQL_TEST_DATABASE_URL }}
      SRQL_TEST_ADMIN_URL: ${{ secrets.SRQL_TEST_ADMIN_URL }}
      SRQL_TEST_DATABASE_CA_CERT: ${{ secrets.SRQL_TEST_DATABASE_CA_CERT }}
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      TEST_CNPG_DATABASE: serviceradar_web_ng_test

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install build dependencies
        run: |
          ensure_pkg_config() {
            if command -v pkg-config >/dev/null 2>&1; then
              return
            fi

            if command -v apt-get >/dev/null 2>&1; then
              sudo apt-get install -y pkg-config
            elif command -v dnf >/dev/null 2>&1; then
              if ! sudo dnf install -y pkgconfig; then
                sudo dnf install -y pkgconf-pkg-config
              fi
            elif command -v yum >/dev/null 2>&1; then
              if ! sudo yum install -y pkgconfig; then
                sudo yum install -y pkgconf-pkg-config
              fi
            elif command -v microdnf >/dev/null 2>&1; then
              if ! sudo microdnf install -y pkgconfig; then
                sudo microdnf install -y pkgconf-pkg-config
              fi
            else
              echo "pkg-config is required but no supported package manager was found." >&2
              exit 1
            fi
          }

          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y build-essential pkg-config libssl-dev protobuf-compiler cmake flex bison
          elif command -v dnf >/dev/null 2>&1; then
            sudo dnf install -y gcc gcc-c++ make openssl-devel protobuf-compiler cmake flex bison
          elif command -v yum >/dev/null 2>&1; then
            sudo yum install -y gcc gcc-c++ make openssl-devel protobuf-compiler cmake flex bison
          elif command -v microdnf >/dev/null 2>&1; then
            sudo microdnf install -y gcc gcc-c++ make openssl-devel protobuf-compiler cmake flex bison
          else
            echo "Unsupported package manager; please install gcc, g++ (or clang), make, OpenSSL headers, pkg-config, and protoc manually." >&2
            exit 1
          fi

          ensure_pkg_config
          protoc --version || (echo "protoc installation failed" && exit 1)

      - name: Setup Beam
        uses: erlef/setup-beam@v1
        with:
          otp-version: "28.3"
          elixir-version: "1.19.4"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Setup Bazel
        uses: bazelbuild/setup-bazelisk@v3

      - name: Configure SRQL fixture database for tests
        env:
          SRQL_TEST_DATABASE_URL: ${{ secrets.SRQL_TEST_DATABASE_URL }}
          SRQL_TEST_ADMIN_URL: ${{ secrets.SRQL_TEST_ADMIN_URL }}
          SRQL_TEST_DATABASE_CA_CERT: ${{ secrets.SRQL_TEST_DATABASE_CA_CERT }}
        run: |
          set -euo pipefail

          if [ -z "${SRQL_TEST_DATABASE_URL:-}" ] || [ -z "${SRQL_TEST_ADMIN_URL:-}" ]; then
            echo "SRQL fixture DSNs must be configured via SRQL_TEST_DATABASE_URL and SRQL_TEST_ADMIN_URL secrets." >&2
            exit 1
          fi

          if [ -z "${SRQL_TEST_DATABASE_CA_CERT:-}" ]; then
            echo "SRQL_TEST_DATABASE_CA_CERT secret must be configured to verify SRQL fixture TLS." >&2
            exit 1
          fi

          ca_file="${RUNNER_TEMP}/srql-fixture-ca.crt"
          printf "%s" "${SRQL_TEST_DATABASE_CA_CERT}" > "${ca_file}"

          {
            echo "PGSSLROOTCERT=${ca_file}"
            echo "SRQL_TEST_DATABASE_CA_CERT=${ca_file}"
          } >> "$GITHUB_ENV"

          parser="$(command -v python3 || command -v python || true)"
          if [ -z "${parser}" ]; then
            echo "python is required to parse SRQL fixture DSNs." >&2
            exit 1
          fi

          "${parser}" - <<'PY' >> "$GITHUB_ENV"
          import os
          from urllib.parse import urlparse, parse_qs

          def parse(url):
              u = urlparse(url)
              qs = parse_qs(u.query)
              return {
                  "user": u.username or "",
                  "password": u.password or "",
                  "host": u.hostname or "",
                  "port": str(u.port or 5432),
                  "sslmode": (qs.get("sslmode") or [""])[0],
              }

          db = parse(os.environ["SRQL_TEST_DATABASE_URL"])
          admin = parse(os.environ["SRQL_TEST_ADMIN_URL"])
          host = admin["host"] or db["host"]
          port = admin["port"] or db["port"]
          user = admin["user"]
          password = admin["password"]

          if not host or not user:
              raise SystemExit("SRQL_TEST_ADMIN_URL must include host and username")

          print(f"TEST_CNPG_HOST={host}")
          print(f"TEST_CNPG_PORT={port}")
          print(f"TEST_CNPG_USERNAME={user}")
          print(f"TEST_CNPG_PASSWORD={password}")
          print(f"CNPG_HOST={host}")
          print(f"CNPG_PORT={port}")

          sslmode = db["sslmode"] or "require"
          print(f"CNPG_SSL_MODE={sslmode}")
          print(f"CNPG_TLS_SERVER_NAME={host}")
          PY

      - name: Configure remote cache
        if: ${{ env.BUILDBUDDY_ORG_API_KEY != '' }}
        run: |
          umask 077
          printf 'common --remote_header=x-buildbuddy-api-key=%s\n' "${BUILDBUDDY_ORG_API_KEY}" > .bazelrc.remote

      - name: Configure Docker auth for Bazel pulls
        if: ${{ env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != '' }}
        run: ./buildbuddy_setup_docker_auth.sh

      - name: Test
        run: |
          bazel test \
            --config=ci \
            --test_tag_filters=-manual \
            //...

      - name: serviceradar_core integration tests
        run: make test-integration
