name: Source Code SBOM

on:
  release:
    types: [published]
  workflow_dispatch:
  schedule:
    # Weekly on Monday at 00:00 UTC
    - cron: '0 0 * * 1'

permissions:
  contents: write

jobs:
  generate-sbom:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create syft config
        run: |
          cat > .syft.yaml <<EOF
          exclude:
            - "**/node_modules/**"
            - "**/vendor/**"
            - "**/target/**"
            - "**/.git/**"
            - "**/build/**"
            - "**/release/**"
            - "**/dist/**"
            - "**/.next/**"
            - "**/testdata/**"
            - "**/test/**"
            - "**/tests/**"
            - "**/examples/**"
            - "**/.bazel/**"
            - "**/.cache/**"
            - "**/docs/.docusaurus/**"
            - "**/bazel-*/**"
          EOF

      - name: Generate Source SBOM
        uses: anchore/sbom-action@v0
        with:
          path: .
          format: spdx-json
          output-file: serviceradar-source.spdx.json
          config: .syft.yaml
          upload-release-assets: ${{ github.event_name == 'release' }}
          artifact-name: serviceradar-source-sbom

      - name: Generate summary
        run: |
          echo "## Source Code SBOM Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Source SBOM includes all dependencies from:" >> $GITHUB_STEP_SUMMARY
          echo "- Go modules" >> $GITHUB_STEP_SUMMARY
          echo "- Rust crates" >> $GITHUB_STEP_SUMMARY
          echo "- npm packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** For container-specific SBOMs, see the 'Generate Container Image SBOMs' workflow." >> $GITHUB_STEP_SUMMARY
