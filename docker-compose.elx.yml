version: "3.9"

services:
  cloak-keygen:
    image: alpine:3.20
    container_name: serviceradar-cloak-keygen
    environment:
      - CLOAK_KEY=${CLOAK_KEY:-MBkLP+XL4htJEQ2Tyi+g+E6Jru4eLd4r9hT4dxcOIeg=}
    volumes:
      - cloak-key:/etc/serviceradar/cloak
    command: >
      sh -c 'set -e;
      mkdir -p /etc/serviceradar/cloak;
      if [ ! -f /etc/serviceradar/cloak/cloak.key ]; then
        umask 077;
        if [ -n "${CLOAK_KEY:-}" ]; then
          printf "%s" "${CLOAK_KEY}" > /etc/serviceradar/cloak/cloak.key;
        else
          head -c 32 /dev/urandom | base64 | tr -d "\n" > /etc/serviceradar/cloak/cloak.key;
        fi;
        echo "Generated CLOAK_KEY";
      else
        echo "CLOAK_KEY already present";
      fi'
    restart: "no"
    networks:
      - serviceradar-net

  core-elx:
    build:
      context: .
      dockerfile: docker/compose/Dockerfile.core-elx
    container_name: serviceradar-core-elx
    hostname: core-elx
    environment:
      - CLUSTER_ENABLED=true
      - CLUSTER_STRATEGY=epmd
      - CLUSTER_HOSTS=serviceradar_web_ng@web-ng,serviceradar_poller@poller-elx
      - ENABLE_TLS_DIST=true
      - SSL_DIST_OPTFILE=/etc/serviceradar/ssl_dist.conf
      - SPIFFE_CERT_DIR=/etc/serviceradar/certs
      - RELEASE_NODE=serviceradar_core@core-elx
      - RELEASE_COOKIE=serviceradar_dev_cookie
      # Database configuration
      - CNPG_HOST=cnpg
      - CNPG_PORT=5432
      - CNPG_DATABASE=serviceradar
      - CNPG_USERNAME=serviceradar
      - CNPG_PASSWORD=serviceradar
      - CNPG_SSL_MODE=disable
      # Feature flags
      - SERVICERADAR_CORE_REPO_ENABLED=true
      - SERVICERADAR_CORE_VAULT_ENABLED=true
      - SERVICERADAR_CORE_REGISTRIES_ENABLED=true
      - SERVICERADAR_CORE_OBAN_ENABLED=true
      # Encryption key for Cloak
      - CLOAK_KEY_FILE=/etc/serviceradar/cloak/cloak.key
    volumes:
      - cert-data:/etc/serviceradar/certs:ro
      - ./docker/compose/ssl_dist.core.conf:/etc/serviceradar/ssl_dist.conf:ro
      - cloak-key:/etc/serviceradar/cloak:ro
    networks:
      - serviceradar-net
    depends_on:
      - cloak-keygen
      - cnpg
    restart: unless-stopped

  web-ng:
    hostname: web-ng
    environment:
      - CLUSTER_ENABLED=true
      - CLUSTER_STRATEGY=epmd
      - CLUSTER_HOSTS=serviceradar_poller@poller-elx,serviceradar_core@core-elx
      - CLUSTER_TLS_ENABLED=true
      - SSL_DIST_OPTFILE=/etc/serviceradar/ssl_dist.conf
      - RELEASE_NODE=serviceradar_web_ng@web-ng
      - RELEASE_COOKIE=serviceradar_dev_cookie
      - CLOAK_KEY_FILE=/etc/serviceradar/cloak/cloak.key
    volumes:
      - ./docker/compose/ssl_dist.web.conf:/etc/serviceradar/ssl_dist.conf:ro
      - cloak-key:/etc/serviceradar/cloak:ro

  poller-elx:
    build:
      context: .
      dockerfile: docker/compose/Dockerfile.poller-elx
    container_name: serviceradar-poller-elx
    hostname: poller-elx
    environment:
      - CLUSTER_ENABLED=true
      - CLUSTER_STRATEGY=epmd
      - CLUSTER_HOSTS=serviceradar_web_ng@web-ng,serviceradar_core@core-elx
      - ENABLE_TLS_DIST=true
      - SSL_DIST_OPTFILE=/etc/serviceradar/ssl_dist.conf
      - SPIFFE_CERT_DIR=/etc/serviceradar/certs
      - RELEASE_NODE=serviceradar_poller@poller-elx
      - RELEASE_COOKIE=serviceradar_dev_cookie
    volumes:
      - cert-data:/etc/serviceradar/certs:ro
      - ./docker/compose/ssl_dist.poller.conf:/etc/serviceradar/ssl_dist.conf:ro
    networks:
      - serviceradar-net
    restart: unless-stopped

volumes:
  cloak-key:
