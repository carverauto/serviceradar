#!/bin/sh
# Release environment configuration for ServiceRadar Agent

# =============================================================================
# Node Name Configuration
# =============================================================================

# Use fully qualified hostnames for distributed Erlang
if [ -z "${RELEASE_NODE}" ]; then
  HOSTNAME=${HOSTNAME:-$(hostname -f)}
  export RELEASE_NODE="agent@${HOSTNAME}"
fi

# Use distributed (longnames) mode for cluster communication
export RELEASE_DISTRIBUTION="name"

# =============================================================================
# mTLS Distribution Configuration
# =============================================================================
# Enable TLS for Erlang distribution (node-to-node communication)

CERT_DIR="${SPIFFE_CERT_DIR:-/etc/serviceradar/certs}"

if [ "${ENABLE_TLS_DIST:-true}" = "true" ] && [ -f "${CERT_DIR}/svid.pem" ]; then
  export ERL_FLAGS="${ERL_FLAGS} -proto_dist inet_tls"
  export ERL_FLAGS="${ERL_FLAGS} -ssl_dist_optfile ${CERT_DIR}/ssl_dist.conf"
fi

# =============================================================================
# Remote Shell Access
# =============================================================================

if [ -n "${HIDDEN_NODE}" ]; then
  export ERL_FLAGS="${ERL_FLAGS} -hidden"
fi

# =============================================================================
# Cookie Configuration
# =============================================================================

if [ -z "${RELEASE_COOKIE}" ]; then
  COOKIE_FILE="${CERT_DIR}/erlang_cookie"
  if [ -f "${COOKIE_FILE}" ]; then
    export RELEASE_COOKIE=$(cat "${COOKIE_FILE}")
  else
    export RELEASE_COOKIE="${ERLANG_COOKIE:-serviceradar_dev_cookie}"
  fi
fi

# =============================================================================
# Memory and Performance
# =============================================================================
# Tune BEAM for agent deployments (very low memory footprint)

# Enable scheduler binding
export ERL_FLAGS="${ERL_FLAGS} +sbt db"

# Smaller async thread pool (agents are less I/O intensive)
export ERL_FLAGS="${ERL_FLAGS} +A 8"

# =============================================================================
# Debug Settings
# =============================================================================

if [ "${DEBUG_DIST:-false}" = "true" ]; then
  export ERL_FLAGS="${ERL_FLAGS} -kernel inet_dist_listen_min 9100 -kernel inet_dist_listen_max 9155"
fi
