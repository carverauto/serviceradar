defmodule ServiceRadar.Repo.TenantMigrations.InitialSchema do
  @moduledoc """
  Updates resources based on their most recent snapshots.

  This file was autogenerated with `mix ash_postgres.generate_migrations`
  """

  use Ecto.Migration

  def up do
    create table(:user_tokens, primary_key: false, prefix: prefix()) do
      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :created_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :extra_data, :map
      add :purpose, :text, null: false
      add :expires_at, :utc_datetime, null: false
      add :subject, :text, null: false
      add :jti, :text, null: false, primary_key: true
    end

    create table(:tenant_cas, primary_key: false, prefix: prefix()) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true

      add :tenant_id,
          references(:tenants,
            column: :id,
            name: "tenant_cas_tenant_id_fkey",
            type: :uuid,
            prefix: "public"
          ), null: false

      add :certificate_pem, :text, null: false
      add :serial_number, :text, null: false
      add :spki_sha256, :text
      add :next_child_serial, :bigint, default: 1
      add :subject_cn, :text, null: false
      add :not_before, :utc_datetime, null: false
      add :not_after, :utc_datetime, null: false
      add :status, :text, null: false, default: "active"
      add :revoked_at, :utc_datetime
      add :revocation_reason, :text

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :encrypted_private_key_pem, :binary, null: false
    end

    create index(:tenant_cas, [:spki_sha256])

    create unique_index(:tenant_cas, [:tenant_id, :status],
             name: "tenant_cas_unique_active_tenant_ca_index",
             where: "(status = 'active')"
           )

    create table(:service_checks, primary_key: false, prefix: prefix()) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :name, :text, null: false
      add :description, :text
      add :check_type, :text, null: false
      add :target, :text, null: false
      add :port, :bigint
      add :interval_seconds, :bigint, default: 60
      add :timeout_seconds, :bigint, default: 10
      add :retries, :bigint, default: 3
      add :enabled, :boolean, default: true
      add :config, :map, default: %{}
      add :warning_threshold_ms, :bigint
      add :critical_threshold_ms, :bigint
      add :last_check_at, :utc_datetime
      add :last_result, :text
      add :last_response_time_ms, :bigint
      add :last_error, :text
      add :consecutive_failures, :bigint, default: 0
      add :agent_uid, :text
      add :device_uid, :text
      add :metadata, :map, default: %{}
      add :schedule_id, :uuid
      add :tenant_id, :uuid, null: false

      add :created_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create table(:polling_schedules, primary_key: false, prefix: prefix()) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :name, :text, null: false
      add :description, :text
      add :schedule_type, :text, null: false, default: "interval"
      add :interval_seconds, :bigint
      add :cron_expression, :text
      add :assignment_mode, :text, null: false, default: "any"
      add :assigned_gateway_id, :text
      add :assigned_partition_id, :uuid
      add :assigned_domain, :text
      add :enabled, :boolean, default: true
      add :priority, :bigint, default: 0
      add :max_concurrent, :bigint, default: 10
      add :timeout_seconds, :bigint, default: 60
      add :last_executed_at, :utc_datetime
      add :last_result, :text
      add :last_check_count, :bigint, default: 0
      add :last_success_count, :bigint, default: 0
      add :last_failure_count, :bigint, default: 0
      add :execution_count, :bigint, default: 0
      add :consecutive_failures, :bigint, default: 0
      add :lock_token, :uuid
      add :locked_at, :utc_datetime
      add :locked_by, :text
      add :metadata, :map, default: %{}
      add :tenant_id, :uuid, null: false

      add :created_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create table(:poll_jobs, primary_key: false, prefix: prefix()) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true

      add :schedule_id,
          references(:polling_schedules,
            column: :id,
            name: "poll_jobs_schedule_id_fkey",
            type: :uuid,
            prefix: prefix()
          ), null: false

      add :schedule_name, :text
      add :check_count, :bigint, default: 0
      add :check_ids, {:array, :uuid}, default: []
      add :gateway_id, :text
      add :agent_id, :text
      add :priority, :bigint, default: 0
      add :timeout_seconds, :bigint, default: 60
      add :status, :text, null: false, default: "pending"
      add :dispatched_at, :utc_datetime
      add :started_at, :utc_datetime
      add :completed_at, :utc_datetime
      add :duration_ms, :bigint
      add :success_count, :bigint, default: 0
      add :failure_count, :bigint, default: 0
      add :results, {:array, :map}, default: []
      add :error_message, :text
      add :error_code, :text
      add :retry_count, :bigint, default: 0
      add :max_retries, :bigint, default: 3
      add :metadata, :map, default: %{}
      add :tenant_id, :uuid, null: false

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create unique_index(:poll_jobs, [:id], name: "poll_jobs_unique_job_index")

    create table(:partitions, primary_key: false, prefix: prefix()) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
    end

    alter table(:polling_schedules, prefix: prefix()) do
      modify :assigned_partition_id,
             references(:partitions,
               column: :id,
               name: "polling_schedules_assigned_partition_id_fkey",
               type: :uuid,
               prefix: prefix()
             )
    end

    alter table(:partitions, prefix: prefix()) do
      add :name, :text, null: false
      add :slug, :text, null: false
      add :description, :text
      add :enabled, :boolean, default: true
      add :cidr_ranges, {:array, :text}, default: []
      add :default_gateway, :text
      add :dns_servers, {:array, :text}, default: []
      add :site, :text
      add :region, :text
      add :environment, :text, default: "production"
      add :connectivity_type, :text, default: "direct"
      add :proxy_endpoint, :text
      add :metadata, :map, default: %{}
      add :created_at, :utc_datetime
      add :updated_at, :utc_datetime
      add :tenant_id, :uuid, null: false
    end

    create unique_index(:partitions, [:tenant_id, :slug],
             name: "partitions_unique_slug_per_tenant_index"
           )

    create table(:ocsf_devices, primary_key: false, prefix: prefix()) do
      add :uid, :text, null: false, primary_key: true
      add :type_id, :bigint, default: 0
      add :type, :text
      add :name, :text
      add :hostname, :text
      add :ip, :text
      add :mac, :text
      add :uid_alt, :text
      add :vendor_name, :text
      add :model, :text
      add :domain, :text
      add :zone, :text
      add :subnet_uid, :text
      add :vlan_uid, :text
      add :region, :text
      add :first_seen_time, :utc_datetime
      add :last_seen_time, :utc_datetime
      add :created_time, :utc_datetime
      add :modified_time, :utc_datetime
      add :risk_level_id, :bigint
      add :risk_level, :text
      add :risk_score, :bigint
      add :is_managed, :boolean, default: false
      add :is_compliant, :boolean
      add :is_trusted, :boolean, default: false
      add :os, :map, default: %{}
      add :hw_info, :map, default: %{}
      add :network_interfaces, {:array, :map}, default: []
      add :owner, :map, default: %{}
      add :org, :map, default: %{}
      add :groups, {:array, :map}, default: []
      add :agent_list, {:array, :map}, default: []
      add :gateway_id, :text
      add :agent_id, :text
      add :discovery_sources, {:array, :text}, default: []
      add :is_available, :boolean, default: true
      add :metadata, :map, default: %{}
      add :tenant_id, :uuid, null: false
      add :group_id, :uuid
    end

    create table(:ocsf_agents, primary_key: false, prefix: prefix()) do
      add :uid, :text, null: false, primary_key: true
      add :name, :text
      add :type_id, :bigint, default: 0
      add :type, :text
      add :uid_alt, :text
      add :vendor_name, :text, default: "ServiceRadar"
      add :version, :text
      add :policies, {:array, :map}, default: []
      add :gateway_id, :text
      add :device_uid, :text
      add :capabilities, {:array, :text}, default: []
      add :host, :text
      add :port, :bigint
      add :spiffe_identity, :text
      add :status, :text, null: false, default: "connecting"
      add :is_healthy, :boolean, default: true
      add :first_seen_time, :utc_datetime
      add :last_seen_time, :utc_datetime
      add :created_time, :utc_datetime
      add :modified_time, :utc_datetime
      add :metadata, :map, default: %{}
      add :tenant_id, :uuid, null: false
    end

    create table(:ng_users, primary_key: false, prefix: prefix()) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :email, :citext, null: false
      add :hashed_password, :text
      add :display_name, :text
      add :role, :text, null: false, default: "viewer"
      add :confirmed_at, :utc_datetime
      add :authenticated_at, :utc_datetime

      add :tenant_id,
          references(:tenants,
            column: :id,
            name: "ng_users_tenant_id_fkey",
            type: :uuid,
            prefix: "public"
          ), null: false

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create unique_index(:ng_users, [:email], name: "ng_users_email_index")

    create table(:ng_job_schedules, primary_key: false, prefix: prefix()) do
      add :id, :bigserial, null: false, primary_key: true
      add :job_key, :text, null: false
      add :cron, :text, null: false
      add :timezone, :text, default: "Etc/UTC"
      add :args, :map, default: %{}
      add :enabled, :boolean, default: true
      add :unique_period_seconds, :bigint
      add :last_enqueued_at, :utc_datetime_usec

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create unique_index(:ng_job_schedules, [:job_key],
             name: "ng_job_schedules_unique_job_key_index"
           )

    create table(:nats_leaf_servers, primary_key: false, prefix: prefix()) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true

      add :tenant_id,
          references(:tenants,
            column: :id,
            name: "nats_leaf_servers_tenant_id_fkey",
            type: :uuid,
            prefix: "public"
          ), null: false

      add :edge_site_id, :uuid, null: false
      add :status, :text, null: false, default: "pending"
      add :upstream_url, :text, null: false
      add :local_listen, :text, null: false, default: "0.0.0.0:4222"
      add :leaf_cert_pem, :text
      add :server_cert_pem, :text
      add :ca_chain_pem, :text
      add :config_checksum, :text
      add :cert_expires_at, :utc_datetime_usec
      add :provisioned_at, :utc_datetime_usec
      add :connected_at, :utc_datetime_usec
      add :disconnected_at, :utc_datetime_usec

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :encrypted_leaf_key_pem_ciphertext, :binary
      add :encrypted_server_key_pem_ciphertext, :binary
    end

    create table(:nats_credentials, primary_key: false, prefix: prefix()) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true

      add :tenant_id,
          references(:tenants,
            column: :id,
            name: "nats_credentials_tenant_id_fkey",
            type: :uuid,
            prefix: "public"
          ), null: false

      add :user_name, :text, null: false
      add :user_public_key, :text, null: false
      add :credential_type, :text, null: false, default: "collector"
      add :collector_type, :text
      add :status, :text, null: false, default: "active"
      add :issued_at, :utc_datetime_usec, null: false
      add :expires_at, :utc_datetime_usec
      add :revoked_at, :utc_datetime_usec
      add :revoke_reason, :text
      add :onboarding_package_id, :uuid
      add :metadata, :map, default: %{}

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create table(:monitoring_events, primary_key: false, prefix: prefix()) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :category, :text, null: false
      add :event_type, :text, null: false
      add :severity, :bigint, default: 1
      add :message, :text, null: false
      add :details, :text
      add :source_type, :text
      add :source_id, :text
      add :source_name, :text
      add :target_type, :text
      add :target_id, :text
      add :target_name, :text

      add :device_uid,
          references(:ocsf_devices,
            column: :uid,
            name: "monitoring_events_device_uid_fkey",
            type: :text,
            prefix: prefix()
          )

      add :agent_uid,
          references(:ocsf_agents,
            column: :uid,
            name: "monitoring_events_agent_uid_fkey",
            type: :text,
            prefix: prefix()
          )

      add :alert_id, :uuid
      add :metadata, :map, default: %{}
      add :tags, {:array, :text}, default: []
      add :actor_type, :text
      add :actor_id, :text
      add :actor_name, :text
      add :client_ip, :text
      add :occurred_at, :utc_datetime, null: false
      add :tenant_id, :uuid, null: false

      add :created_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create table(:merge_audit, primary_key: false, prefix: prefix()) do
      add :event_id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :from_device_id, :text, null: false
      add :to_device_id, :text, null: false
      add :reason, :text
      add :confidence_score, :decimal
      add :source, :text
      add :details, :map, default: %{}
      add :created_at, :utc_datetime
    end

    create table(:logs, primary_key: false, prefix: prefix()) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :timestamp, :utc_datetime, null: false
      add :trace_id, :text
      add :span_id, :text
      add :severity_text, :text
      add :severity_number, :bigint
      add :body, :text
      add :service_name, :text
      add :service_version, :text
      add :service_instance, :text
      add :scope_name, :text
      add :scope_version, :text
      add :attributes, :map, default: %{}
      add :resource_attributes, :map, default: %{}
      add :tenant_id, :uuid, null: false

      add :created_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create table(:integration_sources, primary_key: false, prefix: prefix()) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :name, :text, null: false
      add :source_type, :text, null: false
      add :endpoint, :text, null: false
      add :enabled, :boolean, default: true
      add :agent_id, :text
      add :gateway_id, :text
      add :partition, :text, default: "default"
      add :poll_interval_seconds, :bigint, default: 300
      add :discovery_interval_seconds, :bigint, default: 3600
      add :sweep_interval_seconds, :bigint, default: 3600
      add :page_size, :bigint, default: 100
      add :network_blacklist, {:array, :text}, default: []
      add :queries, {:array, :map}, default: []
      add :custom_fields, {:array, :text}, default: []
      add :settings, :map, default: %{}
      add :last_sync_at, :utc_datetime
      add :last_sync_result, :text
      add :last_device_count, :bigint, default: 0
      add :last_error_message, :text
      add :consecutive_failures, :bigint, default: 0
      add :total_syncs, :bigint, default: 0
      add :tenant_id, :uuid, null: false

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :encrypted_credentials_encrypted, :binary
    end

    create unique_index(:integration_sources, [:tenant_id, :name],
             name: "integration_sources_unique_name_per_tenant_index"
           )

    create table(:health_events, primary_key: false, prefix: prefix()) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :entity_type, :text, null: false
      add :entity_id, :text, null: false
      add :old_state, :text
      add :new_state, :text, null: false
      add :reason, :text
      add :node, :text
      add :duration_seconds, :bigint
      add :recorded_at, :utc_datetime, null: false
      add :metadata, :map, default: %{}
      add :tenant_id, :uuid, null: false
    end

    create index(:health_events, [:entity_type, :new_state, :recorded_at])

    create index(:health_events, [:tenant_id, :recorded_at])

    create index(:health_events, [:entity_type, :entity_id, :recorded_at])

    create unique_index(:health_events, [:id], name: "health_events_unique_event_index")

    create table(:gateways, primary_key: false, prefix: prefix()) do
      add :gateway_id, :text, null: false, primary_key: true
      add :component_id, :text
      add :registration_source, :text
      add :status, :text, null: false, default: "inactive"
      add :spiffe_identity, :text
      add :first_registered, :utc_datetime
      add :first_seen, :utc_datetime
      add :last_seen, :utc_datetime
      add :metadata, :map, default: %{}
      add :created_by, :text
      add :is_healthy, :boolean, default: true
      add :agent_count, :bigint, default: 0
      add :checker_count, :bigint, default: 0
      add :updated_at, :utc_datetime
      add :tenant_id, :uuid, null: false

      add :partition_id,
          references(:partitions,
            column: :id,
            name: "gateways_partition_id_fkey",
            type: :uuid,
            prefix: prefix()
          )
    end

    create unique_index(:gateways, [:gateway_id], name: "gateways_unique_gateway_id_index")

    alter table(:ocsf_agents, prefix: prefix()) do
      modify :gateway_id,
             references(:gateways,
               column: :gateway_id,
               name: "ocsf_agents_gateway_id_fkey",
               type: :text,
               prefix: prefix()
             )

      modify :device_uid,
             references(:ocsf_devices,
               column: :uid,
               name: "ocsf_agents_device_uid_fkey",
               type: :text,
               prefix: prefix()
             )
    end

    create unique_index(:ocsf_agents, [:uid], name: "ocsf_agents_unique_uid_index")

    alter table(:service_checks, prefix: prefix()) do
      modify :agent_uid,
             references(:ocsf_agents,
               column: :uid,
               name: "service_checks_agent_uid_fkey",
               type: :text,
               prefix: prefix()
             )
    end

    create table(:edge_sites, primary_key: false, prefix: prefix()) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
    end

    alter table(:nats_leaf_servers, prefix: prefix()) do
      modify :edge_site_id,
             references(:edge_sites,
               column: :id,
               name: "nats_leaf_servers_edge_site_id_fkey",
               type: :uuid,
               prefix: prefix()
             )
    end

    create unique_index(:nats_leaf_servers, [:edge_site_id],
             name: "nats_leaf_servers_unique_per_edge_site_index"
           )

    alter table(:edge_sites, prefix: prefix()) do
      add :tenant_id,
          references(:tenants,
            column: :id,
            name: "edge_sites_tenant_id_fkey",
            type: :uuid,
            prefix: "public"
          ), null: false

      add :name, :text, null: false
      add :slug, :text, null: false
      add :status, :text, null: false, default: "pending"
      add :nats_leaf_url, :text
      add :last_seen_at, :utc_datetime_usec

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create unique_index(:edge_sites, [:tenant_id, :slug],
             name: "edge_sites_unique_slug_per_tenant_index"
           )

    create table(:edge_onboarding_packages, primary_key: false, prefix: prefix()) do
      add :package_id, :uuid,
        null: false,
        default: fragment("gen_random_uuid()"),
        primary_key: true
    end

    alter table(:nats_credentials, prefix: prefix()) do
      modify :onboarding_package_id,
             references(:edge_onboarding_packages,
               column: :package_id,
               name: "nats_credentials_onboarding_package_id_fkey",
               type: :uuid,
               prefix: prefix()
             )
    end

    create unique_index(:nats_credentials, [:user_public_key],
             name: "nats_credentials_unique_user_public_key_index"
           )

    alter table(:edge_onboarding_packages, prefix: prefix()) do
      add :label, :text, null: false
      add :component_id, :text
      add :component_type, :text, default: "gateway"
      add :parent_type, :text
      add :parent_id, :text
      add :gateway_id, :text
      add :site, :text
      add :status, :text, null: false, default: "issued"
      add :security_mode, :text, default: "spire"
      add :downstream_entry_id, :text
      add :downstream_spiffe_id, :text
      add :selectors, {:array, :text}, default: []
      add :checker_kind, :text
      add :checker_config_json, :map, default: %{}
      add :join_token_ciphertext, :text
      add :join_token_expires_at, :utc_datetime
      add :bundle_ciphertext, :text
      add :download_token_hash, :text
      add :download_token_expires_at, :utc_datetime
      add :created_by, :text, default: "system"
      add :delivered_at, :utc_datetime
      add :activated_at, :utc_datetime
      add :activated_from_ip, :text
      add :last_seen_spiffe_id, :text
      add :revoked_at, :utc_datetime
      add :deleted_at, :utc_datetime
      add :deleted_by, :text
      add :deleted_reason, :text
      add :metadata_json, :map, default: %{}
      add :kv_revision, :bigint
      add :notes, :text
      add :tenant_id, :uuid, null: false

      add :created_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create table(:edge_onboarding_events, primary_key: false, prefix: prefix()) do
      add :event_time, :utc_datetime_usec, null: false, primary_key: true

      add :package_id,
          references(:edge_onboarding_packages,
            column: :package_id,
            name: "edge_onboarding_events_package_id_fkey",
            type: :uuid,
            prefix: prefix()
          ), primary_key: true, null: false

      add :event_type, :text, null: false
      add :actor, :text
      add :source_ip, :text
      add :details_json, :map, default: %{}
    end

    create table(:discovered_interfaces, primary_key: false, prefix: prefix()) do
      add :timestamp, :utc_datetime, null: false, primary_key: true

      add :device_id,
          references(:ocsf_devices,
            column: :uid,
            name: "discovered_interfaces_device_id_fkey",
            type: :text,
            prefix: prefix()
          ), primary_key: true, null: false

      add :if_index, :bigint, null: false, primary_key: true
      add :agent_id, :text
      add :gateway_id, :text
      add :device_ip, :text
      add :if_name, :text
      add :if_descr, :text
      add :if_alias, :text
      add :if_speed, :bigint
      add :if_phys_address, :text
      add :ip_addresses, {:array, :text}, default: []
      add :if_admin_status, :bigint
      add :if_oper_status, :bigint
      add :metadata, :map, default: %{}
      add :created_at, :utc_datetime
    end

    create table(:device_identifiers, primary_key: false, prefix: prefix()) do
      add :id, :bigserial, null: false, primary_key: true

      add :device_id,
          references(:ocsf_devices,
            column: :uid,
            name: "device_identifiers_device_id_fkey",
            type: :text,
            prefix: prefix()
          ), null: false

      add :identifier_type, :text, null: false
      add :identifier_value, :text, null: false
      add :partition, :text, default: "default"
      add :confidence, :text, default: "strong"
      add :source, :text
      add :first_seen, :utc_datetime
      add :last_seen, :utc_datetime
      add :verified, :boolean, default: false
      add :metadata, :map, default: %{}
    end

    create unique_index(:device_identifiers, [:identifier_type, :identifier_value, :partition],
             name: "device_identifiers_unique_identifier_index"
           )

    create table(:device_groups, primary_key: false, prefix: prefix()) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
    end

    alter table(:ocsf_devices, prefix: prefix()) do
      modify :group_id,
             references(:device_groups,
               column: :id,
               name: "ocsf_devices_group_id_fkey",
               type: :uuid,
               prefix: prefix()
             )
    end

    create unique_index(:ocsf_devices, [:uid], name: "ocsf_devices_unique_uid_index")

    alter table(:service_checks, prefix: prefix()) do
      modify :device_uid,
             references(:ocsf_devices,
               column: :uid,
               name: "service_checks_device_uid_fkey",
               type: :text,
               prefix: prefix()
             )

      modify :schedule_id,
             references(:polling_schedules,
               column: :id,
               name: "service_checks_schedule_id_fkey",
               type: :uuid,
               prefix: prefix()
             )
    end

    alter table(:device_groups, prefix: prefix()) do
      add :name, :text, null: false
      add :desc, :text
      add :type, :text, default: "custom"

      add :parent_id,
          references(:device_groups,
            column: :id,
            name: "device_groups_parent_id_fkey",
            type: :uuid,
            prefix: prefix()
          )

      add :metadata, :map, default: %{}
      add :device_count, :bigint, default: 0

      add :created_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :tenant_id, :uuid, null: false
    end

    create unique_index(:device_groups, [:tenant_id, :name],
             name: "device_groups_unique_name_per_tenant_index"
           )

    create table(:device_alias_states, primary_key: false, prefix: prefix()) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true

      add :device_id,
          references(:ocsf_devices,
            column: :uid,
            name: "device_alias_states_device_id_fkey",
            type: :text,
            prefix: prefix()
          ), null: false

      add :partition, :text
      add :alias_type, :text, null: false
      add :alias_value, :text, null: false
      add :state, :text, null: false, default: "detected"
      add :first_seen_at, :utc_datetime, null: false
      add :last_seen_at, :utc_datetime, null: false
      add :sighting_count, :bigint, default: 1
      add :metadata, :map, default: %{}
      add :previous_alias_id, :uuid
      add :replaced_by_alias_id, :uuid
      add :tenant_id, :uuid, null: false

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create unique_index(:device_alias_states, [:device_id, :alias_type, :alias_value],
             name: "device_alias_states_unique_device_alias_index"
           )

    create table(:collector_packages, primary_key: false, prefix: prefix()) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true

      add :tenant_id,
          references(:tenants,
            column: :id,
            name: "collector_packages_tenant_id_fkey",
            type: :uuid,
            prefix: "public"
          ), null: false

      add :collector_type, :text, null: false
      add :user_name, :text, null: false
      add :site, :text, default: "default"
      add :hostname, :text
      add :status, :text, null: false, default: "pending"

      add :nats_credential_id,
          references(:nats_credentials,
            column: :id,
            name: "collector_packages_nats_credential_id_fkey",
            type: :uuid,
            prefix: prefix()
          )

      add :download_token_hash, :text
      add :download_token_expires_at, :utc_datetime_usec
      add :downloaded_at, :utc_datetime_usec
      add :downloaded_by_ip, :text
      add :installed_at, :utc_datetime_usec
      add :revoked_at, :utc_datetime_usec
      add :revoke_reason, :text
      add :error_message, :text
      add :tls_cert_pem, :text
      add :ca_chain_pem, :text
      add :config_overrides, :map, default: %{}

      add :edge_site_id,
          references(:edge_sites,
            column: :id,
            name: "collector_packages_edge_site_id_fkey",
            type: :uuid,
            prefix: prefix()
          )

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :encrypted_nats_creds_ciphertext, :binary
      add :encrypted_tls_key_pem_ciphertext, :binary
    end

    create unique_index(:collector_packages, [:tenant_id, :user_name],
             name: "collector_packages_unique_user_name_per_tenant_index"
           )

    create table(:checkers, primary_key: false, prefix: prefix()) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :name, :text, null: false
      add :type, :text, null: false
      add :description, :text
      add :enabled, :boolean, default: true
      add :status, :text, null: false, default: "active"
      add :consecutive_failures, :bigint, default: 0
      add :last_success, :utc_datetime
      add :last_failure, :utc_datetime
      add :failure_reason, :text
      add :config, :map, default: %{}
      add :interval_seconds, :bigint, default: 60
      add :timeout_seconds, :bigint, default: 30
      add :retries, :bigint, default: 3
      add :target_type, :text, default: "agent"
      add :target_filter, :map, default: %{}

      add :agent_uid,
          references(:ocsf_agents,
            column: :uid,
            name: "checkers_agent_uid_fkey",
            type: :text,
            prefix: prefix()
          )

      add :created_at, :utc_datetime
      add :updated_at, :utc_datetime
      add :tenant_id, :uuid, null: false
    end

    create table(:api_tokens, primary_key: false, prefix: prefix()) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :name, :text, null: false
      add :description, :text
      add :token_hash, :text, null: false
      add :token_prefix, :text, null: false
      add :scope, :text, default: "read"
      add :enabled, :boolean, default: true
      add :expires_at, :utc_datetime
      add :last_used_at, :utc_datetime
      add :last_used_ip, :text
      add :use_count, :bigint, default: 0
      add :revoked_at, :utc_datetime
      add :revoked_by, :text
      add :metadata, :map, default: %{}
      add :created_at, :utc_datetime
      add :tenant_id, :uuid, null: false

      add :user_id,
          references(:ng_users,
            column: :id,
            name: "api_tokens_user_id_fkey",
            type: :uuid,
            prefix: prefix()
          ), null: false
    end

    create table(:alerts, primary_key: false, prefix: prefix()) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
    end

    alter table(:monitoring_events, prefix: prefix()) do
      modify :alert_id,
             references(:alerts,
               column: :id,
               name: "monitoring_events_alert_id_fkey",
               type: :uuid,
               prefix: prefix()
             )
    end

    alter table(:alerts, prefix: prefix()) do
      add :title, :text, null: false
      add :description, :text
      add :severity, :text, null: false, default: "warning"
      add :status, :text, null: false, default: "pending"
      add :source_type, :text
      add :source_id, :text

      add :service_check_id,
          references(:service_checks,
            column: :id,
            name: "alerts_service_check_id_fkey",
            type: :uuid,
            prefix: prefix()
          )

      add :device_uid,
          references(:ocsf_devices,
            column: :uid,
            name: "alerts_device_uid_fkey",
            type: :text,
            prefix: prefix()
          )

      add :agent_uid,
          references(:ocsf_agents,
            column: :uid,
            name: "alerts_agent_uid_fkey",
            type: :text,
            prefix: prefix()
          )

      add :metric_name, :text
      add :metric_value, :float
      add :threshold_value, :float
      add :comparison, :text
      add :triggered_at, :utc_datetime
      add :acknowledged_at, :utc_datetime
      add :acknowledged_by, :text
      add :resolved_at, :utc_datetime
      add :resolved_by, :text
      add :resolution_note, :text
      add :escalated_at, :utc_datetime
      add :escalation_level, :bigint, default: 0
      add :escalation_reason, :text
      add :notification_count, :bigint, default: 0
      add :last_notification_at, :utc_datetime
      add :suppressed_until, :utc_datetime
      add :metadata, :map, default: %{}
      add :tags, {:array, :text}, default: []
      add :tenant_id, :uuid, null: false

      add :created_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end
  end

  def down do
    drop constraint(:alerts, "alerts_service_check_id_fkey")

    drop constraint(:alerts, "alerts_device_uid_fkey")

    drop constraint(:alerts, "alerts_agent_uid_fkey")

    alter table(:alerts, prefix: prefix()) do
      remove :updated_at
      remove :created_at
      remove :tenant_id
      remove :tags
      remove :metadata
      remove :suppressed_until
      remove :last_notification_at
      remove :notification_count
      remove :escalation_reason
      remove :escalation_level
      remove :escalated_at
      remove :resolution_note
      remove :resolved_by
      remove :resolved_at
      remove :acknowledged_by
      remove :acknowledged_at
      remove :triggered_at
      remove :comparison
      remove :threshold_value
      remove :metric_value
      remove :metric_name
      remove :agent_uid
      remove :device_uid
      remove :service_check_id
      remove :source_id
      remove :source_type
      remove :status
      remove :severity
      remove :description
      remove :title
    end

    drop constraint(:monitoring_events, "monitoring_events_alert_id_fkey")

    alter table(:monitoring_events, prefix: prefix()) do
      modify :alert_id, :uuid
    end

    drop table(:alerts, prefix: prefix())

    drop constraint(:api_tokens, "api_tokens_user_id_fkey")

    drop table(:api_tokens, prefix: prefix())

    drop constraint(:checkers, "checkers_agent_uid_fkey")

    drop table(:checkers, prefix: prefix())

    drop_if_exists unique_index(:collector_packages, [:tenant_id, :user_name],
                     name: "collector_packages_unique_user_name_per_tenant_index"
                   )

    drop constraint(:collector_packages, "collector_packages_tenant_id_fkey")

    drop constraint(:collector_packages, "collector_packages_nats_credential_id_fkey")

    drop constraint(:collector_packages, "collector_packages_edge_site_id_fkey")

    drop table(:collector_packages, prefix: prefix())

    drop_if_exists unique_index(:device_alias_states, [:device_id, :alias_type, :alias_value],
                     name: "device_alias_states_unique_device_alias_index"
                   )

    drop constraint(:device_alias_states, "device_alias_states_device_id_fkey")

    drop table(:device_alias_states, prefix: prefix())

    drop_if_exists unique_index(:device_groups, [:tenant_id, :name],
                     name: "device_groups_unique_name_per_tenant_index"
                   )

    drop constraint(:device_groups, "device_groups_parent_id_fkey")

    alter table(:device_groups, prefix: prefix()) do
      remove :tenant_id
      remove :updated_at
      remove :created_at
      remove :device_count
      remove :metadata
      remove :parent_id
      remove :type
      remove :desc
      remove :name
    end

    drop constraint(:service_checks, "service_checks_device_uid_fkey")

    drop constraint(:service_checks, "service_checks_schedule_id_fkey")

    alter table(:service_checks, prefix: prefix()) do
      modify :schedule_id, :uuid
      modify :device_uid, :text
    end

    drop_if_exists unique_index(:ocsf_devices, [:uid], name: "ocsf_devices_unique_uid_index")

    drop constraint(:ocsf_devices, "ocsf_devices_group_id_fkey")

    alter table(:ocsf_devices, prefix: prefix()) do
      modify :group_id, :uuid
    end

    drop table(:device_groups, prefix: prefix())

    drop_if_exists unique_index(
                     :device_identifiers,
                     [:identifier_type, :identifier_value, :partition],
                     name: "device_identifiers_unique_identifier_index"
                   )

    drop constraint(:device_identifiers, "device_identifiers_device_id_fkey")

    drop table(:device_identifiers, prefix: prefix())

    drop constraint(:discovered_interfaces, "discovered_interfaces_device_id_fkey")

    drop table(:discovered_interfaces, prefix: prefix())

    drop constraint(:edge_onboarding_events, "edge_onboarding_events_package_id_fkey")

    drop table(:edge_onboarding_events, prefix: prefix())

    alter table(:edge_onboarding_packages, prefix: prefix()) do
      remove :updated_at
      remove :created_at
      remove :tenant_id
      remove :notes
      remove :kv_revision
      remove :metadata_json
      remove :deleted_reason
      remove :deleted_by
      remove :deleted_at
      remove :revoked_at
      remove :last_seen_spiffe_id
      remove :activated_from_ip
      remove :activated_at
      remove :delivered_at
      remove :created_by
      remove :download_token_expires_at
      remove :download_token_hash
      remove :bundle_ciphertext
      remove :join_token_expires_at
      remove :join_token_ciphertext
      remove :checker_config_json
      remove :checker_kind
      remove :selectors
      remove :downstream_spiffe_id
      remove :downstream_entry_id
      remove :security_mode
      remove :status
      remove :site
      remove :gateway_id
      remove :parent_id
      remove :parent_type
      remove :component_type
      remove :component_id
      remove :label
    end

    drop_if_exists unique_index(:nats_credentials, [:user_public_key],
                     name: "nats_credentials_unique_user_public_key_index"
                   )

    drop constraint(:nats_credentials, "nats_credentials_onboarding_package_id_fkey")

    alter table(:nats_credentials, prefix: prefix()) do
      modify :onboarding_package_id, :uuid
    end

    drop table(:edge_onboarding_packages, prefix: prefix())

    drop_if_exists unique_index(:edge_sites, [:tenant_id, :slug],
                     name: "edge_sites_unique_slug_per_tenant_index"
                   )

    drop constraint(:edge_sites, "edge_sites_tenant_id_fkey")

    alter table(:edge_sites, prefix: prefix()) do
      remove :updated_at
      remove :inserted_at
      remove :last_seen_at
      remove :nats_leaf_url
      remove :status
      remove :slug
      remove :name
      remove :tenant_id
    end

    drop_if_exists unique_index(:nats_leaf_servers, [:edge_site_id],
                     name: "nats_leaf_servers_unique_per_edge_site_index"
                   )

    drop constraint(:nats_leaf_servers, "nats_leaf_servers_edge_site_id_fkey")

    alter table(:nats_leaf_servers, prefix: prefix()) do
      modify :edge_site_id, :uuid
    end

    drop table(:edge_sites, prefix: prefix())

    drop constraint(:service_checks, "service_checks_agent_uid_fkey")

    alter table(:service_checks, prefix: prefix()) do
      modify :agent_uid, :text
    end

    drop_if_exists unique_index(:ocsf_agents, [:uid], name: "ocsf_agents_unique_uid_index")

    drop constraint(:ocsf_agents, "ocsf_agents_gateway_id_fkey")

    drop constraint(:ocsf_agents, "ocsf_agents_device_uid_fkey")

    alter table(:ocsf_agents, prefix: prefix()) do
      modify :device_uid, :text
      modify :gateway_id, :text
    end

    drop_if_exists unique_index(:gateways, [:gateway_id],
                     name: "gateways_unique_gateway_id_index"
                   )

    drop constraint(:gateways, "gateways_partition_id_fkey")

    drop table(:gateways, prefix: prefix())

    drop_if_exists unique_index(:health_events, [:id], name: "health_events_unique_event_index")

    drop_if_exists index(:health_events, [:entity_type, :entity_id, :recorded_at])

    drop_if_exists index(:health_events, [:tenant_id, :recorded_at])

    drop_if_exists index(:health_events, [:entity_type, :new_state, :recorded_at])

    drop table(:health_events, prefix: prefix())

    drop_if_exists unique_index(:integration_sources, [:tenant_id, :name],
                     name: "integration_sources_unique_name_per_tenant_index"
                   )

    drop table(:integration_sources, prefix: prefix())

    drop table(:logs, prefix: prefix())

    drop table(:merge_audit, prefix: prefix())

    drop constraint(:monitoring_events, "monitoring_events_device_uid_fkey")

    drop constraint(:monitoring_events, "monitoring_events_agent_uid_fkey")

    drop table(:monitoring_events, prefix: prefix())

    drop constraint(:nats_credentials, "nats_credentials_tenant_id_fkey")

    drop table(:nats_credentials, prefix: prefix())

    drop constraint(:nats_leaf_servers, "nats_leaf_servers_tenant_id_fkey")

    drop table(:nats_leaf_servers, prefix: prefix())

    drop_if_exists unique_index(:ng_job_schedules, [:job_key],
                     name: "ng_job_schedules_unique_job_key_index"
                   )

    drop table(:ng_job_schedules, prefix: prefix())

    drop_if_exists unique_index(:ng_users, [:email], name: "ng_users_email_index")

    drop constraint(:ng_users, "ng_users_tenant_id_fkey")

    drop table(:ng_users, prefix: prefix())

    drop table(:ocsf_agents, prefix: prefix())

    drop table(:ocsf_devices, prefix: prefix())

    drop_if_exists unique_index(:partitions, [:tenant_id, :slug],
                     name: "partitions_unique_slug_per_tenant_index"
                   )

    alter table(:partitions, prefix: prefix()) do
      remove :tenant_id
      remove :updated_at
      remove :created_at
      remove :metadata
      remove :proxy_endpoint
      remove :connectivity_type
      remove :environment
      remove :region
      remove :site
      remove :dns_servers
      remove :default_gateway
      remove :cidr_ranges
      remove :enabled
      remove :description
      remove :slug
      remove :name
    end

    drop constraint(:polling_schedules, "polling_schedules_assigned_partition_id_fkey")

    alter table(:polling_schedules, prefix: prefix()) do
      modify :assigned_partition_id, :uuid
    end

    drop table(:partitions, prefix: prefix())

    drop_if_exists unique_index(:poll_jobs, [:id], name: "poll_jobs_unique_job_index")

    drop constraint(:poll_jobs, "poll_jobs_schedule_id_fkey")

    drop table(:poll_jobs, prefix: prefix())

    drop table(:polling_schedules, prefix: prefix())

    drop table(:service_checks, prefix: prefix())

    drop_if_exists unique_index(:tenant_cas, [:tenant_id, :status],
                     name: "tenant_cas_unique_active_tenant_ca_index"
                   )

    drop constraint(:tenant_cas, "tenant_cas_tenant_id_fkey")

    drop_if_exists index(:tenant_cas, [:spki_sha256])

    drop table(:tenant_cas, prefix: prefix())

    drop table(:user_tokens, prefix: prefix())
  end
end
