defmodule ServiceRadar.Repo.Migrations.AddObservabilityTables do
  @moduledoc """
  Updates resources based on their most recent snapshots.

  This file was autogenerated with `mix ash_postgres.generate_migrations`
  """

  use Ecto.Migration

  def up do
    create table(:timeseries_metrics, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :timestamp, :utc_datetime, null: false
      add :metric_name, :text, null: false
      add :metric_type, :text
      add :value, :float
      add :uid, :text
      add :poller_id, :text
      add :agent_id, :text
      add :target_device_ip, :text
      add :partition, :text
      add :if_index, :bigint
      add :labels, :map, default: %{}
      add :tenant_id, :uuid, null: false
    end

    create table(:otel_trace_summaries, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :time_bucket, :utc_datetime, null: false
      add :service_name, :text
      add :operation_name, :text
      add :total_traces, :bigint, default: 0
      add :error_traces, :bigint, default: 0
      add :avg_duration_ms, :float
      add :min_duration_ms, :float
      add :max_duration_ms, :float
      add :p50_duration_ms, :float
      add :p95_duration_ms, :float
      add :p99_duration_ms, :float
      add :requests_per_second, :float
      add :uid, :text
      add :poller_id, :text
      add :agent_id, :text
      add :tenant_id, :uuid, null: false
    end

    create table(:memory_metrics, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :timestamp, :utc_datetime, null: false
      add :total_bytes, :bigint
      add :used_bytes, :bigint
      add :free_bytes, :bigint
      add :available_bytes, :bigint
      add :buffers_bytes, :bigint
      add :cached_bytes, :bigint
      add :swap_total_bytes, :bigint
      add :swap_used_bytes, :bigint
      add :used_pct, :float
      add :uid, :text
      add :host_id, :text
      add :poller_id, :text
      add :agent_id, :text
      add :partition, :text
      add :tenant_id, :uuid, null: false
    end

    create table(:logs, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :timestamp, :utc_datetime, null: false
      add :severity, :bigint, default: 1
      add :severity_name, :text
      add :message, :text
      add :short_message, :text
      add :source, :text
      add :source_type, :text
      add :uid, :text
      add :poller_id, :text
      add :agent_id, :text
      add :category, :text
      add :facility, :bigint
      add :metadata, :map, default: %{}
      add :tags, {:array, :text}, default: []
      add :tenant_id, :uuid, null: false

      add :created_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create unique_index(:logs, [:tenant_id, :timestamp, :source, :message],
             name: "logs_unique_log_index"
           )

    create table(:disk_metrics, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :timestamp, :utc_datetime, null: false
      add :mount_point, :text
      add :device_name, :text
      add :filesystem_type, :text
      add :total_bytes, :bigint
      add :used_bytes, :bigint
      add :free_bytes, :bigint
      add :used_pct, :float
      add :inodes_total, :bigint
      add :inodes_used, :bigint
      add :inodes_free, :bigint
      add :uid, :text
      add :host_id, :text
      add :poller_id, :text
      add :agent_id, :text
      add :partition, :text
      add :tenant_id, :uuid, null: false
    end

    create table(:cpu_metrics, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :timestamp, :utc_datetime, null: false
      add :user_pct, :float
      add :system_pct, :float
      add :idle_pct, :float
      add :iowait_pct, :float
      add :steal_pct, :float
      add :core_id, :text
      add :label, :text
      add :uid, :text
      add :host_id, :text
      add :poller_id, :text
      add :agent_id, :text
      add :partition, :text
      add :cluster, :text
      add :tenant_id, :uuid, null: false
    end
  end

  def down do
    drop table(:cpu_metrics)

    drop table(:disk_metrics)

    drop_if_exists unique_index(:logs, [:tenant_id, :timestamp, :source, :message],
                     name: "logs_unique_log_index"
                   )

    drop table(:logs)

    drop table(:memory_metrics)

    drop table(:otel_trace_summaries)

    drop table(:timeseries_metrics)
  end
end
