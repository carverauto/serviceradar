defmodule ServiceRadar.Repo.Migrations.InitialSchema do
  @moduledoc """
  Updates resources based on their most recent snapshots.

  This file was autogenerated with `mix ash_postgres.generate_migrations`
  """

  use Ecto.Migration

  def up do
    create table(:user_tokens, primary_key: false) do
      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :created_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :extra_data, :map
      add :purpose, :text, null: false
      add :expires_at, :utc_datetime, null: false
      add :subject, :text, null: false
      add :jti, :text, null: false, primary_key: true
    end

    create table(:tenants, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :name, :text, null: false
      add :slug, :citext, null: false
      add :status, :text, null: false, default: "active"
      add :settings, :map, default: %{}
      add :plan, :text, default: "free"
      add :max_devices, :bigint, default: 100
      add :max_users, :bigint, default: 5
      add :contact_email, :text
      add :contact_name, :text

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create unique_index(:tenants, [:slug], name: "tenants_unique_slug_index")

    create table(:service_checks, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :name, :text, null: false
      add :description, :text
      add :check_type, :text, null: false
      add :target, :text, null: false
      add :port, :bigint
      add :interval_seconds, :bigint, default: 60
      add :timeout_seconds, :bigint, default: 10
      add :retries, :bigint, default: 3
      add :enabled, :boolean, default: true
      add :config, :map, default: %{}
      add :warning_threshold_ms, :bigint
      add :critical_threshold_ms, :bigint
      add :last_check_at, :utc_datetime
      add :last_result, :text
      add :last_response_time_ms, :bigint
      add :last_error, :text
      add :consecutive_failures, :bigint, default: 0
      add :agent_uid, :text
      add :device_uid, :text
      add :metadata, :map, default: %{}
      add :schedule_id, :uuid
      add :tenant_id, :uuid, null: false

      add :created_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create table(:polling_schedules, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :name, :text, null: false
      add :description, :text
      add :schedule_type, :text, null: false, default: "interval"
      add :interval_seconds, :bigint
      add :cron_expression, :text
      add :assignment_mode, :text, null: false, default: "any"
      add :assigned_poller_id, :text
      add :assigned_partition_id, :uuid
      add :enabled, :boolean, default: true
      add :priority, :bigint, default: 0
      add :max_concurrent, :bigint, default: 10
      add :timeout_seconds, :bigint, default: 60
      add :last_executed_at, :utc_datetime
      add :last_result, :text
      add :last_check_count, :bigint, default: 0
      add :last_success_count, :bigint, default: 0
      add :last_failure_count, :bigint, default: 0
      add :execution_count, :bigint, default: 0
      add :consecutive_failures, :bigint, default: 0
      add :lock_token, :uuid
      add :locked_at, :utc_datetime
      add :locked_by, :text
      add :metadata, :map, default: %{}
      add :tenant_id, :uuid, null: false

      add :created_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create table(:pollers, primary_key: false) do
      add :poller_id, :text, null: false, primary_key: true
      add :component_id, :text
      add :registration_source, :text
      add :status, :text, default: "active"
      add :spiffe_identity, :text
      add :first_registered, :utc_datetime
      add :first_seen, :utc_datetime
      add :last_seen, :utc_datetime
      add :metadata, :map, default: %{}
      add :created_by, :text
      add :is_healthy, :boolean, default: true
      add :agent_count, :bigint, default: 0
      add :checker_count, :bigint, default: 0
      add :updated_at, :utc_datetime
      add :tenant_id, :uuid, null: false
      add :partition_id, :uuid
    end

    create table(:partitions, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
    end

    alter table(:polling_schedules) do
      modify :assigned_partition_id,
             references(:partitions,
               column: :id,
               name: "polling_schedules_assigned_partition_id_fkey",
               type: :uuid,
               prefix: "public"
             )
    end

    alter table(:pollers) do
      modify :partition_id,
             references(:partitions,
               column: :id,
               name: "pollers_partition_id_fkey",
               type: :uuid,
               prefix: "public"
             )
    end

    create unique_index(:pollers, [:tenant_id, :poller_id],
             name: "pollers_unique_poller_id_index"
           )

    alter table(:partitions) do
      add :name, :text, null: false
      add :slug, :text, null: false
      add :description, :text
      add :enabled, :boolean, default: true
      add :cidr_ranges, {:array, :text}, default: []
      add :default_gateway, :text
      add :dns_servers, {:array, :text}, default: []
      add :site, :text
      add :region, :text
      add :environment, :text, default: "production"
      add :connectivity_type, :text, default: "direct"
      add :proxy_endpoint, :text
      add :metadata, :map, default: %{}
      add :created_at, :utc_datetime
      add :updated_at, :utc_datetime
      add :tenant_id, :uuid, null: false
    end

    create unique_index(:partitions, [:tenant_id, :slug],
             name: "partitions_unique_slug_per_tenant_index"
           )

    create table(:ocsf_devices, primary_key: false) do
      add :uid, :text, null: false, primary_key: true
      add :type_id, :bigint, default: 0
      add :type, :text
      add :name, :text
      add :hostname, :text
      add :ip, :text
      add :mac, :text
      add :uid_alt, :text
      add :vendor_name, :text
      add :model, :text
      add :domain, :text
      add :zone, :text
      add :subnet_uid, :text
      add :vlan_uid, :text
      add :region, :text
      add :first_seen_time, :utc_datetime
      add :last_seen_time, :utc_datetime
      add :created_time, :utc_datetime
      add :modified_time, :utc_datetime
      add :risk_level_id, :bigint
      add :risk_level, :text
      add :risk_score, :bigint
      add :is_managed, :boolean, default: false
      add :is_compliant, :boolean
      add :is_trusted, :boolean, default: false
      add :os, :map, default: %{}
      add :hw_info, :map, default: %{}
      add :network_interfaces, {:array, :map}, default: []
      add :owner, :map, default: %{}
      add :org, :map, default: %{}
      add :groups, {:array, :map}, default: []
      add :agent_list, {:array, :map}, default: []
      add :poller_id, :text
      add :agent_id, :text
      add :discovery_sources, {:array, :text}, default: []
      add :is_available, :boolean, default: true
      add :metadata, :map, default: %{}
      add :tenant_id, :uuid, null: false
    end

    create unique_index(:ocsf_devices, [:tenant_id, :uid], name: "ocsf_devices_unique_uid_index")

    create table(:ocsf_agents, primary_key: false) do
      add :uid, :text, null: false, primary_key: true
      add :name, :text
      add :type_id, :bigint, default: 0
      add :type, :text
      add :uid_alt, :text
      add :vendor_name, :text, default: "ServiceRadar"
      add :version, :text
      add :policies, {:array, :map}, default: []

      add :poller_id,
          references(:pollers,
            column: :poller_id,
            name: "ocsf_agents_poller_id_fkey",
            type: :text,
            prefix: "public"
          )

      add :device_uid,
          references(:ocsf_devices,
            column: :uid,
            name: "ocsf_agents_device_uid_fkey",
            type: :text,
            prefix: "public"
          )

      add :capabilities, {:array, :text}, default: []
      add :host, :text
      add :port, :bigint
      add :spiffe_identity, :text
      add :status, :text, null: false, default: "connecting"
      add :is_healthy, :boolean, default: true
      add :first_seen_time, :utc_datetime
      add :last_seen_time, :utc_datetime
      add :created_time, :utc_datetime
      add :modified_time, :utc_datetime
      add :metadata, :map, default: %{}
      add :tenant_id, :uuid, null: false
    end

    create unique_index(:ocsf_agents, [:tenant_id, :uid], name: "ocsf_agents_unique_uid_index")

    alter table(:service_checks) do
      modify :agent_uid,
             references(:ocsf_agents,
               column: :uid,
               name: "service_checks_agent_uid_fkey",
               type: :text,
               prefix: "public"
             )

      modify :device_uid,
             references(:ocsf_devices,
               column: :uid,
               name: "service_checks_device_uid_fkey",
               type: :text,
               prefix: "public"
             )

      modify :schedule_id,
             references(:polling_schedules,
               column: :id,
               name: "service_checks_schedule_id_fkey",
               type: :uuid,
               prefix: "public"
             )
    end

    create table(:ng_users, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :email, :citext, null: false
      add :hashed_password, :text
      add :display_name, :text
      add :role, :text, null: false, default: "viewer"
      add :confirmed_at, :utc_datetime

      add :tenant_id,
          references(:tenants,
            column: :id,
            name: "ng_users_tenant_id_fkey",
            type: :uuid,
            prefix: "public"
          ), null: false

      add :inserted_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create unique_index(:ng_users, [:tenant_id, :email], name: "ng_users_unique_email_index")

    create unique_index(:ng_users, [:tenant_id, :email],
             name: "ng_users_unique_email_per_tenant_index"
           )

    create table(:monitoring_events, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :category, :text, null: false
      add :event_type, :text, null: false
      add :severity, :bigint, default: 1
      add :message, :text, null: false
      add :details, :text
      add :source_type, :text
      add :source_id, :text
      add :source_name, :text
      add :target_type, :text
      add :target_id, :text
      add :target_name, :text

      add :device_uid,
          references(:ocsf_devices,
            column: :uid,
            name: "monitoring_events_device_uid_fkey",
            type: :text,
            prefix: "public"
          )

      add :agent_uid,
          references(:ocsf_agents,
            column: :uid,
            name: "monitoring_events_agent_uid_fkey",
            type: :text,
            prefix: "public"
          )

      add :alert_id, :uuid
      add :metadata, :map, default: %{}
      add :tags, {:array, :text}, default: []
      add :actor_type, :text
      add :actor_id, :text
      add :actor_name, :text
      add :client_ip, :text
      add :occurred_at, :utc_datetime, null: false
      add :tenant_id, :uuid, null: false

      add :created_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end

    create table(:edge_onboarding_packages, primary_key: false) do
      add :package_id, :uuid,
        null: false,
        default: fragment("gen_random_uuid()"),
        primary_key: true

      add :label, :text, null: false
      add :component_id, :text
      add :component_type, :text, default: "poller"
      add :parent_type, :text
      add :parent_id, :text
      add :poller_id, :text
      add :site, :text
      add :status, :text, null: false, default: "issued"
      add :security_mode, :text, default: "spire"
      add :downstream_entry_id, :text
      add :downstream_spiffe_id, :text
      add :selectors, {:array, :text}, default: []
      add :checker_kind, :text
      add :checker_config_json, :map, default: %{}
      add :join_token_ciphertext, :text
      add :join_token_expires_at, :utc_datetime
      add :bundle_ciphertext, :text
      add :download_token_hash, :text
      add :download_token_expires_at, :utc_datetime
      add :created_by, :text, default: "system"
      add :delivered_at, :utc_datetime
      add :activated_at, :utc_datetime
      add :activated_from_ip, :text
      add :last_seen_spiffe_id, :text
      add :revoked_at, :utc_datetime
      add :deleted_at, :utc_datetime
      add :deleted_by, :text
      add :deleted_reason, :text
      add :metadata_json, :map, default: %{}
      add :kv_revision, :bigint
      add :notes, :text

      add :created_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :state, :text, null: false, default: "issued"
    end

    create table(:edge_onboarding_events, primary_key: false) do
      add :event_time, :utc_datetime_usec, null: false, primary_key: true

      add :package_id,
          references(:edge_onboarding_packages,
            column: :package_id,
            name: "edge_onboarding_events_package_id_fkey",
            type: :uuid,
            prefix: "public"
          ), primary_key: true, null: false

      add :event_type, :text, null: false
      add :actor, :text
      add :source_ip, :text
      add :details_json, :map, default: %{}
    end

    create table(:checkers, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :name, :text, null: false
      add :type, :text, null: false
      add :description, :text
      add :enabled, :boolean, default: true
      add :config, :map, default: %{}
      add :interval_seconds, :bigint, default: 60
      add :timeout_seconds, :bigint, default: 30
      add :retries, :bigint, default: 3
      add :target_type, :text, default: "agent"
      add :target_filter, :map, default: %{}

      add :agent_uid,
          references(:ocsf_agents,
            column: :uid,
            name: "checkers_agent_uid_fkey",
            type: :text,
            prefix: "public"
          )

      add :created_at, :utc_datetime
      add :updated_at, :utc_datetime
      add :tenant_id, :uuid, null: false
    end

    create table(:api_tokens, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
      add :name, :text, null: false
      add :description, :text
      add :token_hash, :text, null: false
      add :token_prefix, :text, null: false
      add :scope, :text, default: "read"
      add :enabled, :boolean, default: true
      add :expires_at, :utc_datetime
      add :last_used_at, :utc_datetime
      add :last_used_ip, :text
      add :use_count, :bigint, default: 0
      add :revoked_at, :utc_datetime
      add :revoked_by, :text
      add :metadata, :map, default: %{}
      add :created_at, :utc_datetime
      add :tenant_id, :uuid, null: false

      add :user_id,
          references(:ng_users,
            column: :id,
            name: "api_tokens_user_id_fkey",
            type: :uuid,
            prefix: "public"
          ), null: false
    end

    create table(:alerts, primary_key: false) do
      add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
    end

    alter table(:monitoring_events) do
      modify :alert_id,
             references(:alerts,
               column: :id,
               name: "monitoring_events_alert_id_fkey",
               type: :uuid,
               prefix: "public"
             )
    end

    alter table(:alerts) do
      add :title, :text, null: false
      add :description, :text
      add :severity, :text, null: false, default: "warning"
      add :status, :text, null: false, default: "pending"
      add :source_type, :text
      add :source_id, :text

      add :service_check_id,
          references(:service_checks,
            column: :id,
            name: "alerts_service_check_id_fkey",
            type: :uuid,
            prefix: "public"
          )

      add :device_uid,
          references(:ocsf_devices,
            column: :uid,
            name: "alerts_device_uid_fkey",
            type: :text,
            prefix: "public"
          )

      add :agent_uid,
          references(:ocsf_agents,
            column: :uid,
            name: "alerts_agent_uid_fkey",
            type: :text,
            prefix: "public"
          )

      add :metric_name, :text
      add :metric_value, :float
      add :threshold_value, :float
      add :comparison, :text
      add :triggered_at, :utc_datetime
      add :acknowledged_at, :utc_datetime
      add :acknowledged_by, :text
      add :resolved_at, :utc_datetime
      add :resolved_by, :text
      add :resolution_note, :text
      add :escalated_at, :utc_datetime
      add :escalation_level, :bigint, default: 0
      add :escalation_reason, :text
      add :notification_count, :bigint, default: 0
      add :last_notification_at, :utc_datetime
      add :suppressed_until, :utc_datetime
      add :metadata, :map, default: %{}
      add :tags, {:array, :text}, default: []
      add :tenant_id, :uuid, null: false

      add :created_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")

      add :updated_at, :utc_datetime_usec,
        null: false,
        default: fragment("(now() AT TIME ZONE 'utc')")
    end
  end

  def down do
    drop constraint(:alerts, "alerts_service_check_id_fkey")

    drop constraint(:alerts, "alerts_device_uid_fkey")

    drop constraint(:alerts, "alerts_agent_uid_fkey")

    alter table(:alerts) do
      remove :updated_at
      remove :created_at
      remove :tenant_id
      remove :tags
      remove :metadata
      remove :suppressed_until
      remove :last_notification_at
      remove :notification_count
      remove :escalation_reason
      remove :escalation_level
      remove :escalated_at
      remove :resolution_note
      remove :resolved_by
      remove :resolved_at
      remove :acknowledged_by
      remove :acknowledged_at
      remove :triggered_at
      remove :comparison
      remove :threshold_value
      remove :metric_value
      remove :metric_name
      remove :agent_uid
      remove :device_uid
      remove :service_check_id
      remove :source_id
      remove :source_type
      remove :status
      remove :severity
      remove :description
      remove :title
    end

    drop constraint(:monitoring_events, "monitoring_events_alert_id_fkey")

    alter table(:monitoring_events) do
      modify :alert_id, :uuid
    end

    drop table(:alerts)

    drop constraint(:api_tokens, "api_tokens_user_id_fkey")

    drop table(:api_tokens)

    drop constraint(:checkers, "checkers_agent_uid_fkey")

    drop table(:checkers)

    drop constraint(:edge_onboarding_events, "edge_onboarding_events_package_id_fkey")

    drop table(:edge_onboarding_events)

    drop table(:edge_onboarding_packages)

    drop constraint(:monitoring_events, "monitoring_events_device_uid_fkey")

    drop constraint(:monitoring_events, "monitoring_events_agent_uid_fkey")

    drop table(:monitoring_events)

    drop_if_exists unique_index(:ng_users, [:tenant_id, :email],
                     name: "ng_users_unique_email_per_tenant_index"
                   )

    drop_if_exists unique_index(:ng_users, [:tenant_id, :email],
                     name: "ng_users_unique_email_index"
                   )

    drop constraint(:ng_users, "ng_users_tenant_id_fkey")

    drop table(:ng_users)

    drop constraint(:service_checks, "service_checks_agent_uid_fkey")

    drop constraint(:service_checks, "service_checks_device_uid_fkey")

    drop constraint(:service_checks, "service_checks_schedule_id_fkey")

    alter table(:service_checks) do
      modify :schedule_id, :uuid
      modify :device_uid, :text
      modify :agent_uid, :text
    end

    drop_if_exists unique_index(:ocsf_agents, [:tenant_id, :uid],
                     name: "ocsf_agents_unique_uid_index"
                   )

    drop constraint(:ocsf_agents, "ocsf_agents_poller_id_fkey")

    drop constraint(:ocsf_agents, "ocsf_agents_device_uid_fkey")

    drop table(:ocsf_agents)

    drop_if_exists unique_index(:ocsf_devices, [:tenant_id, :uid],
                     name: "ocsf_devices_unique_uid_index"
                   )

    drop table(:ocsf_devices)

    drop_if_exists unique_index(:partitions, [:tenant_id, :slug],
                     name: "partitions_unique_slug_per_tenant_index"
                   )

    alter table(:partitions) do
      remove :tenant_id
      remove :updated_at
      remove :created_at
      remove :metadata
      remove :proxy_endpoint
      remove :connectivity_type
      remove :environment
      remove :region
      remove :site
      remove :dns_servers
      remove :default_gateway
      remove :cidr_ranges
      remove :enabled
      remove :description
      remove :slug
      remove :name
    end

    drop_if_exists unique_index(:pollers, [:tenant_id, :poller_id],
                     name: "pollers_unique_poller_id_index"
                   )

    drop constraint(:pollers, "pollers_partition_id_fkey")

    alter table(:pollers) do
      modify :partition_id, :uuid
    end

    drop constraint(:polling_schedules, "polling_schedules_assigned_partition_id_fkey")

    alter table(:polling_schedules) do
      modify :assigned_partition_id, :uuid
    end

    drop table(:partitions)

    drop table(:pollers)

    drop table(:polling_schedules)

    drop table(:service_checks)

    drop_if_exists unique_index(:tenants, [:slug], name: "tenants_unique_slug_index")

    drop table(:tenants)

    drop table(:user_tokens)
  end
end
