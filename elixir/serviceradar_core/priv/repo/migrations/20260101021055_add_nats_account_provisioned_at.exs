defmodule ServiceRadar.Repo.Migrations.AddNatsAccountProvisionedAt do
  @moduledoc """
  Updates resources based on their most recent snapshots.

  This file was autogenerated with `mix ash_postgres.generate_migrations`
  """

  use Ecto.Migration

  def up do
    alter table(:tenants) do
      add :nats_account_provisioned_at, :utc_datetime_usec
    end

    # Backfill existing tenants that have NATS accounts
    execute """
    UPDATE tenants
    SET nats_account_provisioned_at = updated_at
    WHERE nats_account_status = 'ready'
      AND nats_account_public_key IS NOT NULL
    """
  end

  def down do
    alter table(:tenants) do
      remove :nats_account_provisioned_at
    end
  end
end
