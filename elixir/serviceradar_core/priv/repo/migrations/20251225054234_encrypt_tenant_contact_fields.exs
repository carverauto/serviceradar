defmodule ServiceRadar.Repo.Migrations.EncryptTenantContactFields do
  @moduledoc """
  Adds encrypted versions of tenant contact fields for AshCloak encryption.

  This migration:
  1. Adds encrypted_contact_email and encrypted_contact_name columns
  2. Encrypts existing data from the old columns (if Vault is available)
  3. Keeps old columns for rollback safety (can be removed in a future migration)

  This file was autogenerated with `mix ash_postgres.generate_migrations`
  and modified for safe production deployment.
  """

  use Ecto.Migration

  def up do
    # Add new encrypted columns
    alter table(:tenants) do
      add :encrypted_contact_email, :binary
      add :encrypted_contact_name, :binary
    end

    # Note: Data migration (encrypting existing values) should be done via a
    # separate mix task after the migration runs, when the Vault is available:
    #
    #   mix run -e 'ServiceRadar.Identity.Migrations.encrypt_tenant_contacts()'
    #
    # After verifying encryption works, remove old columns in a future migration.

    # Also handle edge_onboarding_packages state field removal
    # (state machine now uses status field instead)
    alter table(:edge_onboarding_packages) do
      remove_if_exists :state, :text
    end
  end

  def down do
    alter table(:edge_onboarding_packages) do
      add_if_not_exists :state, :text, null: false, default: "issued"
    end

    alter table(:tenants) do
      remove_if_exists :encrypted_contact_name, :binary
      remove_if_exists :encrypted_contact_email, :binary
    end
  end
end
