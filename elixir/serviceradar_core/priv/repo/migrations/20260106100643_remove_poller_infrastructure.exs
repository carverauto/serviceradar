defmodule ServiceRadar.Repo.Migrations.RemovePollerInfrastructure do
  @moduledoc """
  Updates resources based on their most recent snapshots.

  This file was autogenerated with `mix ash_postgres.generate_migrations`
  """

  use Ecto.Migration

  def up do
    alter table(:poll_jobs) do
      remove :poller_id
      add :gateway_id, :text
    end

    alter table(:integration_sources) do
      remove :sync_service_id
      remove :poller_id
      add :gateway_id, :text
    end

    drop_if_exists unique_index(:ng_users, [:tenant_id, :email],
                     name: "ng_users_unique_email_index"
                   )

    create unique_index(:ng_users, [:tenant_id, :email], name: "ng_users_email_index")

    alter table(:polling_schedules) do
      remove :assigned_poller_id
      add :assigned_gateway_id, :text
    end

    alter table(:edge_onboarding_packages) do
      remove :poller_id
      modify :component_type, :text, default: "gateway"
      add :gateway_id, :text
    end

    create table(:gateways, primary_key: false) do
      add :gateway_id, :text, null: false, primary_key: true
      add :component_id, :text
      add :registration_source, :text
      add :status, :text, null: false, default: "inactive"
      add :spiffe_identity, :text
      add :first_registered, :utc_datetime
      add :first_seen, :utc_datetime
      add :last_seen, :utc_datetime
      add :metadata, :map, default: %{}
      add :created_by, :text
      add :is_healthy, :boolean, default: true
      add :agent_count, :bigint, default: 0
      add :checker_count, :bigint, default: 0
      add :updated_at, :utc_datetime
      add :tenant_id, :uuid, null: false

      add :partition_id,
          references(:partitions,
            column: :id,
            name: "gateways_partition_id_fkey",
            type: :uuid,
            prefix: "public"
          )
    end

    create unique_index(:gateways, [:tenant_id, :gateway_id],
             name: "gateways_unique_gateway_id_index"
           )

    alter table(:ocsf_devices) do
      remove :poller_id
      add :gateway_id, :text
    end

    alter table(:discovered_interfaces) do
      remove :poller_id
      add :gateway_id, :text
    end

    alter table(:ocsf_agents) do
      remove :poller_id

      add :gateway_id,
          references(:gateways,
            column: :gateway_id,
            name: "ocsf_agents_gateway_id_fkey",
            type: :text,
            prefix: "public"
          )
    end

    drop_if_exists table(:pollers)
  end

  def down do
    drop constraint(:ocsf_agents, "ocsf_agents_gateway_id_fkey")

    create table(:pollers, primary_key: false) do
      add :poller_id, :text, null: false, primary_key: true
      add :component_id, :text
      add :registration_source, :text
      add :status, :text, null: false, default: "active"
      add :spiffe_identity, :text
      add :first_registered, :utc_datetime
      add :first_seen, :utc_datetime
      add :last_seen, :utc_datetime
      add :metadata, :map, default: %{}
      add :created_by, :text
      add :is_healthy, :boolean, default: true
      add :agent_count, :bigint, default: 0
      add :checker_count, :bigint, default: 0
      add :updated_at, :utc_datetime
      add :tenant_id, :uuid, null: false

      add :partition_id,
          references(:partitions,
            column: :id,
            name: "pollers_partition_id_fkey",
            type: :uuid,
            prefix: "public"
          )
    end

    create unique_index(:pollers, [:tenant_id, :poller_id],
             name: "pollers_unique_poller_id_index"
           )

    alter table(:ocsf_agents) do
      remove :gateway_id

      add :poller_id,
          references(:pollers,
            column: :poller_id,
            name: "ocsf_agents_poller_id_fkey",
            type: :text,
            prefix: "public"
          )
    end

    alter table(:discovered_interfaces) do
      remove :gateway_id
      add :poller_id, :text
    end

    alter table(:ocsf_devices) do
      remove :gateway_id
      add :poller_id, :text
    end

    drop_if_exists unique_index(:gateways, [:tenant_id, :gateway_id],
                     name: "gateways_unique_gateway_id_index"
                   )

    drop constraint(:gateways, "gateways_partition_id_fkey")

    drop table(:gateways)

    alter table(:edge_onboarding_packages) do
      remove :gateway_id
      modify :component_type, :text, default: "poller"
      add :poller_id, :text
    end

    alter table(:polling_schedules) do
      remove :assigned_gateway_id
      add :assigned_poller_id, :text
    end

    drop_if_exists unique_index(:ng_users, [:tenant_id, :email], name: "ng_users_email_index")

    create unique_index(:ng_users, [:tenant_id, :email], name: "ng_users_unique_email_index")

    alter table(:integration_sources) do
      remove :gateway_id
      add :poller_id, :text

      add :sync_service_id,
          references(:sync_services,
            column: :id,
            name: "integration_sources_sync_service_id_fkey",
            type: :uuid,
            prefix: "public"
          )
    end

    alter table(:poll_jobs) do
      remove :gateway_id
      add :poller_id, :text
    end
  end
end
