defmodule ServiceRadar.Repo.Migrations.AddDeviceGroups do
  @moduledoc """
  Updates resources based on their most recent snapshots.

  This file was autogenerated with `mix ash_postgres.generate_migrations`
  """

  use Ecto.Migration

  

  def up do
    alter table(:ocsf_devices) do
add :group_id, :uuid
end

create table(:merge_audit, primary_key: false) do
add :event_id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
add :from_device_id, :text, null: false
add :to_device_id, :text, null: false
add :reason, :text
add :confidence_score, :decimal
add :source, :text
add :details, :map, default: %{}
add :created_at, :utc_datetime
end

create table(:discovered_interfaces, primary_key: false) do
add :timestamp, :utc_datetime, null: false, primary_key: true
add :device_id, references(:ocsf_devices, column: :uid, name: "discovered_interfaces_device_id_fkey", type: :text, prefix: "public"), primary_key: true, null: false
add :if_index, :bigint, null: false, primary_key: true
add :agent_id, :text
add :poller_id, :text
add :device_ip, :text
add :if_name, :text
add :if_descr, :text
add :if_alias, :text
add :if_speed, :bigint
add :if_phys_address, :text
add :ip_addresses, {:array, :text}, default: []
add :if_admin_status, :bigint
add :if_oper_status, :bigint
add :metadata, :map, default: %{}
add :created_at, :utc_datetime
end



create table(:device_identifiers, primary_key: false) do
add :id, :bigserial, null: false, primary_key: true
add :device_id, references(:ocsf_devices, column: :uid, name: "device_identifiers_device_id_fkey", type: :text, prefix: "public"), null: false
add :identifier_type, :text, null: false
add :identifier_value, :text, null: false
add :partition, :text, default: "default"
add :confidence, :text, default: "strong"
add :source, :text
add :first_seen, :utc_datetime
add :last_seen, :utc_datetime
add :verified, :boolean, default: false
add :metadata, :map, default: %{}
end



create unique_index(:device_identifiers, [:identifier_type, :identifier_value, :partition], name: "device_identifiers_unique_identifier_index")

create table(:device_groups, primary_key: false) do
add :id, :uuid, null: false, default: fragment("gen_random_uuid()"), primary_key: true
end

alter table(:ocsf_devices) do
modify :group_id, references(:device_groups, column: :id, name: "ocsf_devices_group_id_fkey", type: :uuid, prefix: "public")
end



alter table(:device_groups) do
add :name, :text, null: false
add :desc, :text
add :type, :text, default: "custom"
add :parent_id, references(:device_groups, column: :id, name: "device_groups_parent_id_fkey", type: :uuid, prefix: "public")
add :metadata, :map, default: %{}
add :device_count, :bigint, default: 0
add :created_at, :utc_datetime_usec, null: false, default: fragment("(now() AT TIME ZONE 'utc')")
add :updated_at, :utc_datetime_usec, null: false, default: fragment("(now() AT TIME ZONE 'utc')")
add :tenant_id, :uuid, null: false
end



create unique_index(:device_groups, [:tenant_id, :name], name: "device_groups_unique_name_per_tenant_index")

  end

  def down do
    drop_if_exists unique_index(:device_groups, [:tenant_id, :name], name: "device_groups_unique_name_per_tenant_index")

drop constraint(:device_groups, "device_groups_parent_id_fkey")

alter table(:device_groups) do
remove :tenant_id
remove :updated_at
remove :created_at
remove :device_count
remove :metadata
remove :parent_id
remove :type
remove :desc
remove :name
end

drop constraint(:ocsf_devices, "ocsf_devices_group_id_fkey")

alter table(:ocsf_devices) do
modify :group_id, :uuid
end

drop table(:device_groups)

drop_if_exists unique_index(:device_identifiers, [:identifier_type, :identifier_value, :partition], name: "device_identifiers_unique_identifier_index")

drop constraint(:device_identifiers, "device_identifiers_device_id_fkey")

drop table(:device_identifiers)

drop constraint(:discovered_interfaces, "discovered_interfaces_device_id_fkey")

drop table(:discovered_interfaces)

drop table(:merge_audit)

alter table(:ocsf_devices) do
remove :group_id
end

  end
end
