defmodule ServiceRadar.Repo.Migrations.AddTenantCaSpkiHash do
  @moduledoc """
  Updates resources based on their most recent snapshots.

  This file was autogenerated with `mix ash_postgres.generate_migrations`
  """

  use Ecto.Migration

  def up do
    alter table(:tenant_cas) do
      add :spki_sha256, :text
    end

    flush()

    execute(fn ->
      repo = repo()

      import Ecto.Query, only: [from: 2]

      repo.all(
        from t in "tenant_cas",
          where: is_nil(t.spki_sha256),
          select: {t.id, t.certificate_pem}
      )
      |> Enum.each(fn {id, cert_pem} ->
        case ServiceRadar.Edge.TenantCA.Generator.spki_sha256_from_cert_pem(cert_pem) do
          {:ok, spki_sha256} ->
            repo.update_all(
              from(t in "tenant_cas", where: t.id == ^id),
              set: [spki_sha256: spki_sha256]
            )

          {:error, _} ->
            :ok
        end
      end)
    end)

    create unique_index(:tenant_cas, [:spki_sha256], where: "status = 'active'")
  end

  def down do
    drop_if_exists index(:tenant_cas, [:spki_sha256], where: "status = 'active'")

    alter table(:tenant_cas) do
      remove :spki_sha256
    end
  end
end
