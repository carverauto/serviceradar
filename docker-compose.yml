version: "3.9"

services:
  cert-generator:
    image: alpine:3.20
    container_name: serviceradar-cert-generator-mtls
    environment:
      # Optional extra SAN entries for `cnpg.pem` so clients can connect using a LAN IP
      # (example: CNPG_CERT_EXTRA_IPS=192.168.2.134)
      - CNPG_CERT_EXTRA_IPS=${CNPG_CERT_EXTRA_IPS:-}
    volumes:
      - cert-data:/certs
      - ./docker/compose/generate-certs.sh:/generate-certs.sh:ro
    command: sh -c "apk add --no-cache openssl bash && cp /generate-certs.sh /tmp/gen.sh && chmod +x /tmp/gen.sh && CERT_DIR=/certs bash /tmp/gen.sh"
    restart: "no"
    networks:
      - serviceradar-net

  cnpg:
    image: ghcr.io/carverauto/serviceradar-cnpg:16.6.0-sr3
    container_name: serviceradar-cnpg-mtls
    user: "0:0"
    depends_on:
      cert-generator:
        condition: service_completed_successfully
    command:
      - "postgres"
      - "-c"
      - "shared_preload_libraries=timescaledb,age"
      - "-c"
      - "ssl=on"
      - "-c"
      - "ssl_cert_file=/etc/serviceradar/certs/cnpg.pem"
      - "-c"
      - "ssl_key_file=/etc/serviceradar/certs/cnpg-key.pem"
      - "-c"
      - "ssl_ca_file=/etc/serviceradar/certs/root.pem"
      - "-c"
      - "hba_file=/etc/serviceradar/pg_hba.conf"
      - "-c"
      - "ident_file=/etc/serviceradar/pg_ident.conf"
    environment:
      - POSTGRES_USER=${CNPG_USERNAME:-serviceradar}
      - POSTGRES_PASSWORD=${CNPG_PASSWORD:-serviceradar}
      - POSTGRES_DB=${CNPG_DATABASE:-serviceradar}
      - TS_TUNE=false
    ports:
      - "${CNPG_PUBLIC_BIND:-0.0.0.0}:${CNPG_PUBLIC_PORT:-5455}:5432"
    volumes:
      - cnpg-data:/var/lib/postgresql/data
      - ./docker/compose/cnpg-init.sql:/docker-entrypoint-initdb.d/001-init.sql:ro
      - cert-data:/etc/serviceradar/certs:ro
      - ./docker/compose/pg_hba.conf:/etc/serviceradar/pg_hba.conf:ro
      - ./docker/compose/pg_ident.conf:/etc/serviceradar/pg_ident.conf:ro
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "set -e; cp /etc/serviceradar/certs/db-client-key.pem /tmp/pg_healthcheck.key; chmod 600 /tmp/pg_healthcheck.key; PGSSLMODE=verify-full PGSSLROOTCERT=/etc/serviceradar/certs/root.pem PGSSLCERT=/etc/serviceradar/certs/db-client.pem PGSSLKEY=/tmp/pg_healthcheck.key pg_isready -h localhost -U ${CNPG_USERNAME:-serviceradar} -d ${CNPG_DATABASE:-serviceradar}"
        ]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 10s
    networks:
      serviceradar-net:
        aliases:
          - cnpg
          - cnpg-rw
    restart: unless-stopped

  cnpg-migrate:
    image: ghcr.io/carverauto/serviceradar-tools:${APP_TAG:-latest}
    container_name: serviceradar-cnpg-migrate
    command: ["cnpg-migrate"]
    environment:
      - CNPG_HOST=${CNPG_DOCKER_HOST:-cnpg}
      - CNPG_PORT=${CNPG_DOCKER_PORT:-5432}
      - CNPG_DATABASE=${CNPG_DATABASE:-serviceradar}
      - CNPG_USERNAME=${CNPG_USERNAME:-serviceradar}
      - CNPG_PASSWORD=${CNPG_PASSWORD:-serviceradar}
      - CNPG_SSLMODE=${CNPG_SSL_MODE:-verify-full}
      - CNPG_CERT_DIR=/etc/serviceradar/certs
      - CNPG_CA_FILE=/etc/serviceradar/certs/root.pem
      - CNPG_CERT_FILE=/etc/serviceradar/certs/db-client.pem
      - CNPG_KEY_FILE=/etc/serviceradar/certs/db-client-key.pem
    volumes:
      - cert-data:/etc/serviceradar/certs:ro
    depends_on:
      cert-permissions-fixer:
        condition: service_completed_successfully
      cnpg:
        condition: service_healthy
    restart: "no"
    networks:
      - serviceradar-net

  cert-permissions-fixer:
    image: alpine:3.20
    container_name: serviceradar-cert-permissions-fixer-mtls
    volumes:
      - cert-data:/etc/serviceradar/certs
      - ./docker/compose/fix-cert-permissions.sh:/fix-cert-permissions.sh:ro
    command: sh /fix-cert-permissions.sh
    depends_on:
      cert-generator:
        condition: service_completed_successfully
    restart: "no"
    networks:
      - serviceradar-net

  cloak-keygen:
    image: alpine:3.20
    container_name: serviceradar-cloak-keygen
    environment:
      - CLOAK_KEY=${CLOAK_KEY:-MBkLP+XL4htJEQ2Tyi+g+E6Jru4eLd4r9hT4dxcOIeg=}
    volumes:
      - cloak-key:/etc/serviceradar/cloak
    command: >
      sh -c 'set -e;
      mkdir -p /etc/serviceradar/cloak;
      if [ ! -f /etc/serviceradar/cloak/cloak.key ]; then
        umask 077;
        if [ -n "${CLOAK_KEY:-}" ]; then
          printf "%s" "${CLOAK_KEY}" > /etc/serviceradar/cloak/cloak.key;
        else
          head -c 32 /dev/urandom | base64 | tr -d "\n" > /etc/serviceradar/cloak/cloak.key;
        fi;
        echo "Generated CLOAK_KEY";
      else
        echo "CLOAK_KEY already present";
      fi'
    restart: "no"
    networks:
      - serviceradar-net

  core-elx:
    image: ghcr.io/carverauto/serviceradar-core-elx:${APP_TAG:-latest}
    container_name: serviceradar-core-elx-mtls
    hostname: core-elx
    environment:
      - CLUSTER_ENABLED=true
      - CLUSTER_STRATEGY=epmd
      - CLUSTER_HOSTS=serviceradar_web_ng@web-ng,serviceradar_agent_gateway@agent-gateway,serviceradar_agent_gateway_t2@agent-gateway-t2
      - ENABLE_TLS_DIST=true
      - SSL_DIST_OPTFILE=/etc/serviceradar/ssl_dist.conf
      - ELIXIR_ERL_OPTIONS=${ELIXIR_ERL_OPTIONS:-+fnu}
      - SPIFFE_CERT_DIR=/etc/serviceradar/certs
      - RELEASE_NODE=serviceradar_core@core-elx
      - RELEASE_DISTRIBUTION=sname
      - RELEASE_COOKIE=${RELEASE_COOKIE:-serviceradar_dev_cookie}
      - SERVICERADAR_CORE_OBAN_ENABLED=${SERVICERADAR_CORE_OBAN_ENABLED:-true}
      - SERVICERADAR_CORE_REPO_ENABLED=${SERVICERADAR_CORE_REPO_ENABLED:-true}
      - SERVICERADAR_CORE_RUN_MIGRATIONS=${SERVICERADAR_CORE_RUN_MIGRATIONS:-true}
      - SERVICERADAR_RESET_TENANT_SCHEMAS=${SERVICERADAR_RESET_TENANT_SCHEMAS:-false}
      - SERVICERADAR_DEFAULT_TENANT_ID=${SERVICERADAR_DEFAULT_TENANT_ID:-00000000-0000-0000-0000-000000000000}
      - SERVICERADAR_PLATFORM_TENANT_ID=${SERVICERADAR_PLATFORM_TENANT_ID:-}
      - SERVICERADAR_PLATFORM_TENANT_SLUG=${SERVICERADAR_PLATFORM_TENANT_SLUG:-platform}
      - SERVICERADAR_LOCAL_MAILER=${SERVICERADAR_LOCAL_MAILER:-false}
      - CLOAK_KEY=${CLOAK_KEY:-}
      - CLOAK_KEY_FILE=/etc/serviceradar/cloak/cloak.key
      - POOL_SIZE=${POOL_SIZE:-20}
      - DATABASE_QUEUE_TARGET_MS=${DATABASE_QUEUE_TARGET_MS:-500}
      - DATABASE_QUEUE_INTERVAL_MS=${DATABASE_QUEUE_INTERVAL_MS:-500}
      - SYNC_INGESTOR_BATCH_CONCURRENCY=${SYNC_INGESTOR_BATCH_CONCURRENCY:-2}
      - SYNC_INGESTOR_MAX_INFLIGHT=${SYNC_INGESTOR_MAX_INFLIGHT:-2}
      - SYNC_INGESTOR_ASYNC=${SYNC_INGESTOR_ASYNC:-true}
      - CNPG_HOST=${CNPG_DOCKER_HOST:-cnpg}
      - CNPG_PORT=${CNPG_DOCKER_PORT:-5432}
      - CNPG_DATABASE=${CNPG_DATABASE:-serviceradar}
      - CNPG_USERNAME=${CNPG_USERNAME:-serviceradar}
      - CNPG_PASSWORD=${CNPG_PASSWORD:-serviceradar}
      - CNPG_SSL_MODE=${CNPG_SSL_MODE:-verify-full}
      - CNPG_TLS_SERVER_NAME=${CNPG_TLS_SERVER_NAME:-cnpg}
      - CNPG_CERT_DIR=/etc/serviceradar/certs
      - CNPG_CERT_FILE=/etc/serviceradar/certs/db-client.pem
      - CNPG_KEY_FILE=/etc/serviceradar/certs/db-client-key.pem
      # Datasvc gRPC client configuration
      - DATASVC_HOST=datasvc
      - DATASVC_PORT=50057
      - DATASVC_SSL=true
      - DATASVC_CERT_DIR=/etc/serviceradar/certs
      - DATASVC_CERT_NAME=core
      # EventWriter configuration (replaces Go db-event-writer)
      - EVENT_WRITER_ENABLED=${EVENT_WRITER_ENABLED:-true}
      - EVENT_WRITER_NATS_URL=nats://nats:4222
      - EVENT_WRITER_NATS_TLS=true
      - EVENT_WRITER_NATS_CREDS_FILE=/etc/serviceradar/creds/platform.creds
      - EVENT_WRITER_BATCH_SIZE=${EVENT_WRITER_BATCH_SIZE:-100}
      - EVENT_WRITER_BATCH_TIMEOUT=${EVENT_WRITER_BATCH_TIMEOUT:-1000}
      - NATS_ENABLED=true
      - NATS_URL=nats://nats:4222
      - NATS_TLS=true
      - NATS_SERVER_NAME=nats.serviceradar
      - NATS_CREDS_FILE=/etc/serviceradar/creds/platform.creds
    volumes:
      - cert-data:/etc/serviceradar/certs:ro
      - ./docker/compose/ssl_dist.core.conf:/etc/serviceradar/ssl_dist.conf:ro
      - cloak-key:/etc/serviceradar/cloak:ro
      - ${NATS_CREDS_DIR:-./docker/compose/creds}:/etc/serviceradar/creds:ro
    depends_on:
      cert-permissions-fixer:
        condition: service_completed_successfully
      cloak-keygen:
        condition: service_completed_successfully
      cnpg:
        condition: service_healthy
      cnpg-migrate:
        condition: service_completed_successfully
      nats:
        condition: service_started
    healthcheck:
      test: ["CMD", "/app/bin/serviceradar_core_elx", "pid"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 60s
    networks:
      - serviceradar-net
    restart: unless-stopped

  # Bootstrap NATS operator/account credentials (idempotent).
  nats-creds-init:
    image: ghcr.io/carverauto/serviceradar-tools:${APP_TAG:-latest}
    container_name: serviceradar-nats-creds-init
    volumes:
      - ${NATS_CREDS_DIR:-./docker/compose/creds}:/etc/serviceradar/creds
      - ./docker/compose/creds:/seed/creds:ro
    environment:
      - NATS_OPERATOR_NAME=${NATS_OPERATOR_NAME:-serviceradar-dev}
      - NATS_OPERATOR_SEED=${NATS_OPERATOR_SEED:-}
      - NATS_SYSTEM_ACCOUNT_PUBLIC_KEY=${NATS_SYSTEM_ACCOUNT_PUBLIC_KEY:-}
    command:
      - bash
      - -c
      - |
          set -euo pipefail
          creds_dir="/etc/serviceradar/creds"
          seed_dir="/seed/creds"
          if [ -f "$${creds_dir}/operator.jwt" ]; then
            if [ ! -f "$${creds_dir}/operator.seed" ]; then
              if [ -n "$${NATS_OPERATOR_SEED}" ]; then
                echo "Persisting operator seed to creds volume."
                echo "$${NATS_OPERATOR_SEED}" > "$${creds_dir}/operator.seed"
                chmod 0600 "$${creds_dir}/operator.seed"
              else
                echo "Warning: operator.seed missing and NATS_OPERATOR_SEED not set; tenant account provisioning will fail."
              fi
            fi
            if [ ! -f "$${creds_dir}/system_account.pub" ] && [ -n "$${NATS_SYSTEM_ACCOUNT_PUBLIC_KEY}" ]; then
              echo "$${NATS_SYSTEM_ACCOUNT_PUBLIC_KEY}" > "$${creds_dir}/system_account.pub"
              chmod 0644 "$${creds_dir}/system_account.pub"
            fi
            echo "NATS creds already present; skipping bootstrap."
            exit 0
          fi
          mkdir -p "$${creds_dir}"
          if [ -f "$${seed_dir}/operator.jwt" ]; then
            echo "Copying seed NATS creds into volume."
            cp -a "$${seed_dir}/." "$${creds_dir}/"
            if [ ! -f "$${creds_dir}/operator.seed" ] && [ -n "$${NATS_OPERATOR_SEED}" ]; then
              echo "Persisting operator seed to creds volume."
              echo "$${NATS_OPERATOR_SEED}" > "$${creds_dir}/operator.seed"
              chmod 0600 "$${creds_dir}/operator.seed"
            fi
            if [ ! -f "$${creds_dir}/system_account.pub" ] && [ -n "$${NATS_SYSTEM_ACCOUNT_PUBLIC_KEY}" ]; then
              echo "$${NATS_SYSTEM_ACCOUNT_PUBLIC_KEY}" > "$${creds_dir}/system_account.pub"
              chmod 0644 "$${creds_dir}/system_account.pub"
            fi
            exit 0
          fi
          args=(nats-bootstrap --local --output-dir "$${creds_dir}" --operator-name "$${NATS_OPERATOR_NAME}" --output json)
          if [ -n "$${NATS_OPERATOR_SEED}" ]; then
            args+=(--import-operator-seed "$${NATS_OPERATOR_SEED}")
          fi
          serviceradar-cli "$${args[@]}"
          if [ ! -f "$${creds_dir}/operator.seed" ] && [ -n "$${NATS_OPERATOR_SEED}" ]; then
            echo "Persisting operator seed to creds volume."
            echo "$${NATS_OPERATOR_SEED}" > "$${creds_dir}/operator.seed"
            chmod 0600 "$${creds_dir}/operator.seed"
          fi
          if [ ! -f "$${creds_dir}/system_account.pub" ] && [ -n "$${NATS_SYSTEM_ACCOUNT_PUBLIC_KEY}" ]; then
            echo "$${NATS_SYSTEM_ACCOUNT_PUBLIC_KEY}" > "$${creds_dir}/system_account.pub"
            chmod 0644 "$${creds_dir}/system_account.pub"
          fi
    restart: "no"
    networks:
      - serviceradar-net

  # Initialize NATS resolver directory for account JWT persistence
  nats-config-init:
    image: alpine:3.20
    container_name: serviceradar-nats-config-init
    volumes:
      - nats-data:/data
      - ${NATS_CREDS_DIR:-./docker/compose/creds}:/etc/serviceradar/creds:ro
    depends_on:
      nats-creds-init:
        condition: service_completed_successfully
    command:
      - sh
      - -c
      - |
          set -e
          mkdir -p /data/jwt
          if [ -d /etc/serviceradar/creds/jwt ]; then
            find /etc/serviceradar/creds/jwt -maxdepth 1 -type f -name '*.jwt' -exec cp {} /data/jwt/ \;
            echo 'Seeded account JWTs from creds/jwt'
          fi
          if [ -f /etc/serviceradar/creds/system.jwt ] && [ -f /etc/serviceradar/creds/system_account.pub ]; then
            system_key="$$(cat /etc/serviceradar/creds/system_account.pub)"
            if [ -n "$${system_key}" ]; then
              cp /etc/serviceradar/creds/system.jwt "/data/jwt/$${system_key}.jwt"
              echo 'Seeded system account JWT'
            fi
          fi
          echo 'Prepared NATS resolver directory'
    restart: "no"
    networks:
      - serviceradar-net

  nats:
    image: nats:latest
    platform: linux/amd64
    container_name: serviceradar-nats-mtls
    ports:
      - "4222:4222"
      - "8222:8222"
      - "6222:6222"
    volumes:
      - nats-data:/data
      - cert-data:/etc/serviceradar/certs:ro
      - ${NATS_CREDS_DIR:-./docker/compose/creds}:/etc/serviceradar/creds:ro
      - ./docker/compose/nats.docker.conf:/etc/nats/nats-server.conf:ro
    command: ["--config", "/etc/nats/nats-server.conf"]
    depends_on:
      cert-generator:
        condition: service_completed_successfully
      cert-permissions-fixer:
        condition: service_completed_successfully
      nats-config-init:
        condition: service_completed_successfully
    networks:
      serviceradar-net:
        aliases:
          - nats.serviceradar
    restart: unless-stopped

  datasvc:
    image: ghcr.io/carverauto/serviceradar-datasvc:${APP_TAG:-latest}
    container_name: serviceradar-datasvc-mtls
    cpus: "2.0"
    ports:
      - "50057:50057"
    volumes:
      - ./docker/compose/datasvc.mtls.json:/etc/serviceradar/datasvc.json:ro
      - cert-data:/etc/serviceradar/certs:ro
      - ${NATS_CREDS_DIR:-./docker/compose/creds}:/etc/serviceradar/creds:ro
      - datasvc-data:/var/lib/serviceradar
      - ./logs:/var/log/serviceradar
    environment:
      - CONFIG_PATH=/etc/serviceradar/datasvc.json
      - WAIT_FOR_NATS=true
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - NATS_OPERATOR_SEED=${NATS_OPERATOR_SEED:-}
      - NATS_SYSTEM_ACCOUNT_PUBLIC_KEY=${NATS_SYSTEM_ACCOUNT_PUBLIC_KEY:-}
    depends_on:
      cert-generator:
        condition: service_completed_successfully
      nats:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "wait-for-port --host 127.0.0.1 --port 50057 --attempts 1 --interval 1s --quiet"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      serviceradar-net:
        aliases:
          - datasvc.serviceradar
    restart: unless-stopped

  agent:
    image: ghcr.io/carverauto/serviceradar-agent:${APP_TAG:-latest}
    container_name: serviceradar-agent-mtls
    hostname: agent
    ports:
      - "50051:50051"
    volumes:
      - ./docker/compose/agent.mtls.json:/etc/serviceradar/agent.json:ro
      - cert-data:/etc/serviceradar/certs:ro
      - ./logs:/var/log/serviceradar
    environment:
      - CONFIG_PATH=/etc/serviceradar/agent.json
      - LOG_LEVEL=${LOG_LEVEL:-info}
    depends_on:
      cert-permissions-fixer:
        condition: service_completed_successfully
      datasvc:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wait-for-port --host 127.0.0.1 --port 50051 --attempts 1 --interval 1s --quiet"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      serviceradar-net:
        aliases:
          - agent.serviceradar
    restart: unless-stopped

  faker:
    image: ghcr.io/carverauto/serviceradar-faker:${APP_TAG:-latest}
    container_name: serviceradar-faker-mtls
    hostname: faker
    ports:
      - "8081:8080"
    volumes:
      - ./logs:/var/log/serviceradar
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-info}
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 8080 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      serviceradar-net:
        aliases:
          - faker.serviceradar
    restart: unless-stopped

  agent-gateway:
    image: ghcr.io/carverauto/serviceradar-agent-gateway:${APP_TAG:-latest}
    container_name: serviceradar-agent-gateway-mtls
    hostname: agent-gateway
    environment:
      # Optional: tenant_id is auto-discovered from core via cluster RPC if not set
      - GATEWAY_TENANT_ID=${SERVICERADAR_PLATFORM_TENANT_ID:-}
      - GATEWAY_TENANT_SLUG=${GATEWAY_TENANT_SLUG:-platform}
      - GATEWAY_PARTITION_ID=${GATEWAY_PARTITION_ID:-default}
      - GATEWAY_ID=${GATEWAY_ID:-docker-gateway}
      - GATEWAY_DOMAIN=${GATEWAY_DOMAIN:-default}
      - GATEWAY_GRPC_PORT=50052
      # Disable StateMonitor - agent-gateway has no database
      - STATE_MONITOR_ENABLED=false
      - CLUSTER_ENABLED=true
      - CLUSTER_STRATEGY=epmd
      - CLUSTER_HOSTS=serviceradar_web_ng@web-ng,serviceradar_core@core-elx
      - ENABLE_TLS_DIST=true
      - SSL_DIST_OPTFILE=/etc/serviceradar/ssl_dist.conf
      - ELIXIR_ERL_OPTIONS=${ELIXIR_ERL_OPTIONS:-+fnu}
      - SPIFFE_CERT_DIR=/etc/serviceradar/certs
      - SERVICERADAR_PLATFORM_TENANT_SLUG=${SERVICERADAR_PLATFORM_TENANT_SLUG:-platform}
      - RELEASE_NODE=serviceradar_agent_gateway@agent-gateway
      - RELEASE_DISTRIBUTION=sname
      - RELEASE_COOKIE=${RELEASE_COOKIE:-serviceradar_dev_cookie}
    volumes:
      - cert-data:/etc/serviceradar/certs:ro
      - ./docker/compose/ssl_dist.gateway.conf:/etc/serviceradar/ssl_dist.conf:ro
    depends_on:
      cert-permissions-fixer:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "/app/bin/serviceradar_agent_gateway", "pid"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 60s
    networks:
      - serviceradar-net
    restart: unless-stopped

  otel:
    image: ghcr.io/carverauto/serviceradar-otel:${APP_TAG:-latest}
    container_name: serviceradar-otel-mtls
    profiles:
      - legacy
    ports:
      - "4317:4317"
    volumes:
      - ./docker/compose/otel.docker.toml:/etc/serviceradar/otel.toml:ro
      - cert-data:/etc/serviceradar/certs:ro
      - ${NATS_CREDS_DIR:-./docker/compose/creds}:/etc/serviceradar/creds:ro
      - otel-data:/var/lib/serviceradar
      - ./logs:/var/log/serviceradar
    environment:
      - CONFIG_SOURCE=kv
      - CONFIG_PATH=/etc/serviceradar/otel.toml
      - KV_ADDRESS=datasvc:50057
      - KV_SEC_MODE=mtls
      - KV_CERT_DIR=/etc/serviceradar/certs
      - KV_CERT_FILE=/etc/serviceradar/certs/otel.pem
      - KV_KEY_FILE=/etc/serviceradar/certs/otel-key.pem
      - KV_CA_FILE=/etc/serviceradar/certs/root.pem
      - KV_SERVER_NAME=datasvc.serviceradar
      - LOG_LEVEL=${LOG_LEVEL:-info}
    depends_on:
      cert-permissions-fixer:
        condition: service_completed_successfully
      nats:
        condition: service_started
    networks:
      - serviceradar-net
    restart: unless-stopped

  flowgger:
    image: ghcr.io/carverauto/serviceradar-flowgger:${APP_TAG:-latest}
    container_name: serviceradar-flowgger-mtls
    profiles:
      - legacy
    ports:
      - "514:514/udp"
      - "50044:50044"
    volumes:
      - ./docker/compose/flowgger.docker.toml:/etc/serviceradar/flowgger.toml:ro
      - cert-data:/etc/serviceradar/certs:ro
      - ${NATS_CREDS_DIR:-./docker/compose/creds}:/etc/serviceradar/creds:ro
      - flowgger-data:/var/lib/serviceradar
      - ./logs:/var/log/serviceradar
    environment:
      - CONFIG_SOURCE=kv
      - CONFIG_PATH=/etc/serviceradar/flowgger.toml
      - KV_ADDRESS=datasvc:50057
      - KV_SEC_MODE=mtls
      - KV_CERT_DIR=/etc/serviceradar/certs
      - KV_CERT_FILE=/etc/serviceradar/certs/flowgger.pem
      - KV_KEY_FILE=/etc/serviceradar/certs/flowgger-key.pem
      - KV_CA_FILE=/etc/serviceradar/certs/root.pem
      - KV_SERVER_NAME=datasvc.serviceradar
      - LOG_LEVEL=${LOG_LEVEL:-info}
    cap_add:
      - NET_BIND_SERVICE
    depends_on:
      cert-permissions-fixer:
        condition: service_completed_successfully
      nats:
        condition: service_started
    networks:
      - serviceradar-net
    restart: unless-stopped

  trapd:
    image: ghcr.io/carverauto/serviceradar-trapd:${APP_TAG:-latest}
    container_name: serviceradar-trapd-mtls
    profiles:
      - legacy
    ports:
      - "162:162/udp"
      - "50043:50043"
    volumes:
      - ./docker/compose/trapd.docker.json:/etc/serviceradar/trapd.json:ro
      - cert-data:/etc/serviceradar/certs:ro
      - ${NATS_CREDS_DIR:-./docker/compose/creds}:/etc/serviceradar/creds:ro
      - trapd-data:/var/lib/serviceradar
      - ./logs:/var/log/serviceradar
    environment:
      - CONFIG_SOURCE=kv
      - CONFIG_PATH=/etc/serviceradar/trapd.json
      - KV_ADDRESS=datasvc:50057
      - KV_SEC_MODE=mtls
      - KV_CERT_DIR=/etc/serviceradar/certs
      - KV_CERT_FILE=/etc/serviceradar/certs/trapd.pem
      - KV_KEY_FILE=/etc/serviceradar/certs/trapd-key.pem
      - KV_CA_FILE=/etc/serviceradar/certs/root.pem
      - KV_SERVER_NAME=datasvc.serviceradar
      - LOG_LEVEL=${LOG_LEVEL:-info}
    cap_add:
      - NET_BIND_SERVICE
    depends_on:
      cert-permissions-fixer:
        condition: service_completed_successfully
      nats:
        condition: service_started
    networks:
      - serviceradar-net
    restart: unless-stopped

  zen:
    image: ghcr.io/carverauto/serviceradar-zen:${APP_TAG:-latest}
    container_name: serviceradar-zen-mtls
    profiles:
      - legacy
    ports:
      - "50040:50040"
    volumes:
      - ./docker/compose/zen.docker.json:/etc/serviceradar/zen.json:ro
      - cert-data:/etc/serviceradar/certs:ro
      - ${NATS_CREDS_DIR:-./docker/compose/creds}:/etc/serviceradar/creds:ro
      - zen-data:/var/lib/serviceradar
      - ./logs:/var/log/serviceradar
    environment:
      - CONFIG_SOURCE=kv
      - CONFIG_PATH=/etc/serviceradar/zen.json
      - KV_ADDRESS=datasvc:50057
      - KV_SEC_MODE=mtls
      - KV_CERT_DIR=/etc/serviceradar/certs
      - KV_CERT_FILE=/etc/serviceradar/certs/zen.pem
      - KV_KEY_FILE=/etc/serviceradar/certs/zen-key.pem
      - KV_CA_FILE=/etc/serviceradar/certs/root.pem
      - KV_SERVER_NAME=datasvc.serviceradar
      - LOG_LEVEL=${LOG_LEVEL:-info}
    depends_on:
      cert-permissions-fixer:
        condition: service_completed_successfully
      nats:
        condition: service_started
      datasvc:
        condition: service_healthy
    networks:
      - serviceradar-net
    restart: unless-stopped

  db-event-writer:
    image: ghcr.io/carverauto/serviceradar-db-event-writer:${APP_TAG:-latest}
    container_name: serviceradar-db-event-writer-mtls
    profiles:
      - legacy
    ports:
      - "50041:50041"
    volumes:
      - ./docker/compose/db-event-writer.mtls.json:/etc/serviceradar/templates/db-event-writer.json:ro
      - cert-data:/etc/serviceradar/certs:ro
      - ${NATS_CREDS_DIR:-./docker/compose/creds}:/etc/serviceradar/creds:ro
      - db-event-writer-data:/var/lib/serviceradar
      - db-event-writer-config:/etc/serviceradar/consumers
      - ./logs:/var/log/serviceradar
    environment:
      - CONFIG_SOURCE=kv
      - CONFIG_PATH=/etc/serviceradar/templates/db-event-writer.json
      - KV_ADDRESS=datasvc:50057
      - KV_SEC_MODE=mtls
      - KV_CERT_DIR=/etc/serviceradar/certs
      - KV_CERT_FILE=/etc/serviceradar/certs/db-event-writer.pem
      - KV_KEY_FILE=/etc/serviceradar/certs/db-event-writer-key.pem
      - KV_CA_FILE=/etc/serviceradar/certs/root.pem
      - KV_SERVER_NAME=datasvc.serviceradar
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - CNPG_HOST=${CNPG_DOCKER_HOST:-cnpg}
      - CNPG_PORT=${CNPG_DOCKER_PORT:-5432}
      - CNPG_DATABASE=${CNPG_DATABASE:-serviceradar}
      - CNPG_USERNAME=${CNPG_USERNAME:-serviceradar}
      - CNPG_PASSWORD=${CNPG_PASSWORD:-serviceradar}
      - CNPG_SSL_MODE=${CNPG_SSL_MODE:-verify-full}
      - CNPG_CERT_DIR=/etc/serviceradar/certs
      - CNPG_CA_FILE=/etc/serviceradar/certs/root.pem
      - CNPG_CERT_FILE=/etc/serviceradar/certs/db-client.pem
      - CNPG_KEY_FILE=/etc/serviceradar/certs/db-client-key.pem
    depends_on:
      cert-permissions-fixer:
        condition: service_completed_successfully
      nats:
        condition: service_started
      cnpg:
        condition: service_healthy
    networks:
      - serviceradar-net
    restart: unless-stopped

  mapper:
    image: ghcr.io/carverauto/serviceradar-mapper:${APP_TAG:-latest}
    container_name: serviceradar-mapper-mtls
    profiles:
      - legacy
    ports:
      - "50056:50056"
    volumes:
      - ./docker/compose/mapper.docker.json:/etc/serviceradar/mapper.json:ro
      - cert-data:/etc/serviceradar/certs:ro
      - mapper-data:/var/lib/serviceradar
      - ./logs:/var/log/serviceradar
    environment:
      - CONFIG_SOURCE=kv
      - CONFIG_PATH=/etc/serviceradar/mapper.json
      - KV_ADDRESS=datasvc:50057
      - KV_SEC_MODE=mtls
      - KV_CERT_DIR=/etc/serviceradar/certs
      - KV_CERT_FILE=/etc/serviceradar/certs/mapper.pem
      - KV_KEY_FILE=/etc/serviceradar/certs/mapper-key.pem
      - KV_CA_FILE=/etc/serviceradar/certs/root.pem
      - KV_SERVER_NAME=datasvc.serviceradar
      - LOG_LEVEL=${LOG_LEVEL:-info}
    depends_on:
      cert-permissions-fixer:
        condition: service_completed_successfully
      otel:
        condition: service_started
    healthcheck:
      test: ["CMD", "grpcurl", "-cacert", "/etc/serviceradar/certs/root.pem", "-cert", "/etc/serviceradar/certs/mapper.pem", "-key", "/etc/serviceradar/certs/mapper-key.pem", "-servername", "mapper.serviceradar", "localhost:50056", "grpc.health.v1.Health/Check"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - serviceradar-net
    restart: unless-stopped

  web-ng:
    image: ghcr.io/carverauto/serviceradar-web-ng:${APP_TAG:-latest}
    container_name: serviceradar-web-ng-mtls
    environment:
      - PORT=4000
      - PHX_SERVER=true
      - PHX_HOST=${SERVICERADAR_HOST:-localhost}
      - PHX_CHECK_ORIGIN=${PHX_CHECK_ORIGIN:-false}
      - SERVICERADAR_DEV_ROUTES=${SERVICERADAR_DEV_ROUTES:-true}
      - SERVICERADAR_LOCAL_MAILER=${SERVICERADAR_LOCAL_MAILER:-true}
      - SERVICERADAR_WEB_NG_OBAN_ENABLED=${SERVICERADAR_WEB_NG_OBAN_ENABLED:-true}
      - CLUSTER_ENABLED=true
      - CLUSTER_STRATEGY=epmd
      - CLUSTER_HOSTS=serviceradar_agent_gateway@agent-gateway,serviceradar_core@core-elx,serviceradar_agent_gateway_t2@agent-gateway-t2
      - CLUSTER_TLS_ENABLED=true
      - SSL_DIST_OPTFILE=/etc/serviceradar/ssl_dist.conf
      - ELIXIR_ERL_OPTIONS=${ELIXIR_ERL_OPTIONS:-+fnu}
      - RELEASE_NODE=serviceradar_web_ng@web-ng
      - RELEASE_DISTRIBUTION=sname
      - RELEASE_COOKIE=${RELEASE_COOKIE:-serviceradar_dev_cookie}
      - SERVICERADAR_SECURITY_MODE=${SERVICERADAR_SECURITY_MODE:-mtls}
      - SECRET_KEY_BASE=${WEB_NG_SECRET_KEY_BASE:-H8DPohD5rFUqGboVqCKLYXrlyofYUJk6k+XBzKEb5G8LN9brhYpNloE3UgxBQmPW}
      - CLOAK_KEY_FILE=/etc/serviceradar/cloak/cloak.key
      - ADMIN_BASIC_AUTH_USERNAME=${ADMIN_BASIC_AUTH_USERNAME:-}
      - ADMIN_BASIC_AUTH_PASSWORD=${ADMIN_BASIC_AUTH_PASSWORD:-}
      - CNPG_HOST=${CNPG_DOCKER_HOST:-cnpg}
      - CNPG_PORT=${CNPG_DOCKER_PORT:-5432}
      - CNPG_DATABASE=${CNPG_DATABASE:-serviceradar}
      - CNPG_USERNAME=${CNPG_USERNAME:-serviceradar}
      - CNPG_PASSWORD=${CNPG_PASSWORD:-serviceradar}
      - CNPG_SSL_MODE=${CNPG_SSL_MODE:-verify-full}
      - CNPG_TLS_SERVER_NAME=${CNPG_TLS_SERVER_NAME:-cnpg}
      - CNPG_CERT_DIR=/etc/serviceradar/certs
      - CNPG_CERT_FILE=/etc/serviceradar/certs/db-client.pem
      - CNPG_KEY_FILE=/etc/serviceradar/certs/db-client-key.pem
      # Datasvc gRPC client configuration
      - DATASVC_ADDRESS=datasvc:50057
      - DATASVC_HOST=datasvc
      - DATASVC_PORT=50057
      - DATASVC_SSL=true
      - DATASVC_CERT_DIR=/etc/serviceradar/certs
      - DATASVC_CERT_NAME=web
      - DATASVC_SERVER_NAME=datasvc.serviceradar
    volumes:
      - cert-data:/etc/serviceradar/certs:ro
      - ./docker/compose/ssl_dist.web.conf:/etc/serviceradar/ssl_dist.conf:ro
      - cloak-key:/etc/serviceradar/cloak:ro
    depends_on:
      cert-permissions-fixer:
        condition: service_completed_successfully
      cloak-keygen:
        condition: service_completed_successfully
      cnpg:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f serviceradar_web_ng >/dev/null"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - serviceradar-net
    restart: unless-stopped

  caddy:
    image: caddy:2.8.4-alpine
    container_name: serviceradar-caddy-mtls
    user: "0:0"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - cert-data:/etc/serviceradar/certs:ro
      - ./docker/compose/Caddyfile:/etc/caddy/Caddyfile:ro
    depends_on:
      cert-permissions-fixer:
        condition: service_completed_successfully
      web-ng:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - serviceradar-net
    restart: unless-stopped

volumes:
  cert-data:
    name: "${SERVICERADAR_VOLUME_PREFIX:-serviceradar}_cert-data"
  cnpg-data:
  datasvc-data:
  nats-data:
    name: "${SERVICERADAR_VOLUME_PREFIX:-serviceradar}_nats-data"
  nats-creds:
    name: "${SERVICERADAR_VOLUME_PREFIX:-serviceradar}_nats-creds"
  cloak-key:
    name: "${SERVICERADAR_VOLUME_PREFIX:-serviceradar}_cloak-key"
  logs:
  otel-data:
  flowgger-data:
  trapd-data:
  zen-data:
  db-event-writer-data:
  db-event-writer-config:
  mapper-data:

networks:
  serviceradar-net:
    driver: bridge
