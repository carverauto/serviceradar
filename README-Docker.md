# ServiceRadar Docker Quick Start

This guide gets you started with ServiceRadar using Docker Compose in under 5 minutes.

## Prerequisites

- Docker Engine 20.10+ with Docker Compose 2.0+
- 8GB+ RAM
- 50GB+ disk space

## OS-Specific Setup

### AlmaLinux 9 / RHEL 9 / Rocky Linux 9

```bash
# Install Docker
sudo dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
sudo dnf install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

# Enable and start Docker
sudo systemctl enable --now docker

# Add your user to the docker group
sudo usermod -aG docker $USER
newgrp docker

# Install Git (if needed)
sudo dnf install -y git
```

### Ubuntu / Debian

```bash
# Install Docker
curl -fsSL https://get.docker.com | sudo sh

# Add your user to the docker group
sudo usermod -aG docker $USER
newgrp docker
```

### macOS

Install [Docker Desktop](https://www.docker.com/products/docker-desktop/) and ensure it's running.

## Quick Start

1. **Clone and navigate**:
   ```bash
   git clone https://github.com/carverauto/serviceradar.git
   cd serviceradar
   ```

2. **Create environment file**:
   ```bash
   cp .env.example .env
   ```

3. **Pull the images**:
   ```bash
   docker compose pull
   ```

4. **Start ServiceRadar**:
   ```bash
   docker compose up -d
   ```

5. **Get your admin password**:
   ```bash
   docker compose logs config-updater | grep "Password:"
   ```

6. **Access ServiceRadar**:
   - Web Interface: https://localhost (Caddy on port 443, self-signed)
   - HTTP fallback: http://localhost (Caddy on port 80)
   - API via Caddy: https://localhost/api/
   - Username: `admin`
   - Password: (from step 5)

## Update an Existing Stack

1. Choose a target image tag:
   - Latest release: `APP_TAG=v1.0.77`
   - Specific commit: `APP_TAG=sha-<git-sha>`

2. Pull + restart with the new tag:
   ```bash
   export APP_TAG=v1.0.77
   docker compose pull
   docker compose up -d --force-recreate
   ```

## Startup Sequence

The stack automatically handles certificate generation and configuration:

1. **cert-generator** - Creates all mTLS certificates (one-shot)
2. **cnpg** - PostgreSQL with mTLS + password auth
3. **cert-permissions-fixer** - Sets proper certificate ownership (one-shot)
4. **nats** - Message broker with mTLS
5. **datasvc, core, poller, agent** - Core services
6. **checkers, web-ng, etc.** - Additional services

## Test Your Setup

Run the included test script:
```bash
./test-docker-setup.sh
```

## CNPG mTLS Notes

The CNPG container enforces mTLS + password for all TCP connections. Client certs
are generated by `cert-generator` and stored in the `cert-data` volume.

Example psql connection (from host):
```bash
PGSSLMODE=verify-full \
PGSSLROOTCERT=/path/to/root.pem \
PGSSLCERT=/path/to/workstation.pem \
PGSSLKEY=/path/to/workstation-key.pem \
PGPASSWORD=serviceradar \
psql -h localhost -p 5455 -U serviceradar -d serviceradar
```

## What's Next?

- **Configure devices**: See [Device Configuration Guide](docs/docs/device-configuration.md)
- **Full documentation**: See [Docker Setup Guide](docs/docs/docker-setup.md)
- **Security**: See [TLS Security Guide](docs/docs/tls-security.md) - Change your admin password after first login

## Build Images Locally (Bazel)

ServiceRadar container images are built with Bazel. Load the agent image into your local Docker daemon before starting Compose:

```bash
bazel run //docker/images:agent_image_amd64_tar
```

To publish the agent image (and the rest of the stack) to GHCR using the same Bazel targets:

```bash
# Push just the agent image
bazel run //docker/images:agent_image_amd64_push

# Or push every image in one go
bazel run //docker/images:push_all
```

## Common Commands

```bash
# View all service status
docker compose ps

# View logs for all services
docker compose logs

# View logs for specific service
docker compose logs core

# Follow logs in real-time
docker compose logs -f

# Stop all services
docker compose down

# Restart a service
docker compose restart core

# Update to a specific version
export APP_TAG=v1.0.77
docker compose pull
docker compose up -d --force-recreate
```

## Troubleshooting

If services fail to start:

1. **Check logs**: `docker compose logs [service-name]`
2. **Verify resources**: Ensure Docker has enough memory/CPU
3. **Check ports**: Ensure ports 80, 8090, 514, 162 are available
4. **Reset**: `docker compose down && docker volume prune && docker compose up -d`

### AlmaLinux 9 / RHEL 9 Specific Issues

**SELinux blocking containers**:
```bash
# Allow containers to manage cgroups
sudo setsebool -P container_manage_cgroup on

# Or temporarily disable SELinux (not recommended for production)
sudo setenforce 0
```

**Firewall blocking ports**:
```bash
sudo firewall-cmd --add-port=80/tcp --permanent    # Web UI (Caddy)
sudo firewall-cmd --add-port=443/tcp --permanent   # Web UI HTTPS (optional)
sudo firewall-cmd --add-port=8090/tcp --permanent  # Core API (direct)
sudo firewall-cmd --reload
```

**Certificate permission issues**:
```bash
# Check cert-permissions-fixer ran successfully
docker compose logs cert-permissions-fixer
```

## Security Notice

On first startup, ServiceRadar generates:
- Random admin password
- API keys and JWT secrets
- mTLS certificates for all services

**Save your admin password** and delete the auto-generated password file:
```bash
docker compose exec core rm /etc/serviceradar/certs/password.txt
```

## Support

- [Complete Documentation](docs/docs/)
- [Report Issues](https://github.com/carverauto/serviceradar/issues)
- [Community Support](https://github.com/carverauto/serviceradar/discussions)
