## 1. CNPG + Timescale schema
- [x] 1.1 Inventory the current Proton schema (`pkg/db/migrations/*.sql`, registry queries) and produce a mapping doc that calls out table-by-table how it becomes a Postgres table or Timescale hypertable (including TTL/retention windows). *(See `openspec/changes/migrate-proton-timeseries-to-cnpg/schema-mapping.md`.)*
- [x] 1.2 Author the new CNPG migrations: create hypertables for metrics/sysmon/netflow/discovery, relational tables for unified devices/registry/edge onboarding/users, seed indexes, and register Timescale retention/compression policies that match the TTL plan. *(Initial `00000000000001_timescale_schema.up.sql` covers the telemetry, registry, onboarding, and capability tables; `00000000000002_events_rperf_users.up.sql` and `00000000000003_device_metrics_summary_cagg.up.sql` add CloudEvents/rperf/users plus the device metrics continuous aggregate.)*
- [x] 1.3 Wire the migrations into Bazel/`make` (similar to existing Proton migrations) and ensure they can be applied against a clean CNPG cluster plus the already-provisioned demo cluster. *(New `cmd/tools/cnpg-migrate` binary + `make cnpg-migrate` target run the embedded migrations via Go or Bazel.)*
- [x] 1.4 Confirm the CNPG image still exposes TimescaleDB + Apache AGE extensions and document the SQL required to `CREATE EXTENSION` + verify them in the telemetry database. *(`docs/docs/agents.md` now covers the telemetry `psql` commands that create and verify both extensions.)*

## 2. Go data layer rewrite
- [x] 2.1 Introduce a shared pgx-based CNPG client (connection pooling, TLS) inside `pkg/db` and update service configuration structs to carry the new DSNs/flags needed for Proton+CNPG dual writes. *(`pkg/models` gained CNPG + routing config, and `pkg/db` now spins up the pgx pool with dual-write helpers.)*
- [x] 2.2 Port write paths (`StoreMetrics`, `StoreSysmonMetrics`, `StoreSweepHostStates`, `PublishDeviceUpdate`, edge onboarding, auth/users, etc.) to Postgres SQL; add unit tests for the new query builders. *(`pkg/db/auth.go` moved to pgx, CloudEvents land in CNPG via `pkg/db/events.go`, metrics/sysmon/sweep via `pkg/db/cnpg_metrics.go` + `pkg/db/cnpg_sweep.go`, device updates through `pkg/db/cnpg_unified_devices.go`, edge onboarding via `pkg/db/cnpg_edge_onboarding.go`, and the poller/service registry writers now dual-write through `pkg/db/cnpg_registry.go` with coverage in the new unit tests.)*
- [x] 2.3 Port read paths for metrics, discovery, devices, and registry lookups to Postgres, replacing Proton-specific constructs like `table(...)`, `_tp_time`, and `FINAL` with Timescale/SQL equivalents. *Poller/service registry APIs now branch on `StorageRouting` and hit the CNPG tables (`pollers`, `poller_history`, `service_status`, `services`) via pgx, and the device APIs reuse the CNPG-backed unified device helpers. This batch adds CNPG-backed readers for every metrics and sweep/discovery call siteâ€”`pkg/db/metrics.go`, `pkg/db/snmp_status.go`, and `pkg/db/sweep.go` now fan out to the pgx helpers in `pkg/db/cnpg_metrics_reads.go`/`pkg/db/cnpg_sweep.go`, with coverage in `pkg/db/cnpg_metrics_reads_test.go` and `pkg/db/cnpg_sweep_read_test.go`. Proton-only reads are no longer required once `StorageRouting.PrimaryBackend` flips to CNPG.*
- [x] 2.4 Update `pkg/registry` to operate on the new relational tables (explicit merging logic for unified devices, registry tables, service counts) and cover the behavior with updated tests or fixtures. *DeviceRegistry's identifier lookups (Armis IDs, NetBox IDs, MACs, and canonical IPs) now issue parameterized CNPG queries via the new helpers in `pkg/registry/registry.go` with coverage in `pkg/registry/registry_cnpg_test.go`, and the ServiceRegistry poller/agent/checker readers/writers now target the CNPG tables with dual-write support plus new coverage in `pkg/registry/service_registry_queries_test.go`, so both registry paths run on Timescale.*

## 3. Proton driver removal
- [ ] 3.1 Delete the Proton client/connection from `pkg/db` (no `Conn`, `NewStreamingConn`, or dual-write routing) so CNPG migrations and pgx pools are the only database initialization path.
- [ ] 3.2 Rewrite the remaining Proton-backed code in `pkg/db` (`metrics.go`, `sweep.go`, `discovery.go`, `devices.go`, `services.go`, `pollers.go`, `netflow.go`, `edge_onboarding.go`, `capabilities.go`) so every read/write uses the CNPG helpers and no Proton SQL (`table(...)`, `_tp_time`, `FINAL`) remains.
- [ ] 3.3 Remove Proton mocks/tests/build rules (`executeBatch`, Proton migration embeds, mock generators tied to `driver.Batch`) and update the db unit tests to run solely against the pgx-backed CNPG code.

## 4. Service + tooling cleanup
- [ ] 4.1 Convert `cmd/consumers/db-event-writer` to read/write CNPG tables for OTEL logs/metrics/traces, removing Proton config flags, schema assumptions, and driver dependencies.
- [ ] 4.2 Replace Proton streaming utilities (core log digest tailer, stats aggregator parity checks, CLI helpers) with CNPG implementations or retire the features if they were Proton-only.
- [ ] 4.3 Update CLI/config/installer tooling so Proton settings (`DBAddr`, Proton TLS certs, migration scripts) are removed, CNPG DSNs are required, and generated configs/scripts reference the Timescale schema exclusively.

## 5. Documentation + operations
- [ ] 5.1 Purge Proton references from docs and runbooks (`docs/docs/agents.md`, runbook directory, demo README) and add CNPG-only operational procedures (migrations, resets, health checks).
- [ ] 5.2 Remove Proton deployments/manifests/Helm values from `k8s/` and replace them with CNPG-only overlays (including any reset scripts or PVC instructions).
- [ ] 5.3 Update scripts/automation (e.g., `reset-proton.sh`, backfill helpers, CI pipelines) to either target CNPG or be deleted if obsolete, ensuring `make`/Bazel targets no longer expect Proton artifacts.

## 6. Validation + observability
- [ ] 6.1 Add CNPG-focused smoke/integration tests that cover `/api/devices`, `/api/metrics`, `/api/registry`, and the db-event-writer ingestion path so we can prove the Proton-free stack works end-to-end.
- [ ] 6.2 Refresh monitoring/dashboards to track CNPG ingestion/retention health (Timescale hypertables, retention jobs, pgx error metrics) and remove Proton parity dashboards/checks.
